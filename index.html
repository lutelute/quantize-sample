<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡å­åŒ–ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]})"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e14;--surface:#12171f;--surface2:#1a2030;--surface3:#222a38;
  --border:#2a3040;--border2:#3a4560;
  --text:#e8ecf2;--text2:#b8c0d0;--text-muted:#7888a0;--text-dim:#556070;
  --accent:#4da6ff;--accent2:#2b7de9;--green:#44cc66;--red:#ff5555;
  --orange:#ffaa33;--purple:#b388ff;--cyan:#44ddcc;--pink:#ff66aa;
  --note-bg:#0e1828;--note-border:#1a3060;
  --radius:12px;--radius-sm:8px;
  --shadow:0 4px 24px rgba(0,0,0,.4);
  --transition:all .25s cubic-bezier(.4,0,.2,1);
}
html{font-size:15px;scroll-behavior:smooth}
body{font-family:'Helvetica Neue',Arial,'Hiragino Sans','Hiragino Kaku Gothic ProN',sans-serif;
  background:var(--bg);color:var(--text2);line-height:1.75;min-height:100vh}
h1,h2,h3,h4{color:var(--text);font-weight:700;line-height:1.35}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit;
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:.5rem 1rem;outline:none;transition:var(--transition)}
button{cursor:pointer;font-weight:600}
button:hover{border-color:var(--accent);background:var(--surface3);transform:translateY(-1px)}
button:active{transform:translateY(0)}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,166,255,.2)}
input[type=range]{-webkit-appearance:none;background:linear-gradient(90deg,var(--accent2),var(--accent));
  height:6px;border-radius:3px;border:none;padding:0;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(77,166,255,.5);transition:var(--transition)}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 0 14px rgba(77,166,255,.7)}
canvas{display:block;max-width:100%;border-radius:var(--radius-sm)}
table{border-collapse:collapse;width:100%}
th,td{padding:.65rem .85rem;border:1px solid var(--border);text-align:left;vertical-align:top}
th{background:var(--surface2);font-weight:700;position:sticky;top:0;z-index:2}
code,.mono{font-family:'SF Mono',Consolas,'Courier New',monospace;font-size:.88em}
code{background:var(--surface3);padding:.1em .4em;border-radius:4px;color:var(--cyan)}

/* Tooltip */
.tip{position:relative;border-bottom:1px dashed var(--accent);cursor:help;color:var(--accent)}
.tip:hover::after{content:attr(data-tip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);
  background:var(--surface3);border:1px solid var(--border2);color:var(--text);padding:.5rem .8rem;
  border-radius:var(--radius-sm);font-size:.8rem;white-space:nowrap;z-index:100;
  box-shadow:var(--shadow);pointer-events:none;max-width:320px;white-space:normal;line-height:1.5}

/* Notes */
.note{background:var(--note-bg);border:1px solid var(--note-border);border-left:4px solid var(--accent);
  border-radius:var(--radius-sm);padding:1.1rem 1.3rem;margin:.8rem 0;color:#90a8c8;font-size:.9rem;line-height:1.85}
.note summary{cursor:pointer;font-weight:700;color:var(--accent);font-size:.95rem;list-style:none;
  display:flex;align-items:center;gap:.5rem;user-select:none}
.note summary::before{content:'ğŸ“˜';font-size:1rem}
.note summary::after{content:'â–¾';font-size:1.1rem;margin-left:auto;transition:transform .2s;color:var(--text-muted)}
.note[open] summary::after{transform:rotate(180deg)}
.note p{margin:.6rem 0 0}
.note .fm{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:.7rem 1.2rem;margin:.7rem 0;font-family:'SF Mono',Consolas,monospace;font-size:.92rem;
  color:var(--cyan);text-align:center;letter-spacing:.03em;overflow-x:auto}
.note .eg{background:#0a1a12;border:1px solid #1a3a2a;border-radius:var(--radius-sm);
  padding:.6rem 1rem;margin:.6rem 0;color:#80c8a0;font-size:.85rem;line-height:1.7}
.note .eg::before{content:'ğŸ’¡ ';font-size:.9rem}
.note .warn{background:#1a1508;border:1px solid #3a3010;border-radius:var(--radius-sm);
  padding:.6rem 1rem;margin:.6rem 0;color:#c8a848;font-size:.85rem}
.note .warn::before{content:'âš  '}
.note ul{margin:.5rem 0 0 1.2rem;color:#90a8c8}
.note li{margin:.25rem 0}
.note strong{color:var(--text)}
.note .kw{color:var(--orange);font-weight:700}

/* Layout */
.header{background:linear-gradient(135deg,#0a1020 0%,#121830 50%,#0a1628 100%);
  border-bottom:1px solid var(--border);padding:1.8rem 2.5rem 1rem;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:-40%;right:-10%;width:400px;height:400px;
  background:radial-gradient(circle,rgba(77,166,255,.06) 0%,transparent 70%);pointer-events:none}
.header h1{font-size:1.7rem;margin-bottom:.15rem;background:linear-gradient(90deg,var(--text),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-block}
.header .sub{color:var(--text-muted);font-size:.92rem;margin-bottom:1rem}
.tnav{display:flex;gap:0;border-bottom:none}
.tnav button{background:transparent;border:none;border-bottom:3px solid transparent;border-radius:0;
  padding:.65rem 1.6rem;color:var(--text-muted);font-size:.95rem;white-space:nowrap;letter-spacing:.02em}
.tnav button.on{color:var(--accent);border-bottom-color:var(--accent)}
.tnav button:hover{color:var(--text);background:transparent;transform:none}
.tab{display:none;padding:2rem 2.5rem;max-width:1440px;margin:0 auto;animation:fadeIn .3s ease}
.tab.on{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.sec{margin-bottom:2.8rem}
.sec>h2{font-size:1.15rem;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.5rem;color:var(--text)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.5rem;transition:var(--transition)}
.pnl:hover{box-shadow:0 6px 28px rgba(0,0,0,.35)}
.pnl h3{margin-bottom:.7rem;font-size:1.05rem}
.fw{grid-column:1/-1}
.stabs{display:flex;gap:.4rem;margin-bottom:1.2rem}
.stabs button{font-size:.88rem;padding:.4rem 1.1rem;border-radius:20px;background:var(--surface2);border:1px solid var(--border)}
.stabs button.on{background:var(--accent2);color:#fff;border-color:var(--accent2)}
.ctrl-row{display:flex;gap:1rem;flex-wrap:wrap;align-items:end;margin-bottom:1.2rem}
.ctrl-row label{font-size:.82rem;color:var(--text-muted);display:block;margin-bottom:.2rem;font-weight:600}
.ctrl-row .val{color:var(--accent);font-weight:700;font-size:.95rem;margin-left:.3rem}
.btn-go{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border:none;
  padding:.5rem 1.5rem;border-radius:var(--radius-sm);font-weight:700;box-shadow:0 2px 12px rgba(77,166,255,.3)}
.btn-go:hover{box-shadow:0 4px 20px rgba(77,166,255,.5);transform:translateY(-2px)}

/* Bit */
.bit-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.8rem}
.bit-row .bl{min-width:55px;font-weight:800;font-size:.95rem;color:var(--text)}
.bits{display:flex;gap:2px}
.bx{width:18px;height:28px;border-radius:3px;transition:var(--transition)}
.bx:hover{transform:scaleY(1.2);filter:brightness(1.3)}
.bx.s{background:var(--red)}.bx.e{background:var(--accent)}.bx.m{background:var(--green)}
.bit-meta{font-size:.78rem;color:var(--text-muted);margin-left:.5rem}
.bit-leg{display:flex;gap:1.2rem;margin-top:1rem;font-size:.82rem;color:var(--text-muted)}
.bit-leg span{display:flex;align-items:center;gap:.3rem}
.bit-leg .sw{width:14px;height:14px;border-radius:3px}

/* Cards */
.cg{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
.mc{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.3rem;text-align:center;transition:var(--transition);position:relative;overflow:hidden}
.mc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.mc.t0::before{background:var(--text-muted)}.mc.t1::before{background:var(--green)}
.mc.t2::before{background:var(--orange)}.mc.t3::before{background:var(--purple)}
.mc:hover{transform:translateY(-4px);box-shadow:0 10px 32px rgba(0,0,0,.5)}
.mc .mt{font-size:.85rem;color:var(--text-muted);font-weight:600;margin-bottom:.3rem}
.mc .mv{font-size:2rem;font-weight:800;margin-bottom:.4rem}
.mc.t0 .mv{color:var(--text-muted)}.mc.t1 .mv{color:var(--green)}
.mc.t2 .mv{color:var(--orange)}.mc.t3 .mv{color:var(--purple)}
.mc .bar{height:6px;border-radius:3px;background:var(--surface);margin:.5rem 0;overflow:hidden}
.mc .bar div{height:100%;border-radius:3px;transition:width .6s ease}
.mc .md{font-size:.78rem;color:var(--text-muted);line-height:1.6;text-align:left}

/* Steps */
.slist{list-style:none;counter-reset:st}
.slist li{counter-increment:st;padding:.75rem 1.1rem;margin-bottom:.5rem;background:var(--surface2);
  border-radius:var(--radius-sm);border-left:3px solid var(--accent);
  font-family:'SF Mono',Consolas,monospace;font-size:.85rem;line-height:1.65;transition:var(--transition)}
.slist li:hover{background:var(--surface3);border-left-width:5px}
.slist li::before{content:'Step ' counter(st);color:var(--accent);font-weight:800;margin-right:.6rem;font-size:.8rem}
.slist li .d{color:var(--text-muted);font-family:'Helvetica Neue',Arial,sans-serif;font-size:.82rem;display:block;margin-top:.25rem;padding-left:1rem;border-left:2px solid var(--border)}
.slist .ok{border-left-color:var(--green);background:#0a1a10}
.slist .ok:hover{background:#0e2418}
.slist .ng{border-left-color:var(--orange);background:#1a1508}

/* Compare */
.ctbl{overflow-x:auto;font-size:.85rem;border-radius:var(--radius);border:1px solid var(--border)}
.ctbl table{margin:0}
.ctbl .cc{max-height:90px;overflow:hidden;transition:max-height .3s;cursor:pointer;position:relative}
.ctbl .cc.exp{max-height:2000px}
.ctbl .cc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:28px;
  background:linear-gradient(transparent,var(--surface2));pointer-events:none}
.ctbl .cc.exp::after{display:none}
.ctbl .tb{color:var(--accent);font-size:.75rem;cursor:pointer;display:inline-block;margin-top:.3rem;font-weight:600}
.sr{display:inline-flex;gap:1px;cursor:pointer;margin-top:.3rem}
.sr .st{color:var(--border2);font-size:1rem;transition:color .15s;padding:0 1px}
.sr .st.f{color:var(--orange)}
.sr .st:hover{color:var(--orange)}

/* Method Cards */
.mcd{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.3rem;margin-bottom:1rem;transition:var(--transition)}
.mcd:hover{box-shadow:0 6px 24px rgba(0,0,0,.35);border-color:var(--border2)}
.mcd h4{color:var(--accent);margin-bottom:.5rem;font-size:1.05rem}
.mcd .md{font-size:.9rem;margin-bottom:.8rem;color:var(--text2);line-height:1.75}
.mcd .ms{display:flex;gap:2rem;flex-wrap:wrap;margin-bottom:.8rem;padding:.7rem 1.1rem;
  background:var(--surface);border-radius:var(--radius-sm);font-size:.84rem}
.mcd .ms strong{color:var(--text)}
.tg{display:inline-block;padding:.2rem .6rem;border-radius:12px;font-size:.73rem;margin:.15rem .2rem;font-weight:600}
.tg.pro{background:#0a2018;color:var(--green);border:1px solid #1a4030}
.tg.con{background:#200a10;color:var(--red);border:1px solid #401a20}
.tg.fw{background:#10102a;color:var(--purple);border:1px solid #2a2a50}

/* User input */
.uis textarea{width:100%;min-height:55px;resize:vertical;margin-bottom:.5rem}
.btn-p{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border:none;font-weight:700;
  box-shadow:0 2px 10px rgba(77,166,255,.25)}
.btn-p:hover{box-shadow:0 4px 18px rgba(77,166,255,.45)}
.btn-d{background:transparent;color:var(--red);border:1px solid var(--red);font-size:.82rem;padding:.35rem .7rem}
.btn-d:hover{background:#200a10}

/* Heatmap hover */
.hm-wrap{position:relative;display:inline-block}
.hm-tip{position:absolute;pointer-events:none;background:var(--surface3);border:1px solid var(--border2);
  color:var(--text);padding:.3rem .6rem;border-radius:6px;font-size:.78rem;white-space:nowrap;
  box-shadow:var(--shadow);opacity:0;transition:opacity .15s;z-index:10}
.hm-wrap:hover .hm-tip{opacity:1}

/* Summary bar */
.sbar{display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:2rem;padding:1.2rem 1.5rem;
  background:linear-gradient(135deg,var(--surface) 0%,var(--surface2) 100%);
  border:1px solid var(--border);border-radius:var(--radius)}
.sbar .si{flex:1;min-width:180px}
.sbar .si .sl{font-size:.78rem;color:var(--text-muted);font-weight:600;margin-bottom:.2rem}
.sbar .si .sv{font-size:1.4rem;font-weight:800;color:var(--accent)}
.sbar .si .sd{font-size:.78rem;color:var(--text-dim)}

/* Pipeline animation */
.pipe-wrap{display:flex;align-items:center;gap:0;flex-wrap:wrap;justify-content:center;margin:1rem 0}
.pipe-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:.8rem 1.2rem;text-align:center;min-width:100px;transition:var(--transition)}
.pipe-box .pipe-label{font-size:.72rem;color:var(--text-muted);font-weight:600;margin-bottom:.2rem}
.pipe-box .pipe-val{font-size:1.1rem;font-weight:800;font-family:'SF Mono',Consolas,monospace}
.pipe-arrow{font-size:1.2rem;color:var(--accent);padding:0 .3rem;flex-shrink:0}
.pipe-box.active{border-color:var(--accent);box-shadow:0 0 12px rgba(77,166,255,.25)}
.err-bar{height:18px;border-radius:4px;margin-top:.5rem;overflow:hidden;background:var(--surface2);position:relative}
.err-bar-inner{height:100%;border-radius:4px;transition:width .3s,background .3s}
.err-bar-label{position:absolute;right:6px;top:1px;font-size:.7rem;color:var(--text);font-weight:700}

/* Outlier pulse */
.outlier-dot{transition:all .3s}
@keyframes outlierPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.5)}}
.outlier-pulse{animation:outlierPulse .8s ease infinite}

/* Guide card */
.guide-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem}
.guide-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:1rem;text-align:center;transition:var(--transition)}
.guide-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.guide-card .gc-bits{font-size:1.6rem;font-weight:800;margin-bottom:.3rem}
.guide-card .gc-label{font-size:.82rem;font-weight:700;margin-bottom:.3rem}
.guide-card .gc-desc{font-size:.75rem;color:var(--text-muted);line-height:1.6}

/* Stats row */
.stats-row{display:flex;gap:1.5rem;flex-wrap:wrap;margin-top:.8rem;font-size:.85rem}
.stats-row .stat{background:var(--surface2);padding:.5rem 1rem;border-radius:var(--radius-sm);border:1px solid var(--border)}
.stats-row .stat strong{color:var(--accent)}

/* NN diagram lane */
.nn-lanes{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem;margin-top:1rem}
.nn-lane{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.8rem;text-align:center}
.nn-lane .lane-label{font-size:.82rem;font-weight:700;margin-bottom:.4rem}
.nn-lane .lane-val{font-size:1.3rem;font-weight:800;font-family:'SF Mono',Consolas,monospace}

/* Image Quantization Grid */
.iq-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}
.iq-cell{position:relative;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.iq-cell canvas{display:block;width:100%;height:auto}
.iq-label{position:absolute;top:0;left:0;right:0;padding:.35rem .6rem;
  background:linear-gradient(180deg,rgba(0,0,0,.7) 0%,transparent 100%);
  font-size:.75rem;font-weight:700;color:#fff;display:flex;justify-content:space-between;pointer-events:none}
.iq-label .iq-levels{font-weight:400;opacity:.85}
.iq-patterns{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.8rem}
.iq-patterns button{padding:.45rem 1rem;border-radius:var(--radius-sm);border:1px solid var(--border);
  background:var(--surface2);color:var(--text);font-size:.82rem;cursor:pointer;transition:var(--transition)}
.iq-patterns button.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.iq-patterns button:hover:not(.on){border-color:var(--accent)}

/* Mosaic Recognition Demo */
.mo-wrap{display:flex;flex-direction:column;gap:1.2rem}
.mo-subject-row{display:flex;gap:.5rem;flex-wrap:wrap}
.mo-subject-row button{padding:.45rem 1rem;border-radius:var(--radius-sm);border:1px solid var(--border);
  background:var(--surface2);color:var(--text);font-size:.82rem;cursor:pointer;transition:var(--transition)}
.mo-subject-row button.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.mo-subject-row button:hover:not(.on){border-color:var(--accent)}
.mo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem}
.mo-cell{position:relative;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;transition:border-color .3s}
.mo-cell.mo-lost{border-color:var(--orange)}
.mo-cell canvas{display:block;width:100%;height:auto}
.mo-info{padding:.4rem .6rem;font-size:.72rem;text-align:center;background:var(--surface);border-top:1px solid var(--border)}
.mo-info .mo-block{font-weight:700;color:var(--accent)}
.mo-info .mo-verdict{display:block;margin-top:.15rem;font-weight:700}
.mo-verdict.ok{color:var(--green,#4ade80)}
.mo-verdict.ng{color:var(--orange)}
.mo-slider-row{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.mo-slider-row label{font-size:.85rem;font-weight:600;white-space:nowrap}
.mo-slider-row input[type=range]{flex:1;min-width:120px}
.mo-slider-row .val{font-weight:800;min-width:3.5em;font-family:'SF Mono',Consolas,monospace}

/* Text Quantization Demo */
.tq-grid{display:flex;flex-direction:column;gap:.8rem;margin-top:1rem}
.tq-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;transition:border-color .3s}
.tq-card.tq-lost{border-color:var(--orange)}
.tq-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.tq-head .tq-title{font-size:.82rem;font-weight:700;color:var(--accent)}
.tq-head .tq-meta{font-size:.72rem;color:var(--text-muted)}
.tq-text{font-size:.95rem;line-height:1.8;padding:.6rem .8rem;background:var(--surface);border-radius:var(--radius-sm);
  font-family:'Noto Sans JP','Hiragino Kaku Gothic ProN',sans-serif;white-space:pre-wrap;word-break:break-all}
.tq-verdict{margin-top:.4rem;font-size:.75rem;font-weight:700;text-align:right}
.tq-verdict.ok{color:var(--green,#4ade80)}
.tq-verdict.ng{color:var(--orange)}
.tq-sample-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.8rem}
.tq-sample-row button{padding:.45rem 1rem;border-radius:var(--radius-sm);border:1px solid var(--border);
  background:var(--surface2);color:var(--text);font-size:.82rem;cursor:pointer;transition:var(--transition)}
.tq-sample-row button.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.tq-sample-row button:hover:not(.on){border-color:var(--accent)}
/* KaTeX overrides for dark theme */
.katex{color:var(--text)}
.fm .katex{font-size:.95em}

/* Responsive */
@media(max-width:1000px){.g2{grid-template-columns:1fr}.cg{grid-template-columns:1fr 1fr}
  .guide-cards{grid-template-columns:1fr 1fr}.nn-lanes{grid-template-columns:1fr 1fr}
  .mo-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.iq-grid{grid-template-columns:repeat(2,1fr)}.mo-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.tnav{overflow-x:auto;gap:0}.tab{padding:1rem}.cg{grid-template-columns:1fr}
  .header{padding:1.2rem 1rem .8rem}.sbar{flex-direction:column;gap:.8rem}
  .guide-cards{grid-template-columns:1fr}.nn-lanes{grid-template-columns:1fr}
  .pipe-wrap{flex-direction:column}.pipe-arrow{transform:rotate(90deg)}}
@media(max-width:480px){.iq-grid{grid-template-columns:1fr}.mo-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header class="header">
  <h1>é‡å­åŒ–ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</h1>
  <div class="sub">AIãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ– (FP32 â†’ FP16 â†’ INT8 â†’ INT4) ã‚’ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«å­¦ã¶</div>
  <nav class="tnav" id="tnav">
    <button data-t="why">ãªãœé‡å­åŒ–ï¼Ÿ</button>
    <button class="on" data-t="overview">æ¦‚è¦ã¨å¯è¦–åŒ–</button>
    <button data-t="playground">è¨ˆç®—ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰</button>
    <button data-t="compare">å“è³ªæ¯”è¼ƒ</button>
    <button data-t="deep">æ·±æ˜ã‚Šåˆ†æ</button>
  </nav>
</header>

<!-- ==================== TAB 0: ãªãœé‡å­åŒ–ï¼Ÿ ==================== -->
<div class="tab" id="t-why">

<!-- Section A: é‡å­åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½“é¨“ -->
<div class="sec">
  <h2>ğŸ”„ é‡å­åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½“é¨“</h2>
  <div class="pnl">
    <h3>å®Ÿæ•° â†’ æ•´æ•° â†’ è¿‘ä¼¼å€¤ï¼š3ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä½“æ„Ÿã™ã‚‹</h3>
    <div class="ctrl-row">
      <div><label>å…¥åŠ›å€¤</label><input type="range" id="whyVal" min="-2" max="2" value="0.73" step="0.01"><span class="val" id="whyValV">0.73</span></div>
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label>
        <select id="whyBits">
          <option value="2">2bit</option><option value="4">4bit</option>
          <option value="8" selected>8bit</option><option value="16">16bit</option>
        </select>
      </div>
    </div>
    <canvas id="pipeDiagram" height="120"></canvas>
    <div class="pipe-wrap" id="whyPipe"></div>
    <div style="margin-top:.5rem">
      <div style="font-size:.82rem;color:var(--text-muted);margin-bottom:.2rem">é‡å­åŒ–èª¤å·®: <span id="whyErrVal" style="color:var(--orange);font-weight:700">â€”</span></div>
      <div class="err-bar"><div class="err-bar-inner" id="whyErrBar"></div><span class="err-bar-label" id="whyErrLabel"></span></div>
    </div>
    <details class="note">
      <summary>è§£èª¬: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å„ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ•°å¼ä»˜ãï¼‰</summary>
      <p>å¯¾ç§°é‡å­åŒ–ã®3ã‚¹ãƒ†ãƒƒãƒ—ã¯ä»¥ä¸‹ã®æ•°å¼ã§è¨˜è¿°ã•ã‚Œã¾ã™ã€‚ãƒ“ãƒƒãƒˆå¹… $b$ ã«å¯¾ã—ã€è¡¨ç¾å¯èƒ½ãªæœ€å¤§æ•´æ•° $q_{\max} = 2^{b-1} - 1$ ã¨ã—ã¾ã™ã€‚</p>
      <p><strong>Step 1 â€” Scaleè¨ˆç®—ã¨é‡å­åŒ– (round)</strong>:</p>
      <div class="fm">$$s = \frac{\alpha}{q_{\max}}, \quad q = \mathrm{round}\!\left(\frac{x}{s}\right)$$</div>
      <p>ã“ã“ã§ $\alpha = \max|x_i|$ï¼ˆãƒ†ãƒ³ã‚½ãƒ«å†…ã®æœ€å¤§çµ¶å¯¾å€¤ï¼‰ã€$x$ ã¯å®Ÿæ•°å€¤ã®é‡ã¿ã§ã™ã€‚</p>
      <p><strong>Step 2 â€” ã‚¯ãƒ©ãƒ³ãƒ— (clamp)</strong>:</p>
      <div class="fm">$$q_c = \mathrm{clamp}(q,\; -q_{\max},\; q_{\max})$$</div>
      <p>ä¸¸ã‚çµæœãŒè¡¨ç¾ç¯„å›²ã‚’è¶…ãˆãŸå ´åˆã«åˆ‡ã‚Šè©°ã‚ã¾ã™ã€‚é£½å’Œ (saturation) ã¨ã‚‚å‘¼ã³ã¾ã™ã€‚</p>
      <p><strong>Step 3 â€” é€†é‡å­åŒ– (dequantize)</strong>:</p>
      <div class="fm">$$\hat{x} = q_c \cdot s$$</div>
      <p>ã“ã® $\hat{x}$ ãŒå…ƒã®å€¤ $x$ ã®è¿‘ä¼¼å€¤ã§ã™ã€‚é‡å­åŒ–èª¤å·®ã¯ $\epsilon = |x - \hat{x}|$ ã§å®šç¾©ã•ã‚Œã€æœ€å¤§èª¤å·®ã¯ $\frac{s}{2}$ ã«åˆ¶é™ã•ã‚Œã¾ã™ã€‚</p>
      <div class="eg">ãƒ“ãƒƒãƒˆå¹…ã‚’16â†’4â†’2ã¨ä¸‹ã’ã¦ã¿ã¦ãã ã•ã„ã€‚2bitã§ã¯ $q_{\max}=1$ã€å–ã‚Šã†ã‚‹å€¤ãŒ $\{-1, 0, 1\}$ ã®3ã¤ã ã‘ã«ãªã‚Šã€èª¤å·®ãŒåŠ‡çš„ã«å¢—ãˆã¾ã™ã€‚</div>
    </details>
  </div>
</div>

<!-- Section: Image Quantization -->
<div class="sec">
  <h2>ğŸ–¼ï¸ ç”»åƒã§è¦‹ã‚‹bitã®è’ã•</h2>
  <div class="pnl">
    <h3>ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸ã‚“ã§æ¯”è¼ƒ</h3>
    <div class="iq-patterns" id="iqPatterns">
      <button class="on" data-p="gradient">2Dã‚«ãƒ©ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</button>
      <button data-p="radial">æ”¾å°„çŠ¶ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</button>
      <button data-p="wave">æ³¢ç´‹ï¼ˆsinæ³¢åˆæˆï¼‰</button>
    </div>
    <div class="iq-grid" id="iqGrid"></div>
    <details class="note" style="margin-top:.8rem">
      <summary>è§£èª¬: ãªãœãƒãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒèµ·ã“ã‚‹ã‹ï¼ˆå‡ä¸€é‡å­åŒ–ç†è«–ï¼‰</summary>
      <p>$b$ bit/ãƒãƒ£ãƒ³ãƒãƒ«ã®å ´åˆã€è¡¨ç¾å¯èƒ½ãªæ®µéšæ•°ã¯ $L = 2^b$ ã§ã™ã€‚é€£ç¶šå€¤ $v \in [0, 255]$ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é›¢æ•£åŒ–ã•ã‚Œã¾ã™:</p>
      <div class="fm">$$\Delta = \frac{256}{L}, \quad \hat{v} = \left\lfloor \frac{v}{\Delta} \right\rfloor \cdot \Delta + \frac{\Delta}{2}$$</div>
      <p>ã‚¹ãƒ†ãƒƒãƒ—å¹… $\Delta$ ãŒå¤§ãããªã‚‹ã»ã©ã€éš£æ¥ã™ã‚‹é‡å­åŒ–å€¤ã®å·®ãŒå¢—ãˆã€ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ç›®ã«è¦‹ãˆã‚‹<strong>æ®µå·®ï¼ˆãƒãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰</strong>ãŒç™ºç”Ÿã—ã¾ã™ã€‚</p>
      <ul>
        <li><strong>8bit/ch</strong>: $L=256$, $\Delta=1$ â€” äººé–“ã®çŸ¥è¦šé–¾å€¤ï¼ˆç´„1/256ï¼‰ä»¥ä¸‹ã§æ»‘ã‚‰ã‹</li>
        <li><strong>4bit/ch</strong>: $L=16$, $\Delta=16$ â€” Weber-Fechnerã®æ³•å‰‡ã«ã‚ˆã‚Šæš—éƒ¨ã§ãƒãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒçŸ¥è¦šã•ã‚Œã‚‹</li>
        <li><strong>2bit/ch</strong>: $L=4$, $\Delta=64$ â€” æ˜ç¢ºãªãƒãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€‚è‰²ã®ç·æ•°ã¯ $4^3 = 64$ è‰²</li>
        <li><strong>1bit/ch</strong>: $L=2$, $\Delta=128$ â€” å„ãƒãƒ£ãƒ³ãƒãƒ«ON/OFFã®ã¿ã€‚å…¨ $2^3 = 8$ è‰²</li>
      </ul>
      <p>å‡ä¸€é‡å­åŒ–ã®<strong>ç†è«–çš„ãªå¹³å‡äºŒä¹—èª¤å·® (MSE)</strong> ã¯:</p>
      <div class="fm">$$\mathrm{MSE} = \frac{\Delta^2}{12} = \frac{256^2}{12 \cdot 2^{2b}}$$</div>
      <p>ãƒ“ãƒƒãƒˆå¹…ãŒ1bitæ¸›ã‚‹ãŸã³ã«MSEã¯ç´„4å€ï¼ˆ6.02 dBï¼‰æ‚ªåŒ–ã—ã¾ã™ã€‚</p>
      <div class="eg">ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€é‡å­åŒ–ã®å½±éŸ¿ãŒç”»åƒã®å‘¨æ³¢æ•°ç‰¹æ€§ã«ã‚ˆã£ã¦ã©ã†ç•°ãªã‚‹ã‹ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚é«˜å‘¨æ³¢æˆåˆ†ï¼ˆæ³¢ç´‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã§ã¯é‡å­åŒ–ãƒã‚¤ã‚ºãŒåŸä¿¡å·ã«ç´›ã‚Œã‚„ã™ã„ä¸€æ–¹ã€ä½å‘¨æ³¢ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã§ã¯ãƒãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒé¡•è‘—ã§ã™ã€‚</div>
    </details>
  </div>
</div>

<!-- Section: Mosaic Recognition Demo -->
<div class="sec">
  <h2>ğŸ§© ãƒ¢ã‚¶ã‚¤ã‚¯ã§åˆ†ã‹ã‚‹ã€Œæƒ…å ±ã®é™ç•Œã€</h2>
  <div class="pnl">
    <h3>ã©ã“ã¾ã§ç²—ãã—ã¦ã‚‚ä½•ã‹åˆ†ã‹ã‚‹ï¼Ÿ</h3>
    <p style="font-size:.85rem;color:var(--text-muted);margin-bottom:.8rem">
      èªè­˜å¯èƒ½ãªçµµã‚’ãƒ¢ã‚¶ã‚¤ã‚¯åŒ–ï¼ˆç©ºé–“è§£åƒåº¦ã®é‡å­åŒ–ï¼‰ã—ã¦ã€åˆ¤åˆ¥ä¸èƒ½ã«ãªã‚‹å¢ƒç•Œã‚’ä½“é¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
    </p>
    <div class="mo-subject-row" id="moSubjects">
      <button class="on" data-s="cat">ğŸ± ãƒã‚³</button>
      <button data-s="fish">ğŸŸ ã‚µã‚«ãƒŠ</button>
      <button data-s="house">ğŸ  å®¶</button>
      <button data-s="tree">ğŸŒ³ æœ¨</button>
    </div>
    <div class="mo-grid" id="moGrid"></div>
    <details class="note" style="margin-top:.8rem">
      <summary>è§£èª¬: ç©ºé–“é‡å­åŒ–ã¨å€¤é‡å­åŒ–</summary>
      <p>ä¸Šã®ã€ŒğŸ–¼ï¸ç”»åƒã§è¦‹ã‚‹bitã®è’ã•ã€ã¯<strong>å€¤ã®é‡å­åŒ–</strong>ï¼ˆè‰²ã®æ®µéšã‚’æ¸›ã‚‰ã™ï¼‰ã§ã—ãŸã€‚ã“ã“ã§ã¯<strong>ç©ºé–“ã®é‡å­åŒ–</strong>ï¼ˆãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’æ¸›ã‚‰ã™ï¼‰ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚</p>
      <p>AIãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã‚‚æœ¬è³ªã¯åŒã˜ã§ã™ã€‚é‡ã¿ã®ç²¾åº¦ã‚’è½ã¨ã™ã¨ã€<strong>ç´°ã‹ã„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹</strong>ã‹ã‚‰å¤±ã‚ã‚Œã€ã‚„ãŒã¦<strong>æœ¬è³ªçš„ãªç‰¹å¾´</strong>ã¾ã§å£Šã‚Œã¾ã™ã€‚ã€Œã©ã®bitå¹…ã¾ã§ä¸‹ã’ã¦ã‚‚å¤§ä¸ˆå¤«ã‹ã€ã¯ã€ã“ã®ã€Œåˆ¤åˆ¥å¯èƒ½/ä¸èƒ½ã€ã®å¢ƒç•Œç·šã‚’è¦‹æ¥µã‚ã‚‹ä½œæ¥­ã¨ä¼¼ã¦ã„ã¾ã™ã€‚</p>
      <div class="eg">ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º4Ã—4ç¨‹åº¦ãªã‚‰å¤§ä½“ä½•ã‹åˆ†ã‹ã‚Šã¾ã™ãŒã€16Ã—16ã‚’è¶…ãˆã‚‹ã¨åˆ¤åˆ¥å›°é›£ã«ãªã‚Šã¾ã™ã€‚INT4é‡å­åŒ–ãŒã€Œã‚®ãƒªã‚®ãƒªä½¿ãˆã‚‹ã€ã®ã¨åŒã˜æ„Ÿè¦šã§ã™ã€‚</div>
    </details>
  </div>
</div>

<!-- Section: Text Quantization Demo -->
<div class="sec">
  <h2>ğŸ“ æ–‡ç« ã§è¦‹ã‚‹é‡å­åŒ– â€” è¨€è‘‰ã®ã€Œç²¾åº¦ã€ã‚’è½ã¨ã™</h2>
  <div class="pnl">
    <h3>æ–‡ç« ã‚’æ®µéšçš„ã«åŠ£åŒ–ã•ã›ã‚‹ã¨ï¼Ÿ</h3>
    <p style="font-size:.85rem;color:var(--text-muted);margin-bottom:.8rem">
      ç”»åƒã®ãƒ¢ã‚¶ã‚¤ã‚¯ã¨åŒã˜åŸç†ã‚’ã€æ–‡ç« ã«é©ç”¨ã—ã¾ã™ã€‚æ¼¢å­—â†’ã²ã‚‰ãŒãªâ†’æ–‡å­—ã®é–“å¼•ãâ†’è¨˜å·åŒ–ã¨ç²¾åº¦ã‚’è½ã¨ã—ã¦ã„ãã¨ã€<strong>ã©ã®æ®µéšã§æ„å‘³ãŒå¤±ã‚ã‚Œã‚‹ã‹</strong>ã‚’ä½“é¨“ã§ãã¾ã™ã€‚
    </p>
    <div class="tq-sample-row" id="tqSamples">
      <button class="on" data-t="tech">æŠ€è¡“æ–‡</button>
      <button data-t="story">ç‰©èª</button>
      <button data-t="code">ã‚³ãƒ¼ãƒ‰çš„</button>
    </div>
    <div class="tq-grid" id="tqGrid"></div>
    <details class="note" style="margin-top:.8rem">
      <summary>è§£èª¬: æ–‡ç« ã®é‡å­åŒ–ã¨AIãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã®å¯¾å¿œ</summary>
      <p>ã“ã®æ¯”å–©ã¯AIãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å¯¾å¿œã—ã¦ã„ã¾ã™:</p>
      <table style="font-size:.82rem;margin:.6rem 0">
        <thead><tr><th>æ–‡ç« ã®åŠ£åŒ–ãƒ¬ãƒ™ãƒ«</th><th>å¯¾å¿œã™ã‚‹AIé‡å­åŒ–</th><th>æƒ…å ±ã®å¤‰åŒ–</th></tr></thead>
        <tbody>
          <tr><td>åŸæ–‡ï¼ˆå…¨æ¼¢å­—ï¼‰</td><td>FP32</td><td>å®Œå…¨ãªæƒ…å ±ã‚’ä¿æŒ</td></tr>
          <tr><td>ã²ã‚‰ãŒãªåŒ–</td><td>FP16</td><td>è¡¨è¨˜ãŒå¤‰ã‚ã‚‹ãŒæ„å‘³ã¯ã»ã¼ä¿æŒ</td></tr>
          <tr><td>2æ–‡å­—ã”ã¨ã«1æ–‡å­—</td><td>INT8</td><td>æƒ…å ±é‡ãŒåŠæ¸›ã™ã‚‹ãŒæ¨æ¸¬å¯èƒ½</td></tr>
          <tr><td>4æ–‡å­—ã”ã¨ã«1æ–‡å­—</td><td>INT4</td><td>æ–­ç‰‡çš„ã€æ–‡è„ˆã‹ã‚‰è¾›ã†ã˜ã¦æ¨æ¸¬</td></tr>
          <tr><td>æ¯éŸ³ã®ã¿</td><td>INT2</td><td>ã»ã¼åˆ¤èª­ä¸èƒ½</td></tr>
          <tr><td>æ–‡å­—æ•°ã®ã¿</td><td>1bit</td><td>å…ƒã®æƒ…å ±ã¯å®Œå…¨ã«æ¶ˆå¤±</td></tr>
        </tbody>
      </table>
      <p>AIé‡å­åŒ–ã§ã‚‚åŒæ§˜ã«ã€<strong>FP16ã¾ã§ã¯å“è³ªã‚’ã»ã¼ç¶­æŒ</strong>ã—ã€<strong>INT4ãŒã‚®ãƒªã‚®ãƒªã®å®Ÿç”¨ãƒ©ã‚¤ãƒ³</strong>ã€<strong>INT2ä»¥ä¸‹ã§ã¯å‡ºåŠ›ãŒå´©å£Š</strong>ã—ã¾ã™ã€‚</p>
      <p>é‡è¦ãªã®ã¯ã€<strong>æ§‹é€ ãŒæ˜ç¢ºãªæƒ…å ±ï¼ˆã‚³ãƒ¼ãƒ‰ã€å®šå‹æ–‡ï¼‰ã¯é‡å­åŒ–ã«å¼·ã</strong>ã€<strong>ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã®å¾®å¦™ãªæƒ…å ±ï¼ˆæ–‡å­¦ã€æ„Ÿæƒ…è¡¨ç¾ï¼‰ã¯é‡å­åŒ–ã«å¼±ã„</strong>ã¨ã„ã†ç‚¹ã§ã™ã€‚ã“ã‚Œã¯AIãƒ¢ãƒ‡ãƒ«ã§ã‚‚åŒã˜å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚</p>
    </details>
  </div>
</div>

<!-- Section B: æ®µéšçš„åŠ£åŒ–ãƒ‡ãƒ¢ -->
<div class="sec">
  <h2>ğŸ“‰ æ®µéšçš„åŠ£åŒ–ãƒ‡ãƒ¢ â€” ãªãœç²¾åº¦ãŒä¸‹ãŒã‚‹ã‹</h2>
  <div class="pnl">
    <h3>å…ƒä¿¡å· vs é‡å­åŒ–ä¿¡å·</h3>
    <div class="ctrl-row">
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label><input type="range" id="degBits" min="1" max="16" value="8" step="1"><span class="val" id="degBitsV">8</span></div>
      <div><label>ä¿¡å·ã®è¤‡é›‘ã•</label><input type="range" id="degComp" min="1" max="5" value="2" step="1"><span class="val" id="degCompV">2</span></div>
    </div>
    <canvas id="degCanvas" height="280"></canvas>
    <div class="stats-row" id="degStats"></div>
    <details class="note">
      <summary>è§£èª¬: éšæ®µæ³¢ã¨ä¿¡å·å¯¾é‡å­åŒ–é›‘éŸ³æ¯” (SQNR)</summary>
      <p>ãƒ“ãƒƒãƒˆå¹… $b$ ã®é‡å­åŒ–ãƒ¬ãƒ™ãƒ«æ•°ã¯ $L = 2^b$ ã§ã™ã€‚ä¿¡å·ã®æŒ¯å¹…ç¯„å›² $[-A, A]$ ã«å¯¾ã—ã€é‡å­åŒ–ã‚¹ãƒ†ãƒƒãƒ—å¹…ã¯:</p>
      <div class="fm">$$\Delta = \frac{2A}{2^b}$$</div>
      <p>é‡å­åŒ–èª¤å·® $e = x - \hat{x}$ ã¯ $[-\Delta/2, +\Delta/2]$ ã®ä¸€æ§˜åˆ†å¸ƒã«è¿‘ä¼¼ã§ãã€ãã®åˆ†æ•£ã¯:</p>
      <div class="fm">$$\sigma_e^2 = \frac{\Delta^2}{12}$$</div>
      <p><strong>ä¿¡å·å¯¾é‡å­åŒ–é›‘éŸ³æ¯” (SQNR)</strong> ã¯ã€ä¿¡å·ã®åˆ†æ•£ $\sigma_x^2$ ã«å¯¾ã—ã¦:</p>
      <div class="fm">$$\mathrm{SQNR} = 10 \log_{10}\!\left(\frac{\sigma_x^2}{\sigma_e^2}\right) \approx 6.02\,b + C \;\text{[dB]}$$</div>
      <p>ã¤ã¾ã‚Š<strong>1bitã”ã¨ã«ç´„6 dBã®SQNRãŒå¾—ã‚‰ã‚Œ</strong>ã€1bitæ¸›ã‚‹ã”ã¨ã«é›‘éŸ³ãŒç´„4å€ã«ãªã‚Šã¾ã™ã€‚</p>
      <ul>
        <li><strong>16bit</strong>: $L = 65{,}536$, SQNR â‰ˆ 98 dB â†’ å…ƒä¿¡å·ã¨ã»ã¼åŒºåˆ¥ä¸èƒ½</li>
        <li><strong>8bit</strong>: $L = 256$, SQNR â‰ˆ 50 dB â†’ ã‚ãšã‹ãªéšæ®µãŒè¦‹ãˆã‚‹</li>
        <li><strong>4bit</strong>: $L = 16$, SQNR â‰ˆ 26 dB â†’ æ˜ã‚‰ã‹ãªéšæ®µçŠ¶</li>
        <li><strong>1bit</strong>: $L = 2$, SQNR â‰ˆ 8 dB â†’ +1ã‹-1ã®ã¿</li>
      </ul>
      <p>ä¿¡å·ã®è¤‡é›‘ã•ï¼ˆé«˜èª¿æ³¢æ•° $k$ï¼‰ã‚’å¢—ã‚„ã™ã¨ã€é«˜å‘¨æ³¢æˆåˆ†ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¢—åŠ ã—ã€é‡å­åŒ–ãƒã‚¤ã‚ºã¨ã®ç›¸äº’ä½œç”¨ãŒã‚ˆã‚Šè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚</p>
    </details>
  </div>
</div>

<!-- Section C: ãªãœé‡å­åŒ–ãŒæˆç«‹ã™ã‚‹ã®ã‹ -->
<div class="sec">
  <h2>ğŸ¯ ãªãœé‡å­åŒ–ãŒæˆç«‹ã™ã‚‹ã®ã‹ â€” å†—é•·æ€§ã®å¯è¦–åŒ–</h2>
  <div class="g2">
    <div class="pnl">
      <h3>é‡ã¿åˆ†å¸ƒã®é›†ä¸­åº¦</h3>
      <div style="position:relative;height:280px"><canvas id="whyDistCv"></canvas></div>
      <details class="note">
        <summary>è§£èª¬: é‡ã¿ã®åˆ†å¸ƒã¨é‡å­åŒ–èª¤å·®ã®é–¢ä¿‚</summary>
        <p>Transformerã®é‡ã¿ã¯åˆæœŸåŒ–ã«<strong>Xavier/HeåˆæœŸåŒ–</strong>ã‚’ç”¨ã„ã€å­¦ç¿’å¾Œã‚‚ã»ã¼æ­£è¦åˆ†å¸ƒã‚’ä¿ã¡ã¾ã™:</p>
        <div class="fm">$$w \sim \mathcal{N}\!\left(0,\; \frac{2}{n_{\mathrm{in}} + n_{\mathrm{out}}}\right)$$</div>
        <p>å…¸å‹çš„ãªLLMï¼ˆ7Bã‚¯ãƒ©ã‚¹ï¼‰ã§ã¯ã€<strong>95%ä»¥ä¸Šã®é‡ã¿ãŒ $\pm 3\sigma$ ä»¥å†…</strong>ï¼ˆ$\sigma \approx 0.01$ã€œ$0.02$ï¼‰ã«åã¾ã‚Šã¾ã™ã€‚</p>
        <p>é‡å­åŒ–ã®<strong>å¹³å‡äºŒä¹—èª¤å·® (MSE)</strong> ã¯ã€åˆ†å¸ƒã®ç¢ºç‡å¯†åº¦é–¢æ•° $f(x)$ ã¨é‡å­åŒ–é–¢æ•° $Q(x)$ ã‚’ç”¨ã„ã¦:</p>
        <div class="fm">$$\mathrm{MSE} = \mathbb{E}\!\left[(x - Q(x))^2\right] = \int_{-\infty}^{\infty} (x - Q(x))^2 f(x) \, dx$$</div>
        <p>é‡ã¿ãŒ0ä»˜è¿‘ã«é›†ä¸­ã—ã¦ã„ã‚‹ãŸã‚ã€$|x|$ ãŒå°ã•ã„é ˜åŸŸã®é‡å­åŒ–ç²¾åº¦ãŒå…¨ä½“ã®MSEã‚’æ”¯é…ã—ã¾ã™ã€‚å¯¾ç§°é‡å­åŒ–ã®ã‚°ãƒªãƒƒãƒ‰é–“éš” $s = \alpha / q_{\max}$ ã«ãŠã„ã¦ã€$\alpha$ ãŒå°ã•ã„ã»ã©ç²¾åº¦ãŒé«˜ããªã‚‹ãŸã‚ã€<strong>åˆ†å¸ƒãŒç‹­ã„ã“ã¨ã¯é‡å­åŒ–ã«ã¨ã£ã¦ç†æƒ³çš„</strong>ã§ã™ã€‚</p>
      </details>
    </div>
    <div class="pnl">
      <h3>ç²¾åº¦ vs å‡ºåŠ›ãƒ­ãƒã‚¹ãƒˆæ€§</h3>
      <p style="font-size:.85rem;color:var(--text-muted);margin-bottom:.6rem">ç°¡æ˜“3å±¤NN (2å…¥åŠ›â†’4éš ã‚Œâ†’1å‡ºåŠ›) ã‚’å„ãƒ“ãƒƒãƒˆå¹…ã§è¨ˆç®—ã—ã€å‡ºåŠ›ã‚’æ¯”è¼ƒ</p>
      <canvas id="robustNNCv" height="200"></canvas>
      <div id="robustResults" style="margin-top:.8rem"></div>
      <button class="btn-go" onclick="doWhyRobust()" style="margin-top:.8rem">æ–°ã—ã„é‡ã¿ã§å†è¨ˆç®—</button>
      <details class="note">
        <summary>è§£èª¬: ãªãœå¾®å°èª¤å·®ãŒå•é¡Œã«ãªã‚‰ãªã„ã‹ â€” æ•°ç†çš„æ ¹æ‹ </summary>
        <p>é‡å­åŒ–å¾Œã®é‡ã¿ã‚’ $\hat{W} = W + E$ ã¨ã™ã‚‹ã¨ï¼ˆ$E$ ã¯èª¤å·®è¡Œåˆ—ï¼‰ã€ã‚ã‚‹å±¤ã®å‡ºåŠ›ã¯:</p>
        <div class="fm">$$\hat{y} = \hat{W}x = Wx + Ex$$</div>
        <p>èª¤å·®é … $Ex$ ã®å½±éŸ¿ãŒå°ã•ã„ç†ç”±ã¯ä»¥ä¸‹ã®4ã¤ã§ã™:</p>
        <ul>
          <li><strong>é‡ã¿ãŒ0ä»˜è¿‘ã«é›†ä¸­</strong>: $\|E\|_F \ll \|W\|_F$ ã¨ãªã‚Šã€ç›¸å¯¾èª¤å·® $\|E\|_F / \|W\|_F$ ãŒå°ã•ã„</li>
          <li><strong>è¡Œåˆ—ç©ã§èª¤å·®ãŒç›¸æ®ºï¼ˆå¤§æ•°ã®æ³•å‰‡ï¼‰</strong>: $E$ ã®å„è¦ç´ ã¯å¹³å‡0ã«è¿‘ã„ç‹¬ç«‹ãªèª¤å·®ã€‚éš ã‚Œå±¤ã®æ¬¡å…ƒ $d$ ãŒå¤§ãã„ã¨ãã€$Ex$ ã®å„æˆåˆ†ã¯ $\sim \mathcal{O}(1/\sqrt{d})$ ã«ç¸®å°:
          $$\mathbb{E}[(Ex)_i^2] = \sum_j \mathbb{E}[E_{ij}^2] \cdot x_j^2 = \sigma_e^2 \|x\|^2$$</li>
          <li><strong>ReLUãŒå¾®å°å·®ã‚’å¸å</strong>: $\mathrm{ReLU}(z) = \max(0, z)$ ã¯è² ã®å€¤ã‚’å…¨ã¦0ã«ã™ã‚‹ãŸã‚ã€èª¤å·®ãŒå‡ºåŠ›ã®ç¬¦å·ã‚’å¤‰ãˆãªã„é™ã‚Šå½±éŸ¿ãªã—</li>
          <li><strong>æå¤±å¹³é¢ã®å¹³å¦æ€§</strong>: å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯æå¤±é–¢æ•° $\mathcal{L}(W)$ ã®å¹³å¦ãªæ¥µå°å€¤ã«ã„ã‚‹ãŸã‚ã€ãƒ˜ãƒƒã‚»è¡Œåˆ— $H$ ã®å›ºæœ‰å€¤ãŒå°ã•ãã€$\mathcal{L}(W+E) \approx \mathcal{L}(W) + \frac{1}{2} E^T H E$ ã®ç¬¬äºŒé …ãŒå¾®å°</li>
        </ul>
      </details>
    </div>
  </div>
</div>

</div>

<!-- ==================== TAB 1 ==================== -->
<div class="tab on" id="t-overview">

<div class="sbar">
  <div class="si"><div class="sl">ã“ã®ãƒ„ãƒ¼ãƒ«ã§å­¦ã¹ã‚‹ã“ã¨</div><div class="sv">é‡å­åŒ–ã®å…¨ä½“åƒ</div><div class="sd">ãƒ“ãƒƒãƒˆè¡¨ç¾ â†’ åˆ†å¸ƒã®å¤‰åŒ– â†’ èª¤å·®ã®å¯è¦–åŒ– â†’ ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</div></div>
  <div class="si"><div class="sl">å¯¾è±¡èª­è€…</div><div class="sv">LLMåˆ©ç”¨è€…ã€œMLåˆå­¦è€…</div><div class="sd">æ•°å¼ã¯å±•é–‹å¯èƒ½ã€‚ç›´æ„Ÿçš„ãªå›³è§£ã‚’å„ªå…ˆ</div></div>
  <div class="si"><div class="sl">æ“ä½œæ–¹æ³•</div><div class="sv">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ & ã‚¯ãƒªãƒƒã‚¯</div><div class="sd">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‹•ã‹ã™ã¨å…¨ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°</div></div>
</div>

<details class="note" open>
  <summary>ãã‚‚ãã‚‚ã€Œé‡å­åŒ–ã€ã¨ã¯ï¼Ÿ â€” 30ç§’ã§ç†è§£ã™ã‚‹</summary>
  <p>AIãƒ¢ãƒ‡ãƒ«ï¼ˆChatGPTãªã©ã®<span class="kw">LLM</span>ï¼‰ã¯å†…éƒ¨ã«<strong>æ•°åå„„ã€œæ•°åƒå„„ã®æ•°å€¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé‡ã¿ï¼‰</strong>ã‚’æŒã¡ã¾ã™ã€‚é€šå¸¸ <strong>FP32</strong>ï¼ˆ32ãƒ“ãƒƒãƒˆæµ®å‹•å°æ•°ç‚¹æ•°ï¼‰ã§ä¿å­˜ã•ã‚Œã¾ã™ãŒã€7Bãƒ¢ãƒ‡ãƒ«ãªã‚‰<strong>28GB</strong>ã®ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã§ã™ã€‚</p>
  <div class="eg">å®¶ã®å¼•ã£è¶Šã—ã§è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚FP32ã¯å…¨è·ç‰©ã‚’ã€Œè¶…å¤§å‹ãƒˆãƒ©ãƒƒã‚¯ã€ã§é‹ã¶ã‚ˆã†ãªã‚‚ã®ã€‚é‡å­åŒ–ã¯ã€Œè·ç‰©ã‚’åœ§ç¸®ã—ã¦å°å‹ãƒˆãƒ©ãƒƒã‚¯ã«ç©ã¿æ›¿ãˆã‚‹ã€æŠ€è¡“ã§ã™ã€‚å¤šå°‘ã‚·ãƒ¯ãŒã¤ãï¼ˆç²¾åº¦ä½ä¸‹ï¼‰ã‘ã‚Œã©ã€é‹æ¬ã‚³ã‚¹ãƒˆï¼ˆãƒ¡ãƒ¢ãƒªãƒ»è¨ˆç®—æ™‚é–“ï¼‰ãŒåŠ‡çš„ã«ä¸‹ãŒã‚Šã¾ã™ã€‚</div>
  <div class="fm">$$\text{VRAM} = \frac{N \times b}{8} \quad \Rightarrow \quad \text{FP32: } 28\text{GB} \;\to\; \text{FP16: } 14\text{GB} \;\to\; \text{INT8: } 7\text{GB} \;\to\; \text{INT4: } 3.5\text{GB}$$</div>
  <p>ã¤ã¾ã‚Š<strong>é‡å­åŒ– = æ•°å€¤ã®ç²¾åº¦ã‚’è½ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’è»½é‡åŒ–ã™ã‚‹æŠ€è¡“</strong>ã€‚ç²¾åº¦ã¨åŠ¹ç‡ã®æœ€é©ãªãƒãƒ©ãƒ³ã‚¹ã‚’æ¢ã‚‹ã®ãŒã“ã®åˆ†é‡ã®èª²é¡Œã§ã™ã€‚</p>
  <p>æ•°å­¦çš„ã«ã¯ã€é‡å­åŒ–ã¯å†™åƒ $Q: \mathbb{R} \to \mathcal{C}$ ã§ã‚ã‚Šã€æœ‰é™ã®<strong>ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯</strong> $\mathcal{C} = \{c_1, c_2, \ldots, c_L\}$ ï¼ˆ$L = 2^b$ ãƒ¬ãƒ™ãƒ«ï¼‰ã¸ã®æœ€è¿‘å‚å‰²å½“ã§ã™ã€‚æœ€é©ãª $\mathcal{C}$ ã¯æ­ªã¿é–¢æ•° $D = \mathbb{E}[(x - Q(x))^2]$ ã‚’æœ€å°åŒ–ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¾ã™ï¼ˆLloyd-Maxã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã€‚</p>
</details>

<!-- BIT -->
<div class="sec">
  <h2>ğŸ”¢ ãƒ“ãƒƒãƒˆæ§‹é€ ã®æ¯”è¼ƒ</h2>
  <div class="g2">
    <div class="pnl">
      <h3>å„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®å†…éƒ¨æ§‹é€ </h3>
      <div id="bitViz"></div>
      <div class="bit-leg">
        <span><span class="sw" style="background:var(--red)"></span> <span class="tip" data-tip="å€¤ãŒæ­£ã‹è² ã‹ã‚’è¡¨ã™1ãƒ“ãƒƒãƒˆ">ç¬¦å·</span></span>
        <span><span class="sw" style="background:var(--accent)"></span> <span class="tip" data-tip="å€¤ã®æ¡æ•°ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ï¼‰ã‚’è¡¨ã™ã€‚å¤šã„ã»ã©åºƒã„ç¯„å›²ã‚’è¡¨ç¾å¯èƒ½">æŒ‡æ•°</span></span>
        <span><span class="sw" style="background:var(--green)"></span> <span class="tip" data-tip="å€¤ã®ç´°ã‹ã•ï¼ˆç²¾åº¦ï¼‰ã‚’è¡¨ã™ã€‚å¤šã„ã»ã©éš£ã®å€¤ã¨ã®é–“éš”ãŒå°ã•ã„">ä»®æ•°/å€¤</span></span>
      </div>
    </div>
    <div class="pnl">
      <h3>æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«</h3>
      <table style="font-size:.85rem">
        <thead><tr><th>å½¢å¼</th><th>ãƒ“ãƒƒãƒˆ</th><th>å–ã‚Šã†ã‚‹å€¤ã®æ•°</th><th>ãƒ¡ãƒ¢ãƒª(7B)</th><th>ç²¾åº¦</th></tr></thead>
        <tbody>
          <tr><td><strong>FP32</strong></td><td>32</td><td>~42å„„</td><td>28.0 GB</td><td style="color:var(--green)">åŸºæº–</td></tr>
          <tr><td><strong style="color:var(--green)">FP16</strong></td><td>16</td><td>~65,536</td><td>14.0 GB</td><td style="color:var(--green)">â‰ˆ åŒç­‰</td></tr>
          <tr><td><strong style="color:var(--orange)">INT8</strong></td><td>8</td><td>256</td><td>7.0 GB</td><td style="color:var(--orange)">å¾®æ¸›</td></tr>
          <tr><td><strong style="color:var(--purple)">INT4</strong></td><td>4</td><td>16</td><td>3.5 GB</td><td style="color:var(--red)">é¡•è‘—ã«æ¸›</td></tr>
        </tbody>
      </table>
      <details class="note" style="margin-top:.8rem">
        <summary>è§£èª¬: FP vs INT ã®æ ¹æœ¬çš„ãªé•ã„</summary>
        <p><strong>æµ®å‹•å°æ•°ç‚¹ (FP)</strong> ã¯ã€ŒæŒ‡æ•°éƒ¨ã€ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å‹•çš„ã«èª¿æ•´ã—ã€éå¸¸ã«åºƒã„ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ã‚’æŒã¡ã¾ã™:</p>
        <div class="fm">$$x = (-1)^{s} \times 2^{(E - \mathrm{bias})} \times (1 + M)$$</div>
        <p>ã“ã“ã§ $s$ ã¯ç¬¦å·ãƒ“ãƒƒãƒˆã€$E$ ã¯æŒ‡æ•°éƒ¨ã®æ•´æ•°å€¤ã€$M$ ã¯ä»®æ•°éƒ¨ï¼ˆ$0 \le M < 1$ï¼‰ã€‚FP32ã§ã¯æŒ‡æ•°8bitã€ä»®æ•°23bitã§ã€ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ã¯ç´„ $10^{-38}$ ã€œ $10^{38}$ ã§ã™ã€‚</p>
        <p>FP16 (half precision) ã§ã¯æŒ‡æ•°5bitãƒ»ä»®æ•°10bitã«ç¸®å°ã•ã‚Œã¾ã™ãŒã€<strong>BFloat16</strong> (BF16) ã¯æŒ‡æ•°8bitã‚’ç¶­æŒã—ã¦ä»®æ•°ã‚’7bitã«å‰Šã‚Šã€FP32ã¨åŒã˜ãƒ¬ãƒ³ã‚¸ã‚’ä¿ã¡ã¾ã™:</p>
        <div class="fm">$$\text{FP16: } 6.1 \times 10^{-5} \sim 6.6 \times 10^4, \quad \text{BF16: } 1.2 \times 10^{-38} \sim 3.4 \times 10^{38}$$</div>
        <p><strong>æ•´æ•°å‹ (INT)</strong> ã¯æŒ‡æ•°éƒ¨ãŒãªãã€å›ºå®šã®<span class="tip" data-tip="1é‡å­åŒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚ãŸã‚Šã®å®Ÿæ•°å¹…ã€‚å…¨ã¦ã®é‡å­åŒ–å€¤ã®é–“éš”ã¯ã“ã®scaleã®æ•´æ•°å€">scale $s$</span> ã§å€¤ã‚’è¡¨ç¾ã—ã¾ã™:</p>
        <div class="fm">$$\hat{x} = s \cdot q, \quad q \in \{-2^{b-1},\ldots, 2^{b-1}-1\}$$</div>
        <p>å€¤ã¯ç­‰é–“éš” $s$ ã§é£›ã³é£›ã³ã«ãªã‚Šã€æœ€å¤§ $s/2$ ã®é‡å­åŒ–èª¤å·®ãŒç”Ÿã˜ã¾ã™ã€‚</p>
        <div class="eg">FP32ã¯ã€Œ0.001mmåˆ»ã¿ã®ç²¾å¯†ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒã‚®ã‚¹ã€ã€‚INT4 ã¯ã€Œ1cmåˆ»ã¿ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ã€ã€‚7.3mmã®ç‰©ã‚’æ¸¬ã‚‹ã¨ã€ãƒã‚®ã‚¹ã¯7.3mmã¨è¨€ãˆã‚‹ãŒã€ãƒ¡ã‚¸ãƒ£ãƒ¼ã§ã¯ã€Œ1cmã€ã¨ã—ã‹è¨€ãˆãªã„ã€‚ã“ã®å·®ãŒé‡å­åŒ–èª¤å·®ã§ã™ã€‚</div>
      </details>
    </div>
  </div>
</div>

<!-- HISTOGRAM -->
<div class="sec">
  <h2>ğŸ“Š é‡ã¿åˆ†å¸ƒã¨é‡å­åŒ–ã®å½±éŸ¿</h2>
  <div class="pnl">
    <h3>æ­£è¦åˆ†å¸ƒã®é‡ã¿ã‚’å„ç²¾åº¦ã§é‡å­åŒ–</h3>
    <div style="position:relative;height:320px"><canvas id="histCv"></canvas></div>
    <div class="ctrl-row" style="margin-top:1rem">
      <div><label>é‡ã¿ã®å€‹æ•°</label><input type="range" id="hN" min="200" max="5000" value="1000" step="200"><span class="val" id="hNv">1000</span></div>
      <div><label>æ¨™æº–åå·® Ïƒ</label><input type="range" id="hS" min="0.1" max="3" value="1" step="0.1"><span class="val" id="hSv">1.0</span></div>
    </div>
    <details class="note">
      <summary>è§£èª¬: åˆ†å¸ƒã®å¤‰å½¢ã¨æƒ…å ±ç†è«–çš„è§£é‡ˆ</summary>
      <p>AIãƒ¢ãƒ‡ãƒ«ã®é‡ã¿ã¯<strong>æ­£è¦åˆ†å¸ƒ</strong> $w \sim \mathcal{N}(0, \sigma^2)$ ã«è¿‘ã„å½¢ã‚’å–ã‚Šã¾ã™ã€‚é‡å­åŒ–ã¯ç¢ºç‡å¯†åº¦é–¢æ•°ã‚’é›¢æ•£åˆ†å¸ƒã«å¤‰æ›ã™ã‚‹æ“ä½œã§ã™ã€‚</p>
      <ul>
        <li><strong>FP32 (ç°)</strong>: é€£ç¶šåˆ†å¸ƒãã®ã‚‚ã®ã€‚æƒ…å ±ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ $h(w) = \frac{1}{2}\ln(2\pi e \sigma^2)$</li>
        <li><strong style="color:var(--green)">FP16 (ç·‘)</strong>: FP32ã¨ã»ã¼é‡ãªã‚‹ã€‚ä»®æ•°10bitã®ç²¾åº¦ã¯é‡ã¿ã®ç²¾åº¦ã‚’ä¸Šå›ã‚‹</li>
        <li><strong style="color:var(--orange)">INT8 (é»„)</strong>: 256æ®µéšã¸ã®é›¢æ•£åŒ–ã€‚é›¢æ•£ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ $H \le 8$ bits ã§ã€æ­£è¦åˆ†å¸ƒãªã‚‰ $H \approx 7.5$ bits</li>
        <li><strong style="color:var(--purple)">INT4 (ç´«)</strong>: 16æ®µéšã®ã¿ã€‚$H \le 4$ bitsã€‚ç¢ºç‡å¯†åº¦ã®ãƒ”ãƒ¼ã‚¯ä»˜è¿‘ã®å€¤ã«ã‚¹ãƒ‘ã‚¤ã‚¯ãŒé›†ä¸­</li>
      </ul>
      <p><strong>é‡å­åŒ–ã«ã‚ˆã‚‹æƒ…å ±æå¤±</strong>ã¯KLãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã§æ¸¬å®šã§ãã¾ã™:</p>
      <div class="fm">$$D_{\mathrm{KL}}(p \| \hat{p}) = \sum_i p(x_i) \ln \frac{p(x_i)}{\hat{p}(x_i)} \ge 0$$</div>
      <p>ãƒ“ãƒƒãƒˆå¹…ãŒæ¸›ã‚‹ã»ã© $D_{\mathrm{KL}}$ ã¯å¤§ãããªã‚Šã€å…ƒã®åˆ†å¸ƒã¨ã®ä¹–é›¢ãŒå¢—å¤§ã—ã¾ã™ã€‚TensorRTãªã©ã®é‡å­åŒ–ãƒ„ãƒ¼ãƒ«ã¯ã€$D_{\mathrm{KL}}$ ã‚’æœ€å°åŒ–ã™ã‚‹ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°é–¾å€¤ $\alpha$ ã‚’æ¢ç´¢ã—ã¾ã™ (ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼æ ¡æ­£)ã€‚</p>
      <div class="eg">$\sigma$ ã‚’å¤§ããã™ã‚‹ã¨åˆ†å¸ƒãŒåºƒãŒã‚Šã€INT4ã®ã‚¹ãƒ‘ã‚¤ã‚¯ãŒã‚ˆã‚Šæ¥µç«¯ã«ãªã‚‹ã®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯scale $s = \alpha/q_{\max}$ ãŒå¤§ãããªã‚Šã€é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ãŒç²—ããªã‚‹ãŸã‚ã§ã™ã€‚</div>
    </details>
  </div>
</div>

<!-- ERROR VISUALIZATION -->
<div class="sec">
  <h2>ğŸŒ¡ï¸ é‡å­åŒ–èª¤å·®ã‚’ç›´æ„Ÿçš„ã«ç†è§£ã™ã‚‹</h2>
  <div class="g2">
    <div class="pnl">
      <h3>å…ƒã®å€¤ vs é‡å­åŒ–èª¤å·®ï¼ˆæ•£å¸ƒå›³ï¼‰</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.6rem">å„ç‚¹ã¯1ã¤ã®é‡ã¿ã€‚Xè»¸=å…ƒã®å€¤ã€Yè»¸=é‡å­åŒ–å¾Œã®èª¤å·®ã€‚<strong>0ã‹ã‚‰é›¢ã‚Œã‚‹ã»ã©èª¤å·®ãŒå¤§ãã„</strong>ã“ã¨ãŒä¸€ç›®ã§ã‚ã‹ã‚‹ã€‚</p>
      <canvas id="errScatter" height="300"></canvas>
      <div class="ctrl-row" style="margin-top:.8rem">
        <div><label>ã‚µãƒ³ãƒ—ãƒ«æ•°</label><input type="range" id="esN" min="100" max="1000" value="300" step="100"><span class="val" id="esNv">300</span></div>
        <button class="btn-go" onclick="doErrScatter()">å†ç”Ÿæˆ</button>
      </div>
      <div id="esStats" style="font-size:.82rem;margin-top:.5rem;line-height:1.8"></div>
    </div>
    <div class="pnl">
      <h3>æ•°ç›´ç·šã‚¹ãƒŠãƒƒãƒ— â€” å€¤ã¯ã“ã†ã€Œä¸¸ã‚ã‚‰ã‚Œã‚‹ã€</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.6rem">ä¸Šæ®µ=INT8(256æ®µéš)ã€ä¸‹æ®µ=INT4(16æ®µéš)ã€‚çŸ¢å°ãŒ<span style="color:#ffaa33">é‡å­åŒ–èª¤å·®</span>ã‚’è¡¨ã™ã€‚</p>
      <canvas id="snapCanvas" height="280"></canvas>
      <div class="ctrl-row" style="margin-top:.8rem">
        <div><label>è¡¨ç¤ºã™ã‚‹å€¤ã®æ•°</label><input type="range" id="snapN" min="5" max="25" value="12" step="1"><span class="val" id="snapNv">12</span></div>
        <button class="btn-go" onclick="doSnapViz()">æ–°ã—ã„å€¤ã§å†æç”»</button>
      </div>
    </div>
  </div>

  <!-- Vector Quantization 2D -->
  <div class="pnl" style="margin-top:1rem">
    <h3>ğŸ¯ 2Dãƒ™ã‚¯ãƒˆãƒ«ã§è¦‹ã‚‹é‡å­åŒ–èª¤å·®</h3>
    <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.6rem">
      å·¦: å€‹åˆ¥ãƒ™ã‚¯ãƒˆãƒ«ã®é‡å­åŒ–èª¤å·®ã€‚å³: <strong>ãƒ™ã‚¯ãƒˆãƒ«ã®åˆè¨ˆï¼ˆÎ£ï¼‰</strong>ã§èª¤å·®ãŒã©ã†è“„ç© or ç›¸æ®ºã™ã‚‹ã‹ã€‚è–„ã„ç·šã¯å„ãƒ™ã‚¯ãƒˆãƒ«ã®åŠ ç®—éç¨‹ã‚’ç¤ºã—ã¾ã™ã€‚
    </p>
    <div class="ctrl-row" style="margin-bottom:.6rem">
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label>
        <select id="vqBits"><option value="8">INT8</option><option value="4" selected>INT4</option><option value="3">INT3</option><option value="2">INT2</option></select>
      </div>
      <div><label>ãƒ™ã‚¯ãƒˆãƒ«æ•°</label><input type="range" id="vqN" min="3" max="20" value="8" step="1"><span class="val" id="vqNv">8</span></div>
      <button class="btn-go" onclick="doVecQuant()">å†ç”Ÿæˆ</button>
    </div>
    <canvas id="vqCanvas" height="420"></canvas>
    <div id="vqStats" style="font-size:.82rem;margin-top:.5rem;line-height:1.8"></div>
    <details class="note">
      <summary>è§£èª¬: ãƒ™ã‚¯ãƒˆãƒ«é‡å­åŒ–ã¨è§’åº¦èª¤å·®ã®æ•°ç†</summary>
      <p>é‡ã¿ãƒ™ã‚¯ãƒˆãƒ« $\mathbf{w} \in \mathbb{R}^d$ ã‚’è¦ç´ ã”ã¨ã«é‡å­åŒ–ã™ã‚‹ã¨ $\hat{\mathbf{w}} = Q(\mathbf{w})$ ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚ã“ã®ã¨ã2ç¨®é¡ã®èª¤å·®ãŒç™ºç”Ÿã—ã¾ã™:</p>
      <p><strong>1. ãƒãƒ«ãƒ ï¼ˆå¤§ãã•ï¼‰ã®èª¤å·®:</strong></p>
      <div class="fm">$$\epsilon_{\mathrm{norm}} = \left|\; \|\mathbf{w}\| - \|\hat{\mathbf{w}}\| \;\right|$$</div>
      <p><strong>2. è§’åº¦èª¤å·®ï¼ˆæ–¹å‘ã®ãšã‚Œï¼‰:</strong></p>
      <div class="fm">$$\theta = \arccos\!\left(\frac{\mathbf{w} \cdot \hat{\mathbf{w}}}{\|\mathbf{w}\| \cdot \|\hat{\mathbf{w}}\|}\right)$$</div>
      <p>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¡Œåˆ—ç© $y = Wx$ ã«ãŠã„ã¦ã€è§’åº¦èª¤å·®ã¯<strong>æ´»æ€§åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¤‰åŒ–</strong>ï¼ˆã©ã®ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³ãŒç™ºç«ã™ã‚‹ã‹ï¼‰ã«ç›´çµã™ã‚‹ãŸã‚ã€ãƒãƒ«ãƒ èª¤å·®ã‚ˆã‚Šã‚‚å“è³ªã¸ã®å½±éŸ¿ãŒå¤§ãããªã‚Šã¾ã™ã€‚</p>
      <p>$d$ æ¬¡å…ƒã§å„è¦ç´ ã®é‡å­åŒ–èª¤å·®ãŒç‹¬ç«‹ã« $\mathcal{U}[-s/2, s/2]$ ã«å¾“ã†å ´åˆã€èª¤å·®ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒãƒ«ãƒ ã®æœŸå¾…å€¤ã¯:</p>
      <div class="fm">$$\mathbb{E}\!\left[\|\mathbf{e}\|\right] = s \sqrt{\frac{d}{12}}$$</div>
      <p>æ¬¡å…ƒæ•° $d$ ãŒå¢—ãˆã‚‹ã»ã©èª¤å·®ãƒãƒ«ãƒ ã¯ $\sqrt{d}$ ã§æˆé•·ã—ã¾ã™ãŒã€å…ƒã®ãƒ™ã‚¯ãƒˆãƒ«ã®ãƒãƒ«ãƒ ã‚‚ $\sqrt{d}$ ã§æˆé•·ã™ã‚‹ãŸã‚ã€<strong>ç›¸å¯¾èª¤å·®ã¯æ¬¡å…ƒæ•°ã«ä¾å­˜ã—ã¾ã›ã‚“</strong>ã€‚ä¸€æ–¹ã€è§’åº¦èª¤å·®ã¯é«˜æ¬¡å…ƒã»ã©å°ã•ããªã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ï¼ˆJohnson-Lindenstraussã®é¡ä¼¼æ€§ï¼‰ã€‚</p>
      <p>ã‚°ãƒ©ãƒ•ã®<span style="color:var(--orange)">ã‚ªãƒ¬ãƒ³ã‚¸ã®æ‰‡å½¢</span>ã¯è§’åº¦èª¤å·®ã‚’è¦–è¦šåŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚INT4ã§ $\theta > 5Â°$ ã‚’è¶…ãˆã‚‹ãƒ™ã‚¯ãƒˆãƒ«ã§ã¯ã€è¡Œåˆ—ç©ã®å‡ºåŠ›ã«æœ‰æ„ãªå½±éŸ¿ãŒç”Ÿã˜å§‹ã‚ã¾ã™ã€‚</p>
      <p><strong>3. ãƒ™ã‚¯ãƒˆãƒ«å’Œã®èª¤å·®ï¼ˆå³ãƒ‘ãƒãƒ«ï¼‰:</strong></p>
      <p>ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¡Œåˆ—ç© $y = Wx$ ã¯ã€é‡ã¿è¡Œåˆ—ã®è¡Œãƒ™ã‚¯ãƒˆãƒ«ã¨å…¥åŠ›ã®å†…ç©ã®ã€Œå’Œã€ã§ã™ã€‚å³ãƒ‘ãƒãƒ«ã¯é‡å­åŒ–å¾Œã®åˆè¨ˆãƒ™ã‚¯ãƒˆãƒ« $\sum Q(\mathbf{w}_i)$ ãŒå…ƒã®åˆè¨ˆ $\sum \mathbf{w}_i$ ã‹ã‚‰ã©ã‚Œã ã‘ãšã‚Œã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚</p>
      <p>å„ãƒ™ã‚¯ãƒˆãƒ«ã®é‡å­åŒ–èª¤å·®ã‚’ $\mathbf{e}_i = \mathbf{w}_i - Q(\mathbf{w}_i)$ ã¨ã™ã‚‹ã¨ã€åˆè¨ˆã®èª¤å·®ã¯:</p>
      <div class="fm">$$\left\|\sum_i \mathbf{e}_i\right\| \le \sum_i \|\mathbf{e}_i\| \quad \text{(ä¸‰è§’ä¸ç­‰å¼)}$$</div>
      <p>ã—ã‹ã— $\mathbf{e}_i$ ã®æ–¹å‘ãŒãƒ©ãƒ³ãƒ€ãƒ ã«åˆ†æ•£ã™ã‚‹ãŸã‚ã€å®Ÿéš›ã«ã¯<strong>å¤§æ•°ã®æ³•å‰‡</strong>ã«ã‚ˆã‚Š:</p>
      <div class="fm">$$\mathbb{E}\!\left[\left\|\sum_i \mathbf{e}_i\right\|^2\right] = \sum_i \mathbb{E}\!\left[\|\mathbf{e}_i\|^2\right] = N \cdot \frac{d \cdot s^2}{12}$$</div>
      <div class="fm">$$\left\|\sum_i \mathbf{e}_i\right\| \approx \sqrt{N} \cdot s\sqrt{\frac{d}{12}} \ll N \cdot \frac{s}{2}\sqrt{d}$$</div>
      <p>ã¤ã¾ã‚Š $N$ å€‹ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¶³ã™ã¨ã€èª¤å·®ã¯æœ€æ‚ªã‚±ãƒ¼ã‚¹ã® $N$ å€ã§ã¯ãªã <strong>$\sqrt{N}$ å€</strong>ã«ã—ã‹æˆé•·ã—ã¾ã›ã‚“ã€‚ã“ã‚ŒãŒã€Œé‡å­åŒ–ã—ã¦ã‚‚è¡Œåˆ—ç©ãŒå£Šã‚Œã«ãã„ã€æ ¹æœ¬çš„ãªç†ç”±ã§ã™ã€‚å†ç”Ÿæˆã‚’ä½•åº¦ã‹è©¦ã™ã¨ã€åˆè¨ˆèª¤å·®ãŒå€‹åˆ¥å¹³å‡ã‚ˆã‚Šå°ã•ã„ã‚±ãƒ¼ã‚¹ï¼ˆèª¤å·®ãŒç›¸æ®ºï¼‰ãŒé »ç¹ã«è¦³å¯Ÿã§ãã¾ã™ã€‚</p>
    </details>
  </div>

  <details class="note">
    <summary>è§£èª¬: é‡å­åŒ–èª¤å·®ã®æ•°ç† â€” é‹¸æ­¯çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã‚¹ã‚±ãƒ¼ãƒ«ã®é•ã„</summary>

    <p><strong>â–  é‹¸æ­¯çŠ¶ï¼ˆä¸‰è§’æ³¢ï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ­£ä½“</strong></p>
    <p>INT4ã®æ•£å¸ƒå›³ã«è¦‹ãˆã‚‹<strong>è¦å‰‡çš„ãªæ³¢æ¨¡æ§˜</strong>ã¯ã€é‡å­åŒ–ã®æœ¬è³ªãã®ã‚‚ã®ã§ã™ã€‚å¯¾ç§°é‡å­åŒ–ã®ã‚°ãƒªãƒƒãƒ‰é–“éš” $s$ ã§ä¸¦ã¶é‡å­åŒ–ç‚¹ã®é–“ã§ã€èª¤å·® $\epsilon(x) = |x - Q(x)|$ ã¯ä»¥ä¸‹ã®ä¸‰è§’æ³¢ã‚’æãã¾ã™:</p>
    <div class="fm">$$\epsilon(x) = \left|x - s \cdot \mathrm{round}\!\left(\frac{x}{s}\right)\right|$$</div>
    <p>å„é‡å­åŒ–ç‚¹ $c_k = k \cdot s$ ã‚’ä¸­å¿ƒã«ã€$\epsilon$ ã¯ <strong>0 â†’ $s/2$ â†’ 0</strong> ã¨ç·šå½¢ã«å¢—æ¸›ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã‚°ãƒªãƒƒãƒ‰ç‚¹ã¡ã‚‡ã†ã©ã§ã¯èª¤å·®0ã€ã‚°ãƒªãƒƒãƒ‰ç‚¹ã®ä¸­é–“ã§æœ€å¤§èª¤å·® $s/2$ ã«é”ã—ã¾ã™ã€‚ã“ã‚ŒãŒå‘¨æœŸ $s$ ã®<strong>ä¸‰è§’æ³¢</strong>ã§ã™:</p>
    <div class="fm">$$\epsilon(x) = \frac{s}{2} - \left|\,\left(x \bmod s\right) - \frac{s}{2}\,\right|$$</div>

    <p><strong>â–  INT8ã«ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ â€” è¦‹ãˆãªã„ã ã‘</strong></p>
    <p>INT8ã‚‚ã¾ã£ãŸãåŒã˜ä¸‰è§’æ³¢æ§‹é€ ã‚’æŒã¡ã¾ã™ã€‚è¦‹ãˆãªã„ç†ç”±ã¯<strong>ã‚¹ã‚±ãƒ¼ãƒ«ã®é•ã„</strong>ã§ã™:</p>
    <div class="fm">$$s_4 = \frac{\alpha}{2^3 - 1} = \frac{\alpha}{7}, \quad s_8 = \frac{\alpha}{2^7 - 1} = \frac{\alpha}{127}$$</div>
    <p>INT8ã®ã‚°ãƒªãƒƒãƒ‰é–“éš”ã¯INT4ã®ç´„ $127/7 \approx 18$ å€ç´°ã‹ã„ãŸã‚ã€ä¸‰è§’æ³¢ã®æŒ¯å¹…ï¼ˆæœ€å¤§èª¤å·®ï¼‰ã‚‚ç´„18å€å°ã•ããªã‚Šã¾ã™:</p>
    <div class="fm">$$\frac{s_4 / 2}{s_8 / 2} = \frac{q_{\max,8}}{q_{\max,4}} = \frac{127}{7} \approx 18.1$$</div>
    <p>ã“ã®ã‚°ãƒ©ãƒ•ã§ã¯Yè»¸ãŒINT4ã®æœ€å¤§èª¤å·®ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€<strong>INT8ã®ä¸‰è§’æ³¢ã¯é«˜ã• $1/18$ ã«åœ§ç¸®ã•ã‚Œã¦æ°´å¹³ç·šã®ã‚ˆã†ã«è¦‹ãˆã‚‹</strong>ã ã‘ã§ã™ã€‚INT8ã ã‘ã‚’æ‹¡å¤§è¡¨ç¤ºã™ã‚Œã°ã€å…¨ãåŒã˜é‹¸æ­¯çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¾ã‚Œã¾ã™ã€‚</p>

    <p><strong>â–  ä¸€èˆ¬åŒ–: ãƒ“ãƒƒãƒˆå¹…ã¨èª¤å·®åŒ…çµ¡ç·š</strong></p>
    <p>ä»»æ„ã®ãƒ“ãƒƒãƒˆå¹… $b$ ã«å¯¾ã™ã‚‹èª¤å·®ã®åŒ…çµ¡ç·šã¯:</p>
    <div class="fm">$$0 \le \epsilon(x) \le \frac{s_b}{2} = \frac{\alpha}{2(2^{b-1} - 1)}$$</div>
    <p>ã‚°ãƒ©ãƒ•ä¸Šã§ã¯ã€æ•£å¸ƒå›³ã®ç‚¹ãŒ $y = 0$ ã¨ $y = s_b/2$ ã®é–“ã®<strong>å¸¯çŠ¶ã®é ˜åŸŸ</strong>ã‚’åŸ‹ã‚ã€ä¸‰è§’æ³¢ã®è°·ï¼ˆ$\epsilon = 0$ï¼‰ã¯é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ç‚¹ã®ä½ç½®ã«å¯¾å¿œã—ã¾ã™ã€‚INT4ã¯7æœ¬ã®è°·ã€INT8ã¯127æœ¬ã®è°·ãŒã‚ã‚Šã¾ã™ã€‚</p>

    <p><strong>â–  ãªãœ0ä»˜è¿‘ã¯èª¤å·®ãŒå°ã•ãè¦‹ãˆã‚‹ã‹</strong></p>
    <p>é‹¸æ­¯çŠ¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŒ¯å¹… $s/2$ ã¯ä½ç½®ã«ã‚ˆã‚‰ãšä¸€å®šã§ã™ãŒã€æ•£å¸ƒå›³ã§ã¯Xè»¸ã®0ä»˜è¿‘ã«ç‚¹ãŒ<strong>å¯†é›†</strong>ã—ã¦ã„ã¾ã™ï¼ˆæ­£è¦åˆ†å¸ƒã®ãŸã‚ï¼‰ã€‚å¯†é›†ã—ãŸç‚¹ç¾¤ã®ä¸­ã§ã¯ä¸‰è§’æ³¢ã®å€‹ã€…ã®å±±ãŒè­˜åˆ¥ã—ã¥ã‚‰ãã€ã€Œ0ä»˜è¿‘ã¯ä½èª¤å·®ã€ã«è¦‹ãˆã¾ã™ã€‚å®Ÿéš›ã«ã¯çµ¶å¯¾èª¤å·®ã¯å…¨åŸŸã§åŒã˜ $[0, s/2]$ ã®ç¯„å›²ã§ã™ã€‚</p>

    <p>ãŸã ã—<strong>ç›¸å¯¾èª¤å·®</strong>ã¯ç•°ãªã‚Šã¾ã™:</p>
    <div class="fm">$$\epsilon_{\mathrm{rel}}(x) = \frac{\epsilon(x)}{|x|} \le \frac{s/2}{|x|}$$</div>
    <p>NNã®å‡ºåŠ›ã¸ã®å½±éŸ¿ã¯ $|w| \cdot \epsilon$ ã«æ¯”ä¾‹ã™ã‚‹ãŸã‚ã€$|w|$ ãŒå°ã•ã„0ä»˜è¿‘ã®é‡ã¿ã®é‡å­åŒ–èª¤å·®ã¯å‡ºåŠ›ã«ã»ã¼å½±éŸ¿ã—ã¾ã›ã‚“ã€‚</p>

    <p><strong>â–  ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°èª¤å·®</strong></p>
    <p>$|x| > \alpha$ ã®å€¤ã¯ $\alpha$ ã«åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã€ä¸‰è§’æ³¢ã®ä¸Šé™ã‚’è¶…ãˆãŸå˜èª¿å¢—åŠ ã®èª¤å·®ãŒç”Ÿã˜ã¾ã™:</p>
    <div class="fm">$$\epsilon_{\mathrm{clip}}(x) = |x| - \alpha \quad \text{(for } |x| > \alpha \text{)}$$</div>
    <div class="warn">INT4ã§ã¯ $q_{\max} = 7$ ã§ã€å…¨ã¦ã®é‡ã¿ãŒ<strong>ãŸã£ãŸ15å€‹ã®å€¤</strong> $\{-7s, \ldots, 0, \ldots, 7s\}$ ã®ã„ãšã‚Œã‹ã«ä¸¸ã‚ã‚‰ã‚Œã¾ã™ã€‚7Bãƒ¢ãƒ‡ãƒ«ã®70å„„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ãšã‹15æ®µéšã«ã€‚ãã‚Œã§ã‚‚å‹•ä½œã™ã‚‹ã®ã¯ã€é‡ã¿ã®åˆ†å¸ƒãŒ0ä»˜è¿‘ã«é›†ä¸­ã—ã¦ãŠã‚ŠMSEãŒååˆ†å°ã•ã„ãŸã‚ã§ã™ã€‚</div>
  </details>
</div>

<!-- TRADEOFF -->
<div class="sec">
  <h2>âš¡ ãƒ¡ãƒ¢ãƒªãƒ»é€Ÿåº¦ãƒ»å“è³ªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•</h2>
  <div class="pnl">
    <div class="ctrl-row">
      <div><label>ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º</label>
        <select id="mSz" onchange="doTradeoff()" style="font-size:.9rem">
          <option value="1.5">1.5B (Qwen2.5ç­‰)</option><option value="3">3B (Llama 3.2ç­‰)</option>
          <option value="7" selected>7B (Llama 2-7Bç­‰)</option><option value="13">13B (Llama 2-13Bç­‰)</option>
          <option value="34">34B (CodeLlama-34Bç­‰)</option><option value="70">70B (Llama 2-70Bç­‰)</option>
        </select>
      </div>
    </div>
    <div class="cg" id="tfCards"></div>
    <details class="note">
      <summary>è§£èª¬: ãƒ¡ãƒ¢ãƒªãƒ»å¸¯åŸŸå¹…ãƒ»æ¼”ç®—é‡ã®å®šé‡åˆ†æ</summary>
      <p><strong>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</strong>ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•° $N$ ã¨ãƒ“ãƒƒãƒˆå¹… $b$ ã‹ã‚‰:</p>
      <div class="fm">$$\text{VRAM}_{\mathrm{weights}} = \frac{N \times b}{8} \;\text{[bytes]}$$</div>
      <p>ä¾‹: $N = 7 \times 10^9$, $b = 32$ â†’ $28\,\text{GB}$ã€‚$b = 4$ â†’ $3.5\,\text{GB}$ã€‚</p>
      <p>ãŸã ã—æ¨è«–æ™‚ã«ã¯KVã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åˆ†ã‚‚å¿…è¦ã§ã™ã€‚ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é•· $L$ã€å±¤æ•° $n_l$ã€éš ã‚Œæ¬¡å…ƒ $d$ ã®ã¨ã:</p>
      <div class="fm">$$\text{VRAM}_{\mathrm{KV}} = 2 \times n_l \times L \times d \times \frac{b_{\mathrm{kv}}}{8}$$</div>
      <p><strong>æ¨è«–ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ</strong>: è‡ªå·±å›å¸°æ¨è«–ã¯1ãƒˆãƒ¼ã‚¯ãƒ³ãšã¤ç”Ÿæˆã™ã‚‹ãŸã‚ã€<strong>ãƒ¡ãƒ¢ãƒªå¸¯åŸŸå¾‹é€Ÿ</strong>ï¼ˆcompute-boundã§ã¯ãªãmemory-boundï¼‰ã«ãªã‚Šã¾ã™ã€‚å¸¯åŸŸå¹… $B_{\mathrm{mem}}$ [GB/s] ã®ã¨ã:</p>
      <div class="fm">$$\text{tokens/s} \approx \frac{B_{\mathrm{mem}}}{\text{VRAM}_{\mathrm{weights}} / N_{\mathrm{tokens\_batch}}}$$</div>
      <p>ãƒ“ãƒƒãƒˆå¹…ã‚’åŠåˆ†ã«ã™ã‚‹ã¨è»¢é€ãƒ‡ãƒ¼ã‚¿é‡ã‚‚åŠåˆ† â†’ <strong>ç´„2å€é€Ÿ</strong>ã€‚A100 (2TB/s) ã§INT4-7Bãƒ¢ãƒ‡ãƒ«ãªã‚‰ç†è«–ä¸Š $\sim 570$ tokens/sã€‚</p>
      <p><strong>æ¼”ç®—é‡ (FLOPs)</strong>: INT8/INT4ã®æ•´æ•°æ¼”ç®—ã¯FP32ã®æµ®å‹•å°æ•°ç‚¹æ¼”ç®—ã‚ˆã‚Šé«˜é€Ÿã§ã€A100ã§ã¯INT8ãŒFP32æ¯”ã§ç´„4å€ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ (624 TOPS vs 156 TFLOPS) ã§ã™ã€‚</p>
      <div class="eg">INT4ã«ã™ã‚Œã°ã€8GB VRAMã®æ¶ˆè²»è€…å‘ã‘GPU (RTX 3060ç­‰) ã§7Bãƒ¢ãƒ‡ãƒ«ãŒå‹•ãã¾ã™ã€‚FP32ã ã¨A100 (80GB) ã‚¯ãƒ©ã‚¹ãŒå¿…è¦ã§ã™ã€‚ã“ã®å·®ãŒã€Œé‡å­åŒ–é©å‘½ã€ã®æ ¸å¿ƒã§ã™ã€‚</div>
    </details>
  </div>
</div>
</div>

<!-- ==================== TAB 2 ==================== -->
<div class="tab" id="t-playground">
<div class="stabs" id="pgSt">
  <button class="on" data-s="sym">å¯¾ç§°é‡å­åŒ–</button>
  <button data-s="asym">éå¯¾ç§°é‡å­åŒ–</button>
  <button data-s="blk">ãƒ–ãƒ­ãƒƒã‚¯é‡å­åŒ–</button>
</div>

<!-- SYMMETRIC -->
<div class="psub on" id="s-sym">
<details class="note" open>
  <summary>å¯¾ç§°é‡å­åŒ– â€” æœ€ã‚‚åŸºæœ¬çš„ãªæ‰‹æ³•</summary>
  <p><span class="kw">å¯¾ç§°é‡å­åŒ–</span>ã¯ã€å€¤ã®ç¯„å›²ã‚’ $[-\alpha, +\alpha]$ ã¨ä»®å®šã—ï¼ˆ$\alpha = \max|w_i|$ï¼‰ã€0ã‚’ä¸­å¿ƒã«ç­‰é–“éš”ã§é›¢æ•£åŒ–ã—ã¾ã™ã€‚</p>
  <p><strong>é‡å­åŒ– (Quantize):</strong></p>
  <div class="fm">$$s = \frac{\alpha}{2^{b-1} - 1}, \quad q = \mathrm{round}\!\left(\frac{x}{s}\right), \quad q_c = \mathrm{clamp}(q, -q_{\max}, q_{\max})$$</div>
  <p><strong>é€†é‡å­åŒ– (Dequantize):</strong></p>
  <div class="fm">$$\hat{x} = q_c \cdot s$$</div>
  <p>ç‰¹å¾´: <strong>$x=0$ ãŒæ­£ç¢ºã« $q=0$ ã«ãƒãƒƒãƒ”ãƒ³ã‚°</strong>ã•ã‚Œã‚‹ãŸã‚ã€ReLUå¾Œã®ã‚¹ãƒ‘ãƒ¼ã‚¹ãªãƒ†ãƒ³ã‚½ãƒ«ï¼ˆå¤šãã®0ã‚’å«ã‚€ï¼‰ã«æœ€é©ã€‚zero-pointã®ä¿å­˜ãŒä¸è¦ã§ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ãŒè‰¯ã„ã€‚</p>
</details>
<div class="g2">
  <div class="pnl">
    <h3>ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—</h3>
    <div class="ctrl-row">
      <div><label>å…¥åŠ›å€¤</label><input type="number" id="sV" value="0.75" step="0.01" style="width:100px"></div>
      <div><label>absMax</label><input type="number" id="sA" value="1.0" step="0.1" style="width:80px"></div>
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label><select id="sB"><option value="8">INT8</option><option value="4">INT4</option><option value="2">INT2</option></select></div>
      <button class="btn-go" onclick="doSym()">è¨ˆç®—</button>
    </div>
    <ol class="slist" id="sSteps"></ol>
  </div>
  <div class="pnl">
    <h3>æ•°ç›´ç·šï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§å€¤ã‚’å¤‰æ›´å¯èƒ½ï¼‰</h3>
    <canvas id="sNL" height="140" style="cursor:ew-resize"></canvas>
    <div style="margin-top:.6rem;font-size:.8rem;color:var(--text-muted);display:flex;gap:1.2rem;flex-wrap:wrap">
      <span><span style="color:var(--accent)">â—</span> å…ƒã®å€¤</span>
      <span><span style="color:var(--red)">â—</span> é‡å­åŒ–å€¤</span>
      <span style="color:var(--border2)">| é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰</span>
      <span style="color:var(--orange)">--- èª¤å·®</span>
    </div>
    <details class="note">
      <summary>è§£èª¬: æ•°ç›´ç·šã®è¦‹æ–¹</summary>
      <p>ç´°ã„ç¸¦ç·š = <strong>é‡å­åŒ–ãƒ¬ãƒ™ãƒ«</strong>ï¼ˆå–ã‚Šã†ã‚‹å€¤ã®å€™è£œï¼‰ã€‚INT8ãªã‚‰255æœ¬ã€INT4ãªã‚‰15æœ¬ã€‚</p>
      <p>é’ã„ç‚¹ï¼ˆå…ƒã®å€¤ï¼‰ãŒæœ€ã‚‚è¿‘ã„é‡å­åŒ–ãƒ¬ãƒ™ãƒ«ã«ã€Œå¸ã„å¯„ã›ã‚‰ã‚Œã‚‹ã€ã®ãŒé‡å­åŒ–ã§ã™ã€‚èµ¤ã„ç‚¹ã¨ã®å·®ãŒ<strong>é‡å­åŒ–èª¤å·®</strong>ã€‚</p>
      <p><strong>æ•°ç›´ç·šä¸Šã‚’ãƒ‰ãƒ©ãƒƒã‚°</strong>ã™ã‚‹ã¨å…¥åŠ›å€¤ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å¤‰ã‚ã‚Šã¾ã™ã€‚ãƒ“ãƒƒãƒˆå¹…ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚°ãƒªãƒƒãƒ‰ã®ç²—ã•ã®é•ã„ã‚’ä½“æ„Ÿã—ã¦ãã ã•ã„ã€‚</p>
    </details>
  </div>
</div>
</div>

<!-- ASYMMETRIC -->
<div class="psub" id="s-asym" style="display:none">
<details class="note" open>
  <summary>éå¯¾ç§°é‡å­åŒ– â€” åã£ãŸåˆ†å¸ƒã«å¼·ã„</summary>
  <p><span class="kw">éå¯¾ç§°é‡å­åŒ–</span>ã¯<strong><span class="tip" data-tip="å®Ÿæ•°ã®0ãŒæ•´æ•°ã®ä½•ç•ªç›®ã«å¯¾å¿œã™ã‚‹ã‹ã‚’ç¤ºã™ã‚ªãƒ•ã‚»ãƒƒãƒˆå€¤">zero-point $z$</span></strong>ã‚’å°å…¥ã—ã€$[x_{\min}, x_{\max}]$ ã‚’ $[0, 2^b - 1]$ ã«ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›ã—ã¾ã™ã€‚</p>
  <p><strong>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—:</strong></p>
  <div class="fm">$$s = \frac{x_{\max} - x_{\min}}{2^b - 1}, \quad z = \mathrm{round}\!\left(-\frac{x_{\min}}{s}\right)$$</div>
  <p><strong>é‡å­åŒ–ãƒ»é€†é‡å­åŒ–:</strong></p>
  <div class="fm">$$q = \mathrm{clamp}\!\left(\mathrm{round}\!\left(\frac{x}{s} + z\right),\; 0,\; 2^b - 1\right), \quad \hat{x} = (q - z) \cdot s$$</div>
  <p>è¡Œåˆ—ç© $Y = XW^T$ ã®è¨ˆç®—æ™‚ã€$\hat{W} = s(q_W - z)$ ã‚’å±•é–‹ã™ã‚‹ã¨:</p>
  <div class="fm">$$Y = s \cdot X \cdot q_W^T - s \cdot z \cdot \mathbf{1}^T X^T$$</div>
  <p>ç¬¬2é …ã®zero-pointè£œæ­£ãŒè¿½åŠ ã‚³ã‚¹ãƒˆã¨ãªã‚Šã¾ã™ã€‚</p>
  <div class="eg">å¯¾ç§°é‡å­åŒ–ãŒã€Œ$-100$â„ƒã€œ$+100$â„ƒã®æ¸©åº¦è¨ˆã€ã§å®¤æ¸©ã‚’æ¸¬ã‚‹ã‚ˆã†ãªã‚‚ã®ãªã‚‰ã€éå¯¾ç§°ã¯ã€Œ$15$â„ƒã€œ$35$â„ƒå°‚ç”¨æ¸©åº¦è¨ˆã€ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚å¿…è¦ãªç¯„å›²ã ã‘ã‚«ãƒãƒ¼ã™ã‚‹ã®ã§ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</div>
</details>
<div class="g2">
  <div class="pnl">
    <h3>ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—</h3>
    <div class="ctrl-row">
      <div><label>å…¥åŠ›å€¤</label><input type="number" id="aV" value="0.3" step="0.01" style="width:90px"></div>
      <div><label>min</label><input type="number" id="aMn" value="-0.5" step="0.1" style="width:80px"></div>
      <div><label>max</label><input type="number" id="aMx" value="1.5" step="0.1" style="width:80px"></div>
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label><select id="aB"><option value="8">INT8</option><option value="4">INT4</option></select></div>
      <button class="btn-go" onclick="doAsym()">è¨ˆç®—</button>
    </div>
    <ol class="slist" id="aSteps"></ol>
  </div>
  <div class="pnl">
    <h3>å¯¾ç§° vs éå¯¾ç§° æ¯”è¼ƒ</h3>
    <canvas id="aNL" height="170"></canvas>
    <div style="font-size:.8rem;color:var(--text-muted);margin-top:.5rem">ä¸Šæ®µ=å¯¾ç§°ï¼ˆèµ¤ç‚¹ï¼‰ / ä¸‹æ®µ=éå¯¾ç§°ï¼ˆç·‘ç‚¹ï¼‰ã€‚é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ã®é…ç½®ã®é•ã„ã«æ³¨ç›®ã€‚</div>
    <details class="note">
      <summary>è§£èª¬: ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãï¼Ÿ</summary>
      <ul>
        <li><strong>å¯¾ç§°</strong>: é‡ã¿ãŒ0ä¸­å¿ƒã«åˆ†å¸ƒã™ã‚‹å ´åˆã«æœ€é©ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§é«˜é€Ÿã€‚zero-pointã®ä¿å­˜ä¸è¦ã€‚</li>
        <li><strong>éå¯¾ç§°</strong>: æ´»æ€§åŒ–å€¤ï¼ˆReLUå¾Œã¯[0,âˆ)ï¼‰ãªã©åã£ãŸåˆ†å¸ƒã«æœ‰åŠ¹ã€‚zero-pointåˆ†ã®è¿½åŠ ã‚³ã‚¹ãƒˆã‚ã‚Šã€‚</li>
      </ul>
      <p>å®Ÿå‹™ã§ã¯<strong>é‡ã¿â†’å¯¾ç§°ã€æ´»æ€§åŒ–â†’éå¯¾ç§°</strong>ã®çµ„ã¿åˆã‚ã›ãŒæ¨™æº–ã§ã™ã€‚</p>
    </details>
  </div>
</div>
</div>

<!-- BLOCK -->
<div class="psub" id="s-blk" style="display:none">
<details class="note" open>
  <summary>ãƒ–ãƒ­ãƒƒã‚¯é‡å­åŒ– â€” å®Ÿç”¨æ‰‹æ³•ã®åŸºç›¤</summary>
  <p><span class="kw">ãƒ–ãƒ­ãƒƒã‚¯é‡å­åŒ–</span>ã¯é‡ã¿ãƒ™ã‚¯ãƒˆãƒ« $\mathbf{w} \in \mathbb{R}^n$ ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º $g$ ã®å°ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã—ã€<strong>ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«ç‹¬ç«‹ã—ãŸscaleã‚’è¨ˆç®—</strong>ã—ã¾ã™ã€‚</p>
  <p>ç¬¬ $k$ ãƒ–ãƒ­ãƒƒã‚¯ ($k = 0, 1, \ldots, \lceil n/g \rceil - 1$) ã®scale:</p>
  <div class="fm">$$s_k = \frac{\max_{i \in \mathrm{block}_k} |w_i|}{2^{b-1} - 1}$$</div>
  <p><strong>Per-Tensor</strong> ($g = n$): ãƒ†ãƒ³ã‚½ãƒ«å…¨ä½“ã§1ã¤ã® $s$ â†’ å¤–ã‚Œå€¤ãŒå…¨ä½“ã®ç²¾åº¦ã‚’æ”¯é…</p>
  <p><strong>Per-Block</strong> ($g = 32 \sim 128$): å¤–ã‚Œå€¤ã®å½±éŸ¿ãŒãƒ–ãƒ­ãƒƒã‚¯å†…ã«å±€æ‰€åŒ–</p>
  <p><strong>å®ŸåŠ¹ãƒ“ãƒƒãƒˆå¹…</strong>: ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º $g$ã€INT$b$ã€scaleã‚’FP16 (2 bytes) ã§ä¿å­˜ã™ã‚‹å ´åˆ:</p>
  <div class="fm">$$b_{\mathrm{eff}} = b + \frac{16}{g} \;\text{[bits/weight]}$$</div>
  <p>ä¾‹: $g=32$, $b=4$ â†’ $b_{\mathrm{eff}} = 4 + 0.5 = 4.5$ bits/weightã€‚GPTQ, AWQ, GGUFç­‰ã®å®Ÿç”¨æ‰‹æ³•ã¯ã™ã¹ã¦ã“ã®æ–¹å¼ã‚’æ¡ç”¨ã€‚</p>
  <div class="eg">100äººã®ã‚¯ãƒ©ã‚¹ã‚’Aã€œDã®4æ®µéšè©•ä¾¡ã«ã™ã‚‹ã¨ãã€ã‚¯ãƒ©ã‚¹å…¨ä½“ã§1ã¤ã®åŸºæº– (Per-Tensor) ã ã¨ã€1äººã®å¤©æ‰ã«å¼•ã£å¼µã‚‰ã‚Œã¦å¤§åŠãŒDã€‚ç§‘ç›®åˆ¥ã«åŸºæº–ã‚’å¤‰ãˆã‚‹ (Per-Block) ã¨ã€å„ç§‘ç›®å†…ã§å…¬å¹³ãªè©•ä¾¡ã«ãªã‚Šã¾ã™ã€‚</div>
</details>
<div class="pnl">
  <h3>Per-Tensor vs Per-Block æ¯”è¼ƒ</h3>
  <div class="ctrl-row">
    <div><label>ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º</label><select id="bSz"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option><option value="32">32</option></select></div>
    <div><label>ãƒ“ãƒƒãƒˆå¹…</label><select id="bB"><option value="8">INT8</option><option value="4" selected>INT4</option></select></div>
    <button class="btn-go" onclick="doBlock()">32å€‹ã®é‡ã¿ã§æ¯”è¼ƒ</button>
  </div>
  <div class="g2">
    <div>
      <h4 style="font-size:.9rem;color:var(--orange);margin-bottom:.5rem">Per-Tensorï¼ˆ1ã¤ã®scaleï¼‰</h4>
      <canvas id="bTC" height="210"></canvas>
      <div id="bTE" style="font-size:.85rem;margin-top:.4rem"></div>
    </div>
    <div>
      <h4 style="font-size:.9rem;color:var(--green);margin-bottom:.5rem">Per-Blockï¼ˆãƒ–ãƒ­ãƒƒã‚¯åˆ¥scaleï¼‰</h4>
      <canvas id="bBC" height="210"></canvas>
      <div id="bBE" style="font-size:.85rem;margin-top:.4rem"></div>
    </div>
  </div>
  <details class="note" style="margin-top:1rem">
    <summary>è§£èª¬: Per-Blocké‡å­åŒ–ã®èª¤å·®ä½æ¸›ãƒ¡ã‚«ãƒ‹ã‚ºãƒ </summary>
    <p>Per-Tensorã®MSEã¯ã€å¤–ã‚Œå€¤ $w_{\mathrm{outlier}}$ ãŒscaleã‚’æ”¯é…ã™ã‚‹å ´åˆ:</p>
    <div class="fm">$$s_{\mathrm{tensor}} = \frac{|w_{\mathrm{outlier}}|}{q_{\max}}, \quad \mathrm{MSE}_{\mathrm{tensor}} = \frac{s_{\mathrm{tensor}}^2}{12} = \frac{w_{\mathrm{outlier}}^2}{12 \cdot q_{\max}^2}$$</div>
    <p>Per-Blockã§ã¯ã€å¤–ã‚Œå€¤ã‚’å«ã¾ãªã„ãƒ–ãƒ­ãƒƒã‚¯ã¯è‡ªèº«ã®å±€æ‰€çš„ãª $\alpha_k$ ã§scaleã‚’è¨ˆç®—ã™ã‚‹ãŸã‚:</p>
    <div class="fm">$$\mathrm{MSE}_{\mathrm{block}} = \frac{1}{K}\sum_{k=1}^{K} \frac{s_k^2}{12} \ll \mathrm{MSE}_{\mathrm{tensor}}$$</div>
    <p>å¤–ã‚Œå€¤ãƒ–ãƒ­ãƒƒã‚¯ã®ã¿ãŒå¤§ããªscaleã‚’æŒã¡ã€æ®‹ã‚Šã®ãƒ–ãƒ­ãƒƒã‚¯ã¯æœ€é©ãªscaleã‚’ç¶­æŒã—ã¾ã™ã€‚</p>
    <div class="warn"><strong>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰</strong>: $g=32$, INT4ã®å ´åˆã€$32 \times 0.5 + 2 = 18$ bytes â†’ <strong>å¹³å‡ 4.5 bits/weight</strong>ã€‚$g$ ã‚’å°ã•ãã™ã‚‹ã»ã©MSEã¯æ¸›ã‚‹ãŒã€scaleã®ä¿å­˜ã‚³ã‚¹ãƒˆ $16/g$ bits ãŒå¢—åŠ ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã€‚æœ€é©ãª $g$ ã¯ãƒ¢ãƒ‡ãƒ«ã®é‡ã¿åˆ†å¸ƒã«ä¾å­˜ã—ã¾ã™ã€‚</div>
  </details>
</div>
</div>
</div>

<!-- ==================== TAB 3 ==================== -->
<div class="tab" id="t-compare">

<details class="note" open>
  <summary>é‡å­åŒ–æ‰‹æ³•ã”ã¨ã®å‡ºåŠ›å“è³ªã®é•ã„</summary>
  <p>åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç•°ãªã‚‹é‡å­åŒ–æ‰‹æ³•ã®ãƒ¢ãƒ‡ãƒ«ã«ä¸ãˆãŸã¨ãã€<strong>å¿œç­”ã®è±Šã‹ã•ãƒ»æ­£ç¢ºã•ãƒ»ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹</strong>ã«ã©ã®ã‚ˆã†ãªå·®ãŒå‡ºã‚‹ã‹ã‚’ç¤ºã™ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚</p>
  <ul>
    <li><strong>FP16 / AWQ</strong>: å…ƒãƒ¢ãƒ‡ãƒ«ã«è¿‘ã„è±Šã‹ãªè¡¨ç¾ã‚’ç¶­æŒ</li>
    <li><strong>INT4 / GGUF</strong>: æƒ…å ±ãŒåœ§ç¸®ã•ã‚Œã€è©³ç´°ã‚„å¾®å¦™ãªè¡¨ç¾ãŒå¤±ã‚ã‚Œã‚‹å‚¾å‘</li>
    <li><strong>ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</strong>: æ§‹é€ ãŒæ˜ç¢ºãªãŸã‚é‡å­åŒ–ã«å¼·ã„</li>
    <li><strong>å‰µä½œãƒ»ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹</strong>: å¾®å¦™ãªè¡¨ç¾åŠ›ãŒè¦æ±‚ã•ã‚Œã‚‹ãŸã‚å“è³ªå·®ãŒå‡ºã‚„ã™ã„</li>
  </ul>
</details>

<div class="stabs" id="cSt">
  <button class="on" data-s="cTbl">æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«</button>
  <button data-s="cMth">æ‰‹æ³•ã‚«ãƒ¼ãƒ‰</button>
  <button data-s="cUsr">ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›</button>
</div>

<div class="csub on" id="s-cTbl"><div class="pnl">
  <h3>é‡å­åŒ–æ‰‹æ³•åˆ¥ å¿œç­”å“è³ªæ¯”è¼ƒ</h3>
  <div style="font-size:.85rem;color:var(--text-muted);margin-bottom:.8rem">ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ã€‚â˜…ã‚¯ãƒªãƒƒã‚¯ã§è©•ä¾¡ï¼ˆLocalStorageä¿å­˜ï¼‰ã€‚</div>
  <div class="ctbl" id="cTblW"></div>
</div></div>

<div class="csub" id="s-cMth" style="display:none"><div class="pnl"><h3>é‡å­åŒ–æ‰‹æ³•ã®è©³ç´°</h3><div id="mCards"></div></div></div>

<div class="csub" id="s-cUsr" style="display:none"><div class="pnl">
  <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</h3>
  <p style="font-size:.88rem;color:var(--text-muted);margin-bottom:1rem">ç‹¬è‡ªã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»å¿œç­”ã‚’è¿½åŠ ã€‚æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ã«åæ˜ ã•ã‚Œã€LocalStorageã«æ°¸ç¶šä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
  <div class="uis">
    <div class="ctrl-row"><div><label>ã‚«ãƒ†ã‚´ãƒª</label><input type="text" id="uCat" placeholder="ä¾‹: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ" style="width:200px"></div></div>
    <div><label style="font-size:.82rem;color:var(--text-muted);font-weight:600">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label><textarea id="uPr" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..."></textarea></div>
    <div id="uRI"></div>
    <div style="margin-top:.8rem;display:flex;gap:.5rem">
      <button onclick="addUE()" class="btn-p">ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ </button>
      <button onclick="clrUE()" class="btn-d">å…¨ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
  <div id="uEL" style="margin-top:1.5rem"></div>
</div></div>
</div>

<!-- ==================== TAB 4: æ·±æ˜ã‚Šåˆ†æ ==================== -->
<div class="tab" id="t-deep">

<!-- Section A: å¤–ã‚Œå€¤ã®ç ´å£Šçš„å½±éŸ¿ -->
<div class="sec">
  <h2>ğŸ’¥ å¤–ã‚Œå€¤ã®ç ´å£Šçš„å½±éŸ¿</h2>
  <div class="pnl">
    <h3>63å€‹ã®æ­£å¸¸é‡ã¿ + 1å€‹ã®å¤–ã‚Œå€¤</h3>
    <div class="ctrl-row">
      <div><label>å¤–ã‚Œå€¤ã®å¤§ãã•</label><input type="range" id="outMag" min="0" max="50" value="0" step="1"><span class="val" id="outMagV">0</span></div>
      <div><label>ãƒ“ãƒƒãƒˆå¹…</label>
        <select id="outBits"><option value="8">INT8</option><option value="4" selected>INT4</option><option value="2">INT2</option></select>
      </div>
    </div>
    <canvas id="outCanvas" height="220"></canvas>
    <div class="stats-row" id="outStats"></div>
    <details class="note">
      <summary>è§£èª¬: å¤–ã‚Œå€¤å•é¡Œã®æ•°ç†ã¨å¯¾ç­–æ‰‹æ³•</summary>
      <p>Transformerã®ä¸€éƒ¨ãƒãƒ£ãƒãƒ«ã«ã¯ã€$|w_{\mathrm{out}}| \gg \sigma_w$ ã¨ãªã‚‹<strong>å¤–ã‚Œå€¤</strong>ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆDettmers et al., 2022: LLM.int8()ï¼‰ã€‚</p>
      <p>å¤–ã‚Œå€¤ãŒscaleã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å®šé‡åŒ–ã—ã¾ã™ã€‚æ­£å¸¸ãªé‡ã¿ã®æœ€å¤§çµ¶å¯¾å€¤ã‚’ $\alpha_n$ã€å¤–ã‚Œå€¤ã‚’ $\alpha_o$ ($\alpha_o \gg \alpha_n$) ã¨ã™ã‚‹ã¨:</p>
      <div class="fm">$$s = \frac{\alpha_o}{q_{\max}}, \quad \text{æ­£å¸¸å€¤ã®æœ‰åŠ¹ãƒ“ãƒƒãƒˆå¹…} = \log_2\!\left(\frac{2\alpha_n}{s}\right) = b - 1 + \log_2\!\left(\frac{\alpha_n}{\alpha_o}\right)$$</div>
      <p>$\alpha_o / \alpha_n = 100$ ã®å ´åˆã€INT4 ã®æ­£å¸¸å€¤ã®æœ‰åŠ¹ãƒ“ãƒƒãƒˆå¹…ã¯ $4 - 1 - 6.6 \approx -3.6$ â†’ <strong>å®Ÿè³ªçš„ã«æƒ…å ±é‡ã‚¼ãƒ­</strong>ã€‚</p>
      <p><strong>å¯¾ç­–æ‰‹æ³•:</strong></p>
      <ul>
        <li><strong>SmoothQuant</strong> (Xiao et al., 2023): æ´»æ€§åŒ–ã®ãƒãƒ£ãƒãƒ«å˜ä½ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å› å­ $\mathrm{diag}(s_j)$ ã‚’ç”¨ã„ã¦ã€$Y = (X \cdot \mathrm{diag}(s)^{-1}) \cdot (\mathrm{diag}(s) \cdot W)$ ã¨ç­‰ä¾¡å¤‰æ›ã€‚æ´»æ€§åŒ–ã®å¤–ã‚Œå€¤ã‚’é‡ã¿ã«ã€Œç§»ã™ã€</li>
        <li><strong>AWQ</strong> (Lin et al., 2024): é‡è¦ãƒãƒ£ãƒãƒ«ï¼ˆæ´»æ€§åŒ–ã®å¤§ãã•ã§æ¸¬å®šï¼‰ã®scaleã‚’ $s_j = \left(\frac{\|X_j\|}{\max|W_j|}\right)^\alpha$ ã§äº‹å‰èª¿æ•´ã€‚$\alpha$ ã¯æ¢ç´¢ã§æœ€é©åŒ–</li>
        <li><strong>GPTQ</strong> (Frantar et al., 2023): è¿‘ä¼¼ãƒ˜ãƒƒã‚»è¡Œåˆ— $H = 2X^TX$ ã‚’ç”¨ã„ãŸæœ€é©ãƒ–ãƒ¬ã‚¤ãƒ³ã‚µãƒ¼ã‚¸ãƒ§ãƒ³ (OBS) ã§ã€å„é‡ã¿ã®é‡å­åŒ–èª¤å·®ã‚’ä»–ã®æœªé‡å­åŒ–é‡ã¿ã«åˆ†æ•£:
        $$\delta_F = -\frac{w_q - Q(w_q)}{[H^{-1}]_{qq}} \cdot H^{-1}_{:,q}$$</li>
        <li><strong>Mixed-precision</strong> (LLM.int8()): å¤–ã‚Œå€¤ãƒãƒ£ãƒãƒ«ï¼ˆä¸Šä½0.1%ï¼‰ã‚’FP16ã§ä¿æŒã—ã€æ®‹ã‚Šã‚’INT8ã§é‡å­åŒ–</li>
      </ul>
      <div class="eg">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’0â†’50ã«å‹•ã‹ã—ã¦ã€é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ãŒã©ã†å¤‰åŒ–ã™ã‚‹ã‹è¦³å¯Ÿã—ã¦ãã ã•ã„ã€‚å¤–ã‚Œå€¤=50ã§ã¯ã€æ­£å¸¸å€¤($\pm 1$)ã®é ˜åŸŸã®ã‚°ãƒªãƒƒãƒ‰ãŒã»ã¼æ¶ˆå¤±ã—ã€æœ‰åŠ¹ãƒ“ãƒƒãƒˆå¹…ãŒ0ã«è¿‘ã¥ãã¾ã™ã€‚</div>
    </details>
  </div>
</div>

<!-- Section B: Perplexity vs ãƒ“ãƒƒãƒˆæ•° -->
<div class="sec">
  <h2>ğŸ“ˆ Perplexity vs ãƒ“ãƒƒãƒˆæ•°æ›²ç·š</h2>
  <div class="g2">
    <div class="pnl">
      <h3>ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºåˆ¥ é‡å­åŒ–æ„Ÿåº¦</h3>
      <div style="position:relative;height:320px"><canvas id="pplCv"></canvas></div>
      <details class="note">
        <summary>è§£èª¬: Perplexityã®æ•°ç†çš„å®šç¾©ã¨é‡å­åŒ–ã¨ã®é–¢ä¿‚</summary>
        <p><strong>Perplexity (PPL)</strong> ã¯è¨€èªãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬æ€§èƒ½ã‚’æ¸¬ã‚‹æŒ‡æ¨™ã§ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‘ã‚¹ã® $N$ ãƒˆãƒ¼ã‚¯ãƒ³ã«å¯¾ã—ã¦:</p>
        <div class="fm">$$\mathrm{PPL} = \exp\!\left(-\frac{1}{N}\sum_{i=1}^{N} \ln P(t_i \mid t_1, \ldots, t_{i-1})\right)$$</div>
        <p>ç›´æ„Ÿçš„ã«ã¯ã€Œæ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’äºˆæ¸¬ã™ã‚‹éš›ã®å¹³å‡çš„ãªé¸æŠè‚¢ã®æ•°ã€ã€‚PPL = 10 ãªã‚‰ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§å¹³å‡10å€‹ã®å€™è£œã‹ã‚‰é¸ã‚“ã§ã„ã‚‹ã®ã¨åŒç­‰ã®ä¸ç¢ºå®Ÿæ€§ã€‚<strong>ä½ã„ã»ã©æ€§èƒ½ãŒè‰¯ã„</strong>ã€‚</p>
        <p>é‡å­åŒ–é‡ã¿ $\hat{W} = W + E$ ã‚’ç”¨ã„ãŸãƒ¢ãƒ‡ãƒ«ã®PPLå¤‰åŒ–ã¯ã€Taylorå±•é–‹ã§è¿‘ä¼¼ã™ã‚‹ã¨:</p>
        <div class="fm">$$\Delta \mathrm{PPL} \approx \mathrm{PPL}_0 \cdot \left(\frac{1}{N} \sum_i \nabla_W \mathcal{L}_i \cdot E + \frac{1}{2} E^T H E\right)$$</div>
        <p>ã“ã“ã§ $\mathcal{L}_i = -\ln P(t_i|\cdot)$ ã¯ã‚¯ãƒ­ã‚¹ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼æå¤±ã€$H$ ã¯ãƒ˜ãƒƒã‚»è¡Œåˆ—ã€‚GPTQã¯ã“ã® $E^T H E$ é …ã‚’æœ€å°åŒ–ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚</p>
        <ul>
          <li><strong>4bitä»¥ä¸Š</strong>: $\Delta\mathrm{PPL}/\mathrm{PPL}_0 \le 5\%$ â†’ å®Ÿç”¨ä¸Šå•é¡Œãªã—</li>
          <li><strong>3bitä»¥ä¸‹</strong>: $\|E\|_F$ ãŒæ€¥å¢—ã—äºŒæ¬¡é …ãŒæ”¯é…çš„ã« â†’ <strong>å“è³ªã®å´– (quality cliff)</strong></li>
          <li><strong>å¤§ãã„ãƒ¢ãƒ‡ãƒ«ã»ã©é‡å­åŒ–ã«å¼·ã„</strong>: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†—é•·æ€§ãŒé«˜ãã€$H$ ã®å›ºæœ‰å€¤ãŒç›¸å¯¾çš„ã«å°ã•ã„ãŸã‚ $E^T H E$ ãŒæŠ‘åˆ¶ã•ã‚Œã‚‹</li>
        </ul>
      </details>
    </div>
    <div class="pnl">
      <h3>å®Ÿç”¨ã‚¬ã‚¤ãƒ‰</h3>
      <div class="guide-cards">
        <div class="guide-card" style="border-top:3px solid var(--red)">
          <div class="gc-bits" style="color:var(--red)">2-3bit</div>
          <div class="gc-label">ç ”ç©¶ç”¨</div>
          <div class="gc-desc">å“è³ªåŠ£åŒ–ãŒå¤§ãã„ã€‚ç ”ç©¶ãƒ»å®Ÿé¨“ç›®çš„ã€‚GPTQã®æœ€æ–°æ‰‹æ³•ã§ã‚‚é™ç•Œã‚ã‚Š</div>
        </div>
        <div class="guide-card" style="border-top:3px solid var(--orange)">
          <div class="gc-bits" style="color:var(--orange)">4bit</div>
          <div class="gc-label">å®Ÿç”¨æœ€ä½ãƒ©ã‚¤ãƒ³</div>
          <div class="gc-desc">ã‚³ã‚¹ãƒ‘æœ€å¼·ã®ã‚¹ã‚¤ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆã€‚AWQ/GGUFã§é«˜å“è³ªã‚’ç¶­æŒ</div>
        </div>
        <div class="guide-card" style="border-top:3px solid var(--green)">
          <div class="gc-bits" style="color:var(--green)">8bit</div>
          <div class="gc-label">å®‰å…¨åœ</div>
          <div class="gc-desc">å“è³ªã»ã¼ç„¡åŠ£åŒ–ã€‚ãƒ¡ãƒ¢ãƒª75%å‰Šæ¸›ã€‚å•†ç”¨åˆ©ç”¨ã®å®šç•ª</div>
        </div>
        <div class="guide-card" style="border-top:3px solid var(--accent)">
          <div class="gc-bits" style="color:var(--accent)">16bit</div>
          <div class="gc-label">å“è³ªæœ€å„ªå…ˆ</div>
          <div class="gc-desc">FP32ã¨ã»ã¼åŒç­‰ã€‚ç²¾åº¦ãŒçµ¶å¯¾ã®å ´åˆã€‚VRAMæ½¤æ²¢ãªç’°å¢ƒå‘ã‘</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Section C: ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆè¨ˆç®—ã‚¦ã‚©ãƒ¼ã‚¯ã‚¹ãƒ«ãƒ¼ -->
<div class="sec">
  <h2>ğŸ§  ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆè¨ˆç®—ã‚¦ã‚©ãƒ¼ã‚¯ã‚¹ãƒ«ãƒ¼</h2>
  <div class="pnl">
    <h3>2å…¥åŠ›â†’3éš ã‚Œâ†’1å‡ºåŠ› ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</h3>
    <canvas id="nnCanvas" height="340"></canvas>
    <div class="nn-lanes" id="nnLanes"></div>
    <button class="btn-go" onclick="doNNWalk()" style="margin-top:1rem">æ–°ã—ã„é‡ã¿ã§å†è¨ˆç®—</button>
    <details class="note">
      <summary>è§£èª¬: é †ä¼æ’­ã«ãŠã‘ã‚‹é‡å­åŒ–èª¤å·®ã®ä¼æ¬</summary>
      <p>$L$ å±¤ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ $y = f_L \circ \cdots \circ f_1(x)$ ã«ãŠã„ã¦ã€å„å±¤ã®é‡å­åŒ–èª¤å·®ãŒã©ã†ä¼æ¬ã™ã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
      <p>å±¤ $l$ ã®å‡ºåŠ›èª¤å·® $\delta^{(l)} = \hat{y}^{(l)} - y^{(l)}$ ã¯ã€Lipschitzå®šæ•° $K_l$ ã‚’ç”¨ã„ã¦:</p>
      <div class="fm">$$\|\delta^{(l)}\| \le K_l \|\delta^{(l-1)}\| + \|E^{(l)} x^{(l)}\|$$</div>
      <p>$K_l = \|W^{(l)}\| \cdot \mathrm{Lip}(\sigma)$ ã§ã€ReLUã®å ´åˆ $\mathrm{Lip}(\sigma) = 1$ã€‚æœ€çµ‚å±¤ã®èª¤å·®ã¯:</p>
      <div class="fm">$$\|\delta^{(L)}\| \le \sum_{l=1}^{L} \left(\prod_{k=l+1}^{L} K_k\right) \|E^{(l)} x^{(l)}\|$$</div>
      <p>$\|W\|$ ãŒå°ã•ã„ï¼ˆé‡ã¿ãŒ0ä»˜è¿‘ã«é›†ä¸­ï¼‰ãŸã‚ $K_l < 1$ ã¨ãªã‚‹ã“ã¨ãŒå¤šãã€<strong>èª¤å·®ã¯å±¤ã‚’é€šã˜ã¦æ¸›è¡°</strong>ã—ã¾ã™ã€‚ã“ã‚ŒãŒé‡å­åŒ–ãŒæˆç«‹ã™ã‚‹æ ¹æœ¬çš„ãªç†ç”±ã§ã™ã€‚</p>
      <p><strong>è‰²ã®æ„å‘³</strong>: FP32ã®å‡ºåŠ› $y_{\mathrm{FP32}}$ ã‚’åŸºæº–ã¨ã—ã¦ã€$|\hat{y}_b - y_{\mathrm{FP32}}| / |y_{\mathrm{FP32}}|$ ãŒå°ã•ã„ã»ã©ç·‘ã€å¤§ãã„ã»ã©èµ¤ã€‚</p>
      <div class="eg">ã€Œæ–°ã—ã„é‡ã¿ã§å†è¨ˆç®—ã€ã‚’ä½•åº¦ã‹æŠ¼ã™ã¨ã€INT8ã¯FP32ã«ã»ã¼ä¸€è‡´ã—ã€INT4ã§ã‚‚ä¹–é›¢ãŒå°ã•ã„ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒLipschitzå®šæ•° $< 1$ ã®åŠ¹æœã§ã™ã€‚</div>
    </details>
  </div>
</div>

</div>

<script>
// === Core ===
function symQ(v,a,b){const q=(1<<(b-1))-1,s=a/q,r=Math.round(v/s),c=Math.max(-q,Math.min(q,r)),d=c*s;return{s,q:q,r,c,d,e:Math.abs(v-d)}}
function asymQ(v,mn,mx,b){const qx=(1<<b)-1,s=(mx-mn)/qx,z=Math.round(-mn/s),r=Math.round(v/s+z),c=Math.max(0,Math.min(qx,r)),d=(c-z)*s;return{s,z,qx,r,c,d,e:Math.abs(v-d)}}
function blkQ(w,bs,b){const r=[];for(let i=0;i<w.length;i+=bs){const bl=w.slice(i,i+bs),am=Math.max(...bl.map(Math.abs))||1e-10;bl.forEach(v=>{const x=symQ(v,am,b);r.push({o:v,d:x.d,e:x.e})})}return r}
function genW(n,m,s){const w=[];for(let i=0;i<n;i+=2){const u=Math.random(),v=Math.random(),z=Math.sqrt(-2*Math.log(u));w.push(z*Math.cos(2*Math.PI*v)*s+m);if(i+1<n)w.push(z*Math.sin(2*Math.PI*v)*s+m)}return w}
function hist(v,n){const mn=Math.min(...v),mx=Math.max(...v),w=(mx-mn)/n||1,b=Array(n).fill(0),l=[];for(let i=0;i<n;i++)l.push((mn+w*(i+.5)).toFixed(2));v.forEach(x=>{let i=Math.floor((x-mn)/w);if(i>=n)i=n-1;if(i<0)i=0;b[i]++});return{b,l}}
const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// === KaTeX re-render on details toggle ===
document.addEventListener('toggle',e=>{
  if(e.target.tagName==='DETAILS'&&e.target.open&&typeof renderMathInElement==='function'){
    renderMathInElement(e.target,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]});
  }
},true);

// === Nav ===
const tnav=document.getElementById('tnav');
const _tabInited={};
function swTab(id){document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('on');t.style.display='none'});
  tnav.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
  const el=document.getElementById('t-'+id);if(el){el.classList.add('on');el.style.display='block'}
  const bt=tnav.querySelector(`[data-t="${id}"]`);if(bt)bt.classList.add('on');location.hash=id;
  // Lazy init for tabs that need visible container (canvas/chart sizing)
  requestAnimationFrame(()=>{
    if(id==='why'){
      if(!_tabInited.why){_tabInited.why=true;doWhyDist();doWhyRobust();doImageQuant();doMosaic();doTextQuant()}
      doWhyPipe();doDegradation()}
    if(id==='deep'){
      if(!_tabInited.deep){_tabInited.deep=true;initOutWeights();doPPL()}
      doOutlier();doNNWalk()}
  })}
tnav.addEventListener('click',e=>{if(e.target.dataset.t)swTab(e.target.dataset.t)});

function initSubTabs(navId,cls){
  document.getElementById(navId).addEventListener('click',e=>{
    if(!e.target.dataset.s)return;
    const p=e.target.closest('.tab')||e.target.parentElement.parentElement;
    p.querySelectorAll('.'+cls).forEach(s=>{s.style.display='none';s.classList.remove('on')});
    e.target.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('on'));
    e.target.classList.add('on');
    const s=document.getElementById('s-'+e.target.dataset.s);
    if(s){s.style.display='block';s.classList.add('on')}
  });
}
initSubTabs('pgSt','psub');initSubTabs('cSt','csub');
function handleHash(){swTab(location.hash.replace('#','')||'overview')}
window.addEventListener('hashchange',handleHash);

// === Bit Viz ===
function doBits(){
  const f=[{n:'FP32',s:1,e:8,m:23,d:'è¨“ç·´ã®æ¨™æº–ç²¾åº¦'},{n:'FP16',s:1,e:5,m:10,d:'æ¨è«–ã®æ¨™æº–'},
    {n:'INT8',s:1,e:0,m:7,d:'é«˜åŠ¹ç‡é‡å­åŒ–'},{n:'INT4',s:1,e:0,m:3,d:'æ¥µé™åœ§ç¸®'}];
  document.getElementById('bitViz').innerHTML=f.map(x=>{
    let bx='';for(let i=0;i<x.s;i++)bx+='<span class="bx s" title="ç¬¦å·"></span>';
    for(let i=0;i<x.e;i++)bx+='<span class="bx e" title="æŒ‡æ•°"></span>';
    for(let i=0;i<x.m;i++)bx+='<span class="bx m" title="ä»®æ•°/å€¤"></span>';
    const t=x.s+x.e+x.m;
    return`<div class="bit-row"><span class="bl">${x.n}</span><div class="bits">${bx}</div>
      <span class="bit-meta">${t}bit Â· ${x.e>0?`ç¬¦å·${x.s} æŒ‡æ•°${x.e} ä»®æ•°${x.m}`:`ç¬¦å·${x.s} å€¤${x.m}`} Â· ${x.d}</span></div>`;
  }).join('')}

// === Histogram ===
let hCh=null;
function doHist(){
  const n=+document.getElementById('hN').value,s=+document.getElementById('hS').value;
  document.getElementById('hNv').textContent=n;document.getElementById('hSv').textContent=s.toFixed(1);
  const w=genW(n,0,s),am=Math.max(...w.map(Math.abs)),o=hist(w,40);
  const h16=hist(w.map(v=>symQ(v,am,16).d),40),h8=hist(w.map(v=>symQ(v,am,8).d),40),h4=hist(w.map(v=>symQ(v,am,4).d),40);
  const cv=document.getElementById('histCv');
  if(typeof Chart!=='undefined'){
    if(hCh)hCh.destroy();
    hCh=new Chart(cv,{type:'bar',data:{labels:o.l,datasets:[
      {label:'FP32',data:o.b,backgroundColor:'rgba(200,210,220,.2)',borderColor:'rgba(200,210,220,.5)',borderWidth:1,order:4},
      {label:'FP16',data:h16.b,backgroundColor:'rgba(68,204,102,.15)',borderColor:'rgba(68,204,102,.6)',borderWidth:1,order:3},
      {label:'INT8',data:h8.b,backgroundColor:'rgba(255,170,51,.2)',borderColor:'rgba(255,170,51,.7)',borderWidth:1,order:2},
      {label:'INT4',data:h4.b,backgroundColor:'rgba(179,136,255,.2)',borderColor:'rgba(179,136,255,.7)',borderWidth:1,order:1}
    ]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:250},
      plugins:{legend:{labels:{color:'#b8c0d0',font:{size:12},padding:16}}},
      scales:{x:{ticks:{color:'#7888a0',maxTicksLimit:10,font:{size:10}},grid:{color:'#1a2030'}},
        y:{ticks:{color:'#7888a0',font:{size:10}},grid:{color:'#1a2030'}}}}});
  }
}
document.getElementById('hN').addEventListener('input',doHist);
document.getElementById('hS').addEventListener('input',doHist);

// === Error Scatter ===
function doErrScatter(){
  const N=+document.getElementById('esN').value;
  document.getElementById('esNv').textContent=N;
  const cv=document.getElementById('errScatter'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),m={l:55,r:20,t:20,b:40};
  const pW=W-m.l-m.r,pH=H-m.t-m.b;
  const w=genW(N,0,1),am=Math.max(...w.map(Math.abs))||1;
  const e8=w.map(v=>({v,e:symQ(v,am,8).e})),e4=w.map(v=>({v,e:symQ(v,am,4).e}));
  const maxE=Math.max(...e4.map(x=>x.e))||1;
  const xP=v=>m.l+((v+am)/(2*am))*pW, yP=e=>m.t+pH-(e/maxE)*pH;
  ctx.clearRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#1a2030';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(m.l,m.t+pH);ctx.lineTo(m.l+pW,m.t+pH);ctx.stroke();
  ctx.beginPath();ctx.moveTo(m.l,m.t);ctx.lineTo(m.l,m.t+pH);ctx.stroke();
  // Zero line
  ctx.strokeStyle='#2a3040';ctx.setLineDash([3,3]);
  ctx.beginPath();ctx.moveTo(xP(0),m.t);ctx.lineTo(xP(0),m.t+pH);ctx.stroke();ctx.setLineDash([]);
  // Y ticks
  ctx.fillStyle='#7888a0';ctx.font='9px sans-serif';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const eVal=maxE*i/4,py=yP(eVal);
    ctx.fillText(eVal.toFixed(3),m.l-5,py+3);
    ctx.strokeStyle='#1a2030';ctx.beginPath();ctx.moveTo(m.l,py);ctx.lineTo(m.l+pW,py);ctx.stroke()}
  // X ticks
  ctx.textAlign='center';
  for(let i=-2;i<=2;i++){const xVal=am*i/2,px=xP(xVal);
    if(px>=m.l&&px<=m.l+pW)ctx.fillText(xVal.toFixed(1),px,m.t+pH+14)}
  // INT4 dots (draw first, behind)
  e4.forEach(p=>{ctx.fillStyle='rgba(179,136,255,.4)';ctx.beginPath();ctx.arc(xP(p.v),yP(p.e),4,0,Math.PI*2);ctx.fill()});
  // INT8 dots
  e8.forEach(p=>{ctx.fillStyle='rgba(255,170,51,.5)';ctx.beginPath();ctx.arc(xP(p.v),yP(p.e),3,0,Math.PI*2);ctx.fill()});
  // Legend
  ctx.font='11px sans-serif';
  ctx.fillStyle='#ffaa33';ctx.fillText('â— INT8',m.l+60,m.t+14);
  ctx.fillStyle='#b388ff';ctx.fillText('â— INT4',m.l+130,m.t+14);
  // Axis labels
  ctx.fillStyle='#7888a0';ctx.font='10px sans-serif';ctx.textAlign='center';
  ctx.fillText('å…ƒã®å€¤',m.l+pW/2,H-4);
  ctx.save();ctx.translate(12,m.t+pH/2);ctx.rotate(-Math.PI/2);ctx.fillText('é‡å­åŒ–èª¤å·®',0,0);ctx.restore();
  // Stats
  const mean8=e8.reduce((s,x)=>s+x.e,0)/N,mean4=e4.reduce((s,x)=>s+x.e,0)/N;
  const max8=Math.max(...e8.map(x=>x.e)),max4=Math.max(...e4.map(x=>x.e));
  document.getElementById('esStats').innerHTML=
    `<span style="color:#ffaa33">INT8</span>: å¹³å‡èª¤å·® <strong>${mean8.toFixed(5)}</strong> / æœ€å¤§ <strong>${max8.toFixed(5)}</strong>&nbsp;&nbsp;&nbsp;`+
    `<span style="color:#b388ff">INT4</span>: å¹³å‡èª¤å·® <strong>${mean4.toFixed(5)}</strong> / æœ€å¤§ <strong>${max4.toFixed(5)}</strong>&nbsp;&nbsp;&nbsp;`+
    `<span style="color:#ffaa33">INT4ã¯INT8ã®ç´„ <strong>${(mean4/mean8).toFixed(1)}å€</strong> ã®èª¤å·®</span>`;
}
document.getElementById('esN').addEventListener('input',doErrScatter);

// === Snap Visualization ===
function doSnapViz(){
  const N=+document.getElementById('snapN').value;
  document.getElementById('snapNv').textContent=N;
  const cv=document.getElementById('snapCanvas'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d');
  const vals=genW(N,0,0.8);
  const am=Math.max(...vals.map(Math.abs))||1;
  const range=am*1.15;
  const mL=50,mR=20;const pW=W-mL-mR;
  const xP=v=>mL+((v+range)/(2*range))*pW;
  ctx.clearRect(0,0,W,H);

  [{bits:8,label:'INT8 (256æ®µéš)',y:55,col:'#ffaa33'},{bits:4,label:'INT4 (16æ®µéš)',y:185,col:'#b388ff'}].forEach(cfg=>{
    const Y=cfg.y;
    // Section label
    ctx.fillStyle=cfg.col;ctx.font='bold 11px sans-serif';ctx.textAlign='left';
    ctx.fillText(cfg.label,mL,Y-35);
    // Axis
    ctx.strokeStyle='#2a3040';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(mL,Y);ctx.lineTo(W-mR,Y);ctx.stroke();
    // Grid lines
    const qmax=(1<<(cfg.bits-1))-1,sc=am/qmax;
    ctx.strokeStyle='rgba('+( cfg.bits===8?'255,170,51':'179,136,255')+',.12)';
    for(let q=-qmax;q<=qmax;q++){const lv=q*sc;if(Math.abs(lv)<=range){
      const px=xP(lv);ctx.beginPath();ctx.moveTo(px,Y-18);ctx.lineTo(px,Y+18);ctx.stroke()}}
    // Zero
    ctx.strokeStyle='#556070';ctx.setLineDash([2,3]);
    ctx.beginPath();ctx.moveTo(xP(0),Y-22);ctx.lineTo(xP(0),Y+22);ctx.stroke();ctx.setLineDash([]);
    // Values with snap arrows
    vals.forEach(v=>{
      const r=symQ(v,am,cfg.bits);
      const ox=xP(v),qx=xP(r.d);
      // Arrow from original to quantized
      if(Math.abs(ox-qx)>1){
        ctx.strokeStyle='rgba(255,170,51,.5)';ctx.lineWidth=1.5;
        ctx.beginPath();ctx.moveTo(ox,Y-8);ctx.lineTo(qx,Y-8);ctx.stroke();
        // Arrowhead
        const dir=qx>ox?1:-1;
        ctx.beginPath();ctx.moveTo(qx,Y-8);ctx.lineTo(qx-dir*5,Y-12);ctx.lineTo(qx-dir*5,Y-4);ctx.closePath();ctx.fillStyle='rgba(255,170,51,.5)';ctx.fill()}
      // Original dot
      ctx.fillStyle='#4da6ff';ctx.beginPath();ctx.arc(ox,Y,5,0,Math.PI*2);ctx.fill();
      // Quantized dot
      ctx.fillStyle=cfg.col;ctx.beginPath();ctx.arc(qx,Y+1,4,0,Math.PI*2);ctx.fill();
    });
  });
  // Legend at bottom
  ctx.fillStyle='#7888a0';ctx.font='10px sans-serif';ctx.textAlign='left';
  ctx.fillStyle='#4da6ff';ctx.fillText('â— å…ƒã®å€¤',mL,H-8);
  ctx.fillStyle='#ffaa33';ctx.fillText('â— INT8é‡å­åŒ–å€¤',mL+75,H-8);
  ctx.fillStyle='#b388ff';ctx.fillText('â— INT4é‡å­åŒ–å€¤',mL+195,H-8);
  ctx.fillStyle='#ffaa33';ctx.fillText('â†’ ä¸¸ã‚æ–¹å‘(èª¤å·®)',mL+315,H-8);
}
document.getElementById('snapN').addEventListener('input',doSnapViz);

// === Vector Quantization 2D ===
function doVecQuant(){
  const bits=+document.getElementById('vqBits').value;
  const N=+document.getElementById('vqN').value;
  document.getElementById('vqNv').textContent=N;
  const cv=document.getElementById('vqCanvas'),fullW=cv.parentElement.clientWidth;
  cv.width=fullW;const H=cv.height,ctx=cv.getContext('2d');
  const halfW=Math.floor(fullW/2)-10;
  const divX=halfW+10; // divider x

  // Generate random 2D vectors
  const vecs=[];
  for(let i=0;i<N;i++){
    const x=(Math.random()*2-1)*0.9,y=(Math.random()*2-1)*0.9;
    vecs.push([x,y]);
  }
  const allVals=vecs.flat();
  const am=Math.max(...allVals.map(Math.abs))||1;

  // Quantize each component
  const qmax=(1<<(bits-1))-1;
  const sc=am/qmax;
  const qvecs=vecs.map(([vx,vy])=>{
    const qx=Math.max(-qmax,Math.min(qmax,Math.round(vx/sc)))*sc;
    const qy=Math.max(-qmax,Math.min(qmax,Math.round(vy/sc)))*sc;
    return[qx,qy];
  });

  // Compute sums
  const sumOrig=[0,0],sumQuant=[0,0];
  vecs.forEach(([vx,vy])=>{sumOrig[0]+=vx;sumOrig[1]+=vy});
  qvecs.forEach(([qx,qy])=>{sumQuant[0]+=qx;sumQuant[1]+=qy});

  ctx.clearRect(0,0,fullW,H);

  // ===== LEFT PANEL: Individual vectors =====
  const R1=Math.min(halfW,H)/2-40;
  const cx1=halfW/2,cy1=H/2;
  const scale1=R1/am;
  const toX1=v=>cx1+v*scale1,toY1=v=>cy1-v*scale1;

  // Section title
  ctx.fillStyle='#7888a0';ctx.font='bold 11px sans-serif';ctx.textAlign='center';
  ctx.fillText('å€‹åˆ¥ãƒ™ã‚¯ãƒˆãƒ«',cx1,16);

  // Grid
  ctx.save();ctx.beginPath();ctx.rect(0,0,halfW,H);ctx.clip();
  ctx.strokeStyle='rgba(77,166,255,.08)';ctx.lineWidth=0.5;
  for(let q=-qmax;q<=qmax;q++){
    const v=q*sc;
    const px=toX1(v),py=toY1(v);
    if(px>=cx1-R1-5&&px<=cx1+R1+5){ctx.beginPath();ctx.moveTo(px,cy1-R1);ctx.lineTo(px,cy1+R1);ctx.stroke();}
    if(py>=cy1-R1-5&&py<=cy1+R1+5){ctx.beginPath();ctx.moveTo(cx1-R1,py);ctx.lineTo(cx1+R1,py);ctx.stroke();}
  }
  if(bits<=4){
    ctx.fillStyle='rgba(77,166,255,.12)';
    for(let gx=-qmax;gx<=qmax;gx++)for(let gy=-qmax;gy<=qmax;gy++){
      const px=toX1(gx*sc),py=toY1(gy*sc);
      if(px>=cx1-R1&&px<=cx1+R1&&py>=cy1-R1&&py<=cy1+R1){
        ctx.beginPath();ctx.arc(px,py,1.5,0,Math.PI*2);ctx.fill();}
    }
  }
  // Axes
  ctx.strokeStyle='#3a4560';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cx1-R1-10,cy1);ctx.lineTo(cx1+R1+10,cy1);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx1,cy1-R1-10);ctx.lineTo(cx1,cy1+R1+10);ctx.stroke();

  // Draw individual vectors
  let totalAngle=0,totalNormErr=0,totalRelNorm=0;
  const colors=['#4da6ff','#44cc66','#ff6688','#ffcc44','#b388ff','#44ddcc','#ff9933','#88aaff',
    '#ff66aa','#66ffcc','#ccff44','#ff8844','#aa66ff','#66aaff','#ffaa66','#44ff88','#ff4466','#66ffaa','#ccaa44','#ff88cc'];

  vecs.forEach(([vx,vy],i)=>{
    const [qx,qy]=qvecs[i];
    const col=colors[i%colors.length];
    const ox=toX1(vx),oy=toY1(vy);
    const dx=toX1(qx),dy=toY1(qy);
    // Error dashed
    ctx.strokeStyle='rgba(255,170,51,.4)';ctx.lineWidth=1.2;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(dx,dy);ctx.stroke();ctx.setLineDash([]);
    // Angular error arc
    const origAng=Math.atan2(vy,vx),quantAng=Math.atan2(qy,qx),angDiff=quantAng-origAng;
    if(Math.abs(angDiff)>0.01){
      const arcR=Math.min(22,Math.sqrt((ox-cx1)**2+(oy-cy1)**2)*0.35);
      ctx.strokeStyle='rgba(255,170,51,.3)';ctx.lineWidth=1;ctx.fillStyle='rgba(255,170,51,.06)';
      ctx.beginPath();ctx.moveTo(cx1,cy1);ctx.arc(cx1,cy1,arcR,-origAng,-quantAng,angDiff>0);ctx.closePath();ctx.fill();ctx.stroke();}
    // Original arrow
    ctx.strokeStyle=col;ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(cx1,cy1);ctx.lineTo(ox,oy);ctx.stroke();
    const aLen=8,aAng=Math.atan2(cy1-oy,cx1-ox);
    ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(ox,oy);
    ctx.lineTo(ox+aLen*Math.cos(aAng+0.35),oy+aLen*Math.sin(aAng+0.35));
    ctx.lineTo(ox+aLen*Math.cos(aAng-0.35),oy+aLen*Math.sin(aAng-0.35));ctx.closePath();ctx.fill();
    // Quantized arrow (dashed + ring)
    ctx.strokeStyle=col;ctx.lineWidth=1;ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(cx1,cy1);ctx.lineTo(dx,dy);ctx.stroke();ctx.setLineDash([]);
    ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(dx,dy,3,0,Math.PI*2);ctx.stroke();
    // Collect stats
    const nO=Math.sqrt(vx*vx+vy*vy),nQ=Math.sqrt(qx*qx+qy*qy);
    const dot=vx*qx+vy*qy,cosA=nO>0&&nQ>0?dot/(nO*nQ):1;
    totalAngle+=Math.acos(Math.max(-1,Math.min(1,cosA)))*180/Math.PI;
    totalNormErr+=Math.abs(nO-nQ);if(nO>0)totalRelNorm+=Math.abs(nO-nQ)/nO;
  });
  ctx.restore();

  // ===== DIVIDER =====
  ctx.strokeStyle='#2a3040';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(divX,20);ctx.lineTo(divX,H-20);ctx.stroke();ctx.setLineDash([]);

  // ===== RIGHT PANEL: Vector sum =====
  const rOff=divX+10;
  const rW=fullW-rOff;
  const R2=Math.min(rW,H)/2-40;
  const cx2=rOff+rW/2,cy2=H/2;
  // Scale for the sum panel: based on max component of sums
  const sumAm=Math.max(Math.abs(sumOrig[0]),Math.abs(sumOrig[1]),Math.abs(sumQuant[0]),Math.abs(sumQuant[1]),0.01);
  const scale2=R2/sumAm;
  const toX2=v=>cx2+v*scale2,toY2=v=>cy2-v*scale2;

  // Section title
  ctx.fillStyle='#7888a0';ctx.font='bold 11px sans-serif';ctx.textAlign='center';
  ctx.fillText('ãƒ™ã‚¯ãƒˆãƒ«ã®åˆè¨ˆï¼ˆÎ£ï¼‰',cx2,16);

  ctx.save();ctx.beginPath();ctx.rect(rOff,0,rW,H);ctx.clip();

  // Axes
  ctx.strokeStyle='#3a4560';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cx2-R2-10,cy2);ctx.lineTo(cx2+R2+10,cy2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx2,cy2-R2-10);ctx.lineTo(cx2,cy2+R2+10);ctx.stroke();

  // Draw partial sums (accumulated path) for original
  let accX=0,accY=0;
  ctx.globalAlpha=0.25;
  vecs.forEach(([vx,vy],i)=>{
    const col=colors[i%colors.length];
    const fromPx=toX2(accX),fromPy=toY2(accY);
    accX+=vx;accY+=vy;
    const toPx=toX2(accX),toPy=toY2(accY);
    ctx.strokeStyle=col;ctx.lineWidth=1.5;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(fromPx,fromPy);ctx.lineTo(toPx,toPy);ctx.stroke();
  });
  // Partial sums for quantized
  let accQX=0,accQY=0;
  qvecs.forEach(([qx,qy],i)=>{
    const col=colors[i%colors.length];
    const fromPx=toX2(accQX),fromPy=toY2(accQY);
    accQX+=qx;accQY+=qy;
    const toPx=toX2(accQX),toPy=toY2(accQY);
    ctx.strokeStyle=col;ctx.lineWidth=1;ctx.setLineDash([3,2]);
    ctx.beginPath();ctx.moveTo(fromPx,fromPy);ctx.lineTo(toPx,toPy);ctx.stroke();ctx.setLineDash([]);
  });
  ctx.globalAlpha=1.0;

  // Sum original: thick arrow
  const sox=toX2(sumOrig[0]),soy=toY2(sumOrig[1]);
  ctx.strokeStyle='#4da6ff';ctx.lineWidth=3.5;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(cx2,cy2);ctx.lineTo(sox,soy);ctx.stroke();
  // Arrowhead
  const sAng=Math.atan2(cy2-soy,cx2-sox);
  ctx.fillStyle='#4da6ff';ctx.beginPath();ctx.moveTo(sox,soy);
  ctx.lineTo(sox+12*Math.cos(sAng+0.35),soy+12*Math.sin(sAng+0.35));
  ctx.lineTo(sox+12*Math.cos(sAng-0.35),soy+12*Math.sin(sAng-0.35));ctx.closePath();ctx.fill();

  // Sum quantized: thick dashed arrow
  const sqx=toX2(sumQuant[0]),sqy=toY2(sumQuant[1]);
  ctx.strokeStyle='#ff5555';ctx.lineWidth=3;ctx.setLineDash([6,4]);
  ctx.beginPath();ctx.moveTo(cx2,cy2);ctx.lineTo(sqx,sqy);ctx.stroke();ctx.setLineDash([]);
  // Ring tip
  ctx.strokeStyle='#ff5555';ctx.lineWidth=2.5;
  ctx.beginPath();ctx.arc(sqx,sqy,5,0,Math.PI*2);ctx.stroke();

  // Error vector between sum tips
  ctx.strokeStyle='#ffaa33';ctx.lineWidth=2;ctx.setLineDash([4,3]);
  ctx.beginPath();ctx.moveTo(sox,soy);ctx.lineTo(sqx,sqy);ctx.stroke();ctx.setLineDash([]);
  // Error label
  const errNorm=Math.sqrt((sumOrig[0]-sumQuant[0])**2+(sumOrig[1]-sumQuant[1])**2);
  const eLabelX=(sox+sqx)/2,eLabelY=(soy+sqy)/2-10;
  ctx.fillStyle='#ffaa33';ctx.font='bold 10px sans-serif';ctx.textAlign='center';
  ctx.fillText('Î£e = '+errNorm.toFixed(3),eLabelX,eLabelY);

  // Angular error arc for sum
  const sumOrigAng=Math.atan2(sumOrig[1],sumOrig[0]);
  const sumQuantAng=Math.atan2(sumQuant[1],sumQuant[0]);
  const sumAngDiff=sumQuantAng-sumOrigAng;
  if(Math.abs(sumAngDiff)>0.005){
    const arcR2=Math.min(40,Math.sqrt((sox-cx2)**2+(soy-cy2)**2)*0.3);
    ctx.strokeStyle='rgba(255,170,51,.5)';ctx.lineWidth=1.5;ctx.fillStyle='rgba(255,170,51,.1)';
    ctx.beginPath();ctx.moveTo(cx2,cy2);ctx.arc(cx2,cy2,arcR2,-sumOrigAng,-sumQuantAng,sumAngDiff>0);ctx.closePath();ctx.fill();ctx.stroke();
  }

  // Labels for sum vectors
  ctx.font='10px sans-serif';ctx.textAlign='left';
  ctx.fillStyle='#4da6ff';ctx.fillText('Î£w (å…ƒ)',sox+8,soy-4);
  ctx.fillStyle='#ff5555';ctx.fillText('Î£Q(w)',sqx+8,sqy+12);

  ctx.restore();

  // ===== LEGEND (bottom) =====
  ctx.font='10px sans-serif';ctx.textAlign='left';
  const ly=H-8;
  ctx.fillStyle='#4da6ff';ctx.fillText('â†’ å…ƒï¼ˆå®Ÿç·šï¼‰',8,ly);
  ctx.fillStyle='#7888a0';ctx.fillText('â—‹ é‡å­åŒ–ï¼ˆç ´ç·šï¼‰',110,ly);
  ctx.fillStyle='#ffaa33';ctx.fillText('--- èª¤å·®',240,ly);
  ctx.fillStyle='#4da6ff';ctx.fillText('Î£w åˆè¨ˆï¼ˆé’å¤ªï¼‰',310,ly);
  ctx.fillStyle='#ff5555';ctx.fillText('Î£Q(w) é‡å­åŒ–åˆè¨ˆï¼ˆèµ¤ç ´ç·šï¼‰',440,ly);

  // ===== STATS =====
  const sumNormOrig=Math.sqrt(sumOrig[0]**2+sumOrig[1]**2);
  const sumNormQuant=Math.sqrt(sumQuant[0]**2+sumQuant[1]**2);
  const sumDot=sumOrig[0]*sumQuant[0]+sumOrig[1]*sumQuant[1];
  const sumCosA=sumNormOrig>0&&sumNormQuant>0?sumDot/(sumNormOrig*sumNormQuant):1;
  const sumAngleErr=Math.acos(Math.max(-1,Math.min(1,sumCosA)))*180/Math.PI;
  const avgIndivErr=vecs.reduce((s,[vx,vy],i)=>{
    const [qx,qy]=qvecs[i];return s+Math.sqrt((vx-qx)**2+(vy-qy)**2);},0)/N;

  document.getElementById('vqStats').innerHTML=
    `<strong>INT${bits}</strong>: æ ¼å­ ${(2*qmax+1)}Ã—${(2*qmax+1)} = <strong>${(2*qmax+1)*(2*qmax+1)}</strong>ç‚¹ / scale = <strong>${sc.toFixed(4)}</strong><br>`+
    `<strong>å€‹åˆ¥</strong>: å¹³å‡è§’åº¦èª¤å·® <strong style="color:var(--orange)">${(totalAngle/N).toFixed(2)}Â°</strong> / å¹³å‡â€–eâ€– = <strong>${avgIndivErr.toFixed(4)}</strong><br>`+
    `<strong>åˆè¨ˆ Î£</strong>: â€–Î£wâ€– = ${sumNormOrig.toFixed(3)}, â€–Î£Q(w)â€– = ${sumNormQuant.toFixed(3)} / `+
    `<strong style="color:var(--orange)">è§’åº¦èª¤å·® ${sumAngleErr.toFixed(2)}Â°</strong> / `+
    `<strong>â€–Î£eâ€– = ${errNorm.toFixed(4)}</strong>`+
    ` (å€‹åˆ¥å¹³å‡ã® <strong>${(errNorm/avgIndivErr).toFixed(1)}å€</strong> â€” `+
    (errNorm < avgIndivErr*N*0.7?`<span style="color:var(--green)">èª¤å·®ãŒç›¸æ®º</span>)`:`<span style="color:var(--orange)">èª¤å·®ãŒè“„ç©</span>)`);
}
document.getElementById('vqBits').addEventListener('change',doVecQuant);
document.getElementById('vqN').addEventListener('input',function(){document.getElementById('vqNv').textContent=this.value;doVecQuant()});

// === Tradeoff ===
function doTradeoff(){
  const B=+document.getElementById('mSz').value||7,mx=B*4;
  const c=[{n:'FP32',b:32,t:'t0',sp:'1.0Ã—',q:'åŸºæº–(100%)',d:'è¨“ç·´ç²¾åº¦ã€‚æœ€ã‚‚æ­£ç¢º'},{n:'FP16',b:16,t:'t1',sp:'~2Ã—',q:'â‰ˆ99.9%',d:'æ¨è«–ã®æ¨™æº–ã€‚åŠ£åŒ–ãªã—'},
    {n:'INT8',b:8,t:'t2',sp:'~3Ã—',q:'â‰ˆ99%',d:'é«˜åŠ¹ç‡ã€‚ã»ã¼å“è³ªç¶­æŒ'},{n:'INT4',b:4,t:'t3',sp:'~4Ã—',q:'â‰ˆ95%',d:'æ¥µé™åœ§ç¸®ã€‚æ‰‹æ³•æ¬¡ç¬¬'}];
  const cols={t0:'#7888a0',t1:'#44cc66',t2:'#ffaa33',t3:'#b388ff'};
  document.getElementById('tfCards').innerHTML=c.map(x=>{
    const m=(B*x.b/8).toFixed(1),p=(B*x.b/8)/mx*100;
    return`<div class="mc ${x.t}"><div class="mt">${x.n} (${x.b}bit)</div><div class="mv">${m}GB</div>
      <div class="bar"><div style="width:${p}%;background:${cols[x.t]}"></div></div>
      <div class="md">é€Ÿåº¦: <strong>${x.sp}</strong><br>å“è³ª: <strong>${x.q}</strong><br>${x.d}</div></div>`}).join('')}

// === Symmetric ===
let symDrag=false;
function doSym(){
  const v=+document.getElementById('sV').value,a=+document.getElementById('sA').value,b=+document.getElementById('sB').value;
  const r=symQ(v,a,b);
  document.getElementById('sSteps').innerHTML=`
    <li>å…¥åŠ›: value=${v}, absMax=${a}, bits=${b}<span class="d">é‡å­åŒ–å¯¾è±¡ã®å€¤ã¨ç¯„å›²ã‚’è¨­å®š</span></li>
    <li>qmax = 2^(${b}-1)-1 = <strong>${r.q}</strong><span class="d">æ•´æ•°ã®æœ€å¤§å€¤ã€‚[-${r.q}, +${r.q}] ã®ç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°</span></li>
    <li>scale = ${a}/${r.q} = <strong>${r.s.toFixed(6)}</strong><span class="d">é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ã®é–“éš”ã€‚ã“ã‚Œã‚ˆã‚Šç´°ã‹ã„å·®ã¯æ¶ˆãˆã‚‹</span></li>
    <li>round(${v}/${r.s.toFixed(6)}) = round(${(v/r.s).toFixed(3)}) = <strong>${r.r}</strong><span class="d">ã“ã“ã§ä¸¸ã‚(round)ãŒç™ºç”Ÿ â†’ æƒ…å ±æå¤±ã®ç¬é–“</span></li>
    <li>clamp(${r.r}, -${r.q}..${r.q}) = <strong>${r.c}</strong><span class="d">ç¯„å›²å¤–ãªã‚‰åˆ‡ã‚Šè©°ã‚</span></li>
    <li class="ok">é€†é‡å­åŒ–: ${r.c} Ã— ${r.s.toFixed(6)} = <strong>${r.d.toFixed(6)}</strong><span class="d">æ•´æ•°â†’å®Ÿæ•°ã«å¾©å…ƒã€‚ã“ã‚ŒãŒæœ€çµ‚çš„ãªè¿‘ä¼¼å€¤</span></li>
    <li class="${r.e>0.01?'ng':'ok'}">èª¤å·®: |${v} - ${r.d.toFixed(6)}| = <strong>${r.e.toFixed(6)}</strong><span class="d">${r.e<0.001?'æ¥µã‚ã¦å°ã•ã„èª¤å·®':r.e<0.05?'å®Ÿç”¨ä¸Šå•é¡Œãªã„ãƒ¬ãƒ™ãƒ«':'ãƒ“ãƒƒãƒˆå¹…ä¸è¶³ã€‚ç²¾åº¦è¦ç¢ºèª'}</span></li>`;
  drawSNL(v,r,a);
}

function drawSNL(v,r,a){
  const cv=document.getElementById('sNL'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),M=55,Y=H*.48,rng=a*1.2;
  const x=val=>M+(val+rng)/(2*rng)*(W-2*M);
  ctx.clearRect(0,0,W,H);
  // axis
  ctx.strokeStyle='#2a3040';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(M,Y);ctx.lineTo(W-M,Y);ctx.stroke();
  // levels
  for(let q=-r.q;q<=r.q;q++){const lv=q*r.s;if(Math.abs(lv)<=rng){const px=x(lv);
    ctx.strokeStyle='#2a304066';ctx.beginPath();ctx.moveTo(px,Y-12);ctx.lineTo(px,Y+12);ctx.stroke()}}
  // zero
  ctx.strokeStyle='#556070';ctx.setLineDash([2,3]);ctx.beginPath();ctx.moveTo(x(0),Y-22);ctx.lineTo(x(0),Y+22);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='#556070';ctx.font='11px sans-serif';ctx.textAlign='center';ctx.fillText('0',x(0),Y+36);
  // error
  const ox=x(v),qx=x(r.d);
  if(Math.abs(ox-qx)>1){ctx.strokeStyle='rgba(255,170,51,.5)';ctx.lineWidth=2;ctx.setLineDash([5,3]);
    ctx.beginPath();ctx.moveTo(ox,Y-18);ctx.lineTo(qx,Y-18);ctx.stroke();ctx.setLineDash([]);
    ctx.fillStyle='#ffaa33';ctx.font='10px sans-serif';ctx.fillText(`èª¤å·®:${r.e.toFixed(4)}`,(ox+qx)/2,Y-24)}
  // original
  ctx.fillStyle='#4da6ff';ctx.beginPath();ctx.arc(ox,Y,8,0,Math.PI*2);ctx.fill();
  ctx.font='11px sans-serif';ctx.fillText(`å…ƒ:${v}`,ox,Y-34);
  // quantized
  ctx.fillStyle='#ff5555';ctx.beginPath();ctx.arc(qx,Y,8,0,Math.PI*2);ctx.fill();
  ctx.fillText(`é‡å­åŒ–:${r.d.toFixed(4)}`,qx,Y+38);
  // range
  ctx.fillStyle='#556070';ctx.font='9px sans-serif';ctx.textAlign='left';ctx.fillText(`-${a}`,M,Y+36);
  ctx.textAlign='right';ctx.fillText(`+${a}`,W-M,Y+36);
}
// Drag on number line
(function(){
  const cv=document.getElementById('sNL');
  function getVal(e){const r=cv.getBoundingClientRect(),px=e.clientX-r.left,M=55,W=cv.width;
    const a=+document.getElementById('sA').value,rng=a*1.2;
    return((px-M)/(W-2*M)*2*rng-rng)}
  cv.addEventListener('mousedown',e=>{symDrag=true;const v=getVal(e);
    document.getElementById('sV').value=v.toFixed(2);doSym()});
  cv.addEventListener('mousemove',e=>{if(!symDrag)return;const v=getVal(e);
    document.getElementById('sV').value=v.toFixed(2);doSym()});
  window.addEventListener('mouseup',()=>symDrag=false);
})();
document.getElementById('sB').addEventListener('change',doSym);

// === Asymmetric ===
function doAsym(){
  const v=+document.getElementById('aV').value,mn=+document.getElementById('aMn').value,mx=+document.getElementById('aMx').value,b=+document.getElementById('aB').value;
  const r=asymQ(v,mn,mx,b);
  document.getElementById('aSteps').innerHTML=`
    <li>å…¥åŠ›: value=${v}, min=${mn}, max=${mx}, bits=${b}<span class="d">å®Ÿéš›ã®é‡ã¿ã®æœ€å°ãƒ»æœ€å¤§å€¤ã‚’ä½¿ç”¨</span></li>
    <li>qmax = 2^${b}-1 = <strong>${r.qx}</strong><span class="d">[0, ${r.qx}]ã®ç¬¦å·ãªã—æ•´æ•°ç¯„å›²</span></li>
    <li>scale = (${mx}-(${mn}))/${r.qx} = <strong>${r.s.toFixed(6)}</strong><span class="d">é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰é–“éš”</span></li>
    <li>zero_point = round(${(-mn/r.s).toFixed(3)}) = <strong>${r.z}</strong><span class="d">å®Ÿæ•°ã®0ã«å¯¾å¿œã™ã‚‹æ•´æ•°å€¤ã€‚éå¯¾ç§°é‡å­åŒ–ã®æ ¸å¿ƒ</span></li>
    <li>round(${v}/${r.s.toFixed(6)}+${r.z}) = <strong>${r.r}</strong></li>
    <li>clamp(0,${r.qx}): <strong>${r.c}</strong></li>
    <li class="ok">é€†é‡å­åŒ–: (${r.c}-${r.z})Ã—${r.s.toFixed(6)} = <strong>${r.d.toFixed(6)}</strong></li>
    <li class="${r.e>0.01?'ng':'ok'}">èª¤å·® = <strong>${r.e.toFixed(6)}</strong></li>`;
  drawANL(v,mn,mx,r,b);
}
function drawANL(v,mn,mx,r,b){
  const cv=document.getElementById('aNL'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),M=60,rng=Math.max(Math.abs(mn),Math.abs(mx))*1.3;
  const x=val=>M+(val+rng)/(2*rng)*(W-2*M);
  const am=Math.max(Math.abs(mn),Math.abs(mx)),sR=symQ(v,am,b),y1=45,y2=120;
  ctx.clearRect(0,0,W,H);
  [y1,y2].forEach(ly=>{ctx.strokeStyle='#2a3040';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(M,ly);ctx.lineTo(W-M,ly);ctx.stroke()});
  ctx.fillStyle='#556070';ctx.font='11px sans-serif';ctx.textAlign='left';
  ctx.fillText('å¯¾ç§°',4,y1+4);ctx.fillText('éå¯¾ç§°',4,y2+4);
  for(let q=-sR.q;q<=sR.q;q++){const lv=q*sR.s;if(Math.abs(lv)<=rng){ctx.strokeStyle='#2a304044';ctx.beginPath();ctx.moveTo(x(lv),y1-7);ctx.lineTo(x(lv),y1+7);ctx.stroke()}}
  for(let q=0;q<=r.qx;q++){const lv=(q-r.z)*r.s;if(Math.abs(lv)<=rng){ctx.strokeStyle='#2a304044';ctx.beginPath();ctx.moveTo(x(lv),y2-7);ctx.lineTo(x(lv),y2+7);ctx.stroke()}}
  const ox=x(v);
  ctx.fillStyle='#4da6ff';ctx.beginPath();ctx.arc(ox,y1,5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(ox,y2,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#ff5555';ctx.beginPath();ctx.arc(x(sR.d),y1,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#44cc66';ctx.beginPath();ctx.arc(x(r.d),y2,5,0,Math.PI*2);ctx.fill();
  ctx.textAlign='center';ctx.font='10px sans-serif';
  ctx.fillStyle='#ff5555';ctx.fillText(`èª¤å·®:${sR.e.toFixed(5)}`,x(sR.d),y1-12);
  ctx.fillStyle='#44cc66';ctx.fillText(`èª¤å·®:${r.e.toFixed(5)}`,x(r.d),y2-12);
  ctx.strokeStyle='rgba(255,170,51,.3)';ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(x(0),y2-16);ctx.lineTo(x(0),y2+16);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='#ffaa33';ctx.font='9px sans-serif';ctx.fillText(`ZP=${r.z}`,x(0),y2+30);
}

// === Block ===
function doBlock(){
  const bs=+document.getElementById('bSz').value,b=+document.getElementById('bB').value,w=genW(32,0,1);
  const am=Math.max(...w.map(Math.abs)),tQ=w.map(v=>{const r=symQ(v,am,b);return{o:v,d:r.d,e:r.e}});
  const bQ=blkQ(w,bs,b);
  const tM=tQ.reduce((s,q)=>s+q.e**2,0)/tQ.length,bM=bQ.reduce((s,q)=>s+q.e**2,0)/bQ.length;
  const tA=tQ.reduce((s,q)=>s+q.e,0)/tQ.length,bA=bQ.reduce((s,q)=>s+q.e,0)/bQ.length;
  drawBC('bTC',w,tQ,bs,'#ffaa33');drawBC('bBC',w,bQ,bs,'#44cc66');
  const imp=tM>0?((1-bM/tM)*100).toFixed(1):0;
  document.getElementById('bTE').innerHTML=`MSE:<strong>${tM.toFixed(6)}</strong> MAE:<strong>${tA.toFixed(6)}</strong>`;
  document.getElementById('bBE').innerHTML=`MSE:<strong style="color:var(--green)">${bM.toFixed(6)}</strong> MAE:<strong style="color:var(--green)">${bA.toFixed(6)}</strong> <span style="color:var(--green);font-size:.82rem">(${imp}%æ”¹å–„)</span>`;
}
function drawBC(id,orig,quant,bs,col){
  const cv=document.getElementById(id),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),m={l:40,r:15,t:15,b:30};
  const pW=W-m.l-m.r,pH=H-m.t-m.b,ma=Math.max(...orig.map(Math.abs))*1.2;
  const xP=i=>m.l+(i/(orig.length-1))*pW,yP=v=>m.t+pH/2-(v/ma)*(pH/2);
  ctx.clearRect(0,0,W,H);
  // block seps
  ctx.strokeStyle='#ffffff08';for(let i=bs;i<orig.length;i+=bs){const bx=xP(i-.5);ctx.beginPath();ctx.moveTo(bx,m.t);ctx.lineTo(bx,H-m.b);ctx.stroke()}
  ctx.strokeStyle='#1a2030';ctx.beginPath();ctx.moveTo(m.l,yP(0));ctx.lineTo(W-m.r,yP(0));ctx.stroke();
  // error bars
  quant.forEach((q,i)=>{ctx.strokeStyle='rgba(255,170,51,.25)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(xP(i),yP(q.o));ctx.lineTo(xP(i),yP(q.d));ctx.stroke()});
  // lines
  ctx.strokeStyle='#4da6ff';ctx.lineWidth=2;ctx.beginPath();orig.forEach((w,i)=>{i===0?ctx.moveTo(xP(i),yP(w)):ctx.lineTo(xP(i),yP(w))});ctx.stroke();
  ctx.strokeStyle=col;ctx.lineWidth=2;ctx.beginPath();quant.forEach((q,i)=>{i===0?ctx.moveTo(xP(i),yP(q.d)):ctx.lineTo(xP(i),yP(q.d))});ctx.stroke();
  // dots
  orig.forEach((w,i)=>{ctx.fillStyle='#4da6ff';ctx.beginPath();ctx.arc(xP(i),yP(w),3,0,Math.PI*2);ctx.fill()});
  quant.forEach((q,i)=>{ctx.fillStyle=col;ctx.beginPath();ctx.arc(xP(i),yP(q.d),3,0,Math.PI*2);ctx.fill()});
  ctx.fillStyle='#556070';ctx.font='10px sans-serif';ctx.textAlign='left';
  ctx.fillStyle='#4da6ff';ctx.fillText('â— å…ƒ',m.l+5,H-6);ctx.fillStyle=col;ctx.fillText('â— é‡å­åŒ–',m.l+50,H-6);
}

// === Tab3 Data ===
const MT=['FP16','INT8','INT4','GPTQ','AWQ','GGUF Q4_K_M'];
const CD=[
  {cat:'äº‹å®Ÿè³ªå•',pr:'æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿãã®æ­´å²çš„èƒŒæ™¯ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚',rs:{'FP16':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚794å¹´ã«å¹³å®‰äº¬ï¼ˆäº¬éƒ½ï¼‰ãŒé¦–éƒ½ã¨ãªã‚Šã€1868å¹´ã®æ˜æ²»ç¶­æ–°ã§æ±äº¬ã«é·éƒ½ã•ã‚Œã¾ã—ãŸã€‚æ±Ÿæˆ¸å¹•åºœã®æ‰€åœ¨åœ°ã§ã‚ã£ãŸæ±Ÿæˆ¸ãŒæ±äº¬ã¨æ”¹åã•ã‚Œã€å¤©çš‡ã®å±…æ‰€ã¨ãªã‚Šã¾ã—ãŸã€‚','INT8':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚794å¹´ã«äº¬éƒ½ãŒé¦–éƒ½ã¨ãªã‚Šã€1868å¹´ã®æ˜æ²»ç¶­æ–°ã§æ±äº¬ã«é·éƒ½ã•ã‚Œã¾ã—ãŸã€‚æ±Ÿæˆ¸ãŒæ±äº¬ã¨æ”¹åã•ã‚Œã€å¤©çš‡ã®å±…æ‰€ã¨ãªã‚Šã¾ã—ãŸã€‚','INT4':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚æ˜æ²»ç¶­æ–°ã§äº¬éƒ½ã‹ã‚‰æ±äº¬ã«é·éƒ½ã—ã¾ã—ãŸã€‚æ±Ÿæˆ¸æ™‚ä»£ã®åæ®‹ã‚Šã§æ±äº¬ãŒé¦–éƒ½ã«ãªã‚Šã¾ã—ãŸã€‚','GPTQ':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚794å¹´ã«å¹³å®‰äº¬ãŒé¦–éƒ½ã¨ãªã‚Šã€1868å¹´ã®æ˜æ²»ç¶­æ–°ã‚’çµŒã¦æ±äº¬ã«é·éƒ½ã•ã‚Œã¾ã—ãŸã€‚æ”¿æ²»ãƒ»çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã¨ã—ã¦ç™ºå±•ã—ã¦ã„ã¾ã™ã€‚','AWQ':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚æ­´å²çš„ã«ã¯äº¬éƒ½ãŒé•·ãé¦–éƒ½ã§ã—ãŸãŒã€1868å¹´ã«æ±äº¬ã¸é·éƒ½ã•ã‚Œã¾ã—ãŸã€‚æ±Ÿæˆ¸å¹•åºœã®æ”¿æ²»åŸºç›¤ãŒã‚ã£ãŸåœ°ã§ã€è¿‘ä»£åŒ–ã®è±¡å¾´ã¨ãªã‚Šã¾ã—ãŸã€‚','GGUF Q4_K_M':'æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚æ˜æ²»ç¶­æ–°ï¼ˆ1868å¹´ï¼‰ã«äº¬éƒ½ã‹ã‚‰é·éƒ½ã€‚æ±Ÿæˆ¸ãŒæ±äº¬ã«æ”¹åã•ã‚Œã€ä»¥é™æ—¥æœ¬ã®æ”¿æ²»çµŒæ¸ˆã®ä¸­å¿ƒã§ã™ã€‚'},rt:{'FP16':5,'INT8':4,'INT4':3,'GPTQ':4,'AWQ':5,'GGUF Q4_K_M':3}},
  {cat:'æ¨è«–',pr:'ãƒˆãƒ­ãƒƒã‚³å•é¡Œã«ã¤ã„ã¦ã€åŠŸåˆ©ä¸»ç¾©ã¨ã‚«ãƒ³ãƒˆå€«ç†å­¦ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ã€‚',rs:{'FP16':'åŠŸåˆ©ä¸»ç¾©ã®è¦³ç‚¹ã§ã¯ã€5äººã‚’æ•‘ã†ãŸã‚ã«ãƒ¬ãƒãƒ¼ã‚’å¼•ãã¹ãã§ã™ã€‚ãƒ™ãƒ³ã‚µãƒ ã®ã€Œæœ€å¤§å¤šæ•°ã®æœ€å¤§å¹¸ç¦ã€åŸç†ã«å¾“ãˆã°ã€1äººã®çŠ ç‰²ã§5äººãŒåŠ©ã‹ã‚‹çµæœãŒé“å¾³çš„ã«æ­£å½“åŒ–ã•ã‚Œã¾ã™ã€‚ä¸€æ–¹ã€ã‚«ãƒ³ãƒˆå€«ç†å­¦ã§ã¯ã€äººã‚’æ‰‹æ®µã¨ã—ã¦æ‰±ã†ã“ã¨ã¯å®šè¨€å‘½æ³•ã«åã—ã¾ã™ã€‚','INT8':'åŠŸåˆ©ä¸»ç¾©ã§ã¯5äººã‚’æ•‘ã†ãŸã‚ãƒ¬ãƒãƒ¼ã‚’å¼•ãã¹ãã¨ã•ã‚Œã¾ã™ã€‚æœ€å¤§å¤šæ•°ã®æœ€å¤§å¹¸ç¦ã®åŸç†ã§ã™ã€‚ã‚«ãƒ³ãƒˆå€«ç†å­¦ã§ã¯äººã‚’æ‰‹æ®µã¨ã—ã¦æ‰±ã†ã“ã¨ã¯è¨±ã•ã‚Œãšã€å®šè¨€å‘½æ³•ã«åã—ã¾ã™ã€‚','INT4':'åŠŸåˆ©ä¸»ç¾©ï¼šå¤šãã®äººã‚’æ•‘ã†ã¹ãã€‚ã‚«ãƒ³ãƒˆï¼šäººã‚’æ‰‹æ®µã«ã—ã¦ã¯ã„ã‘ãªã„ã€‚å“²å­¦çš„ã«ç­”ãˆãŒå‡ºãªã„å•é¡Œã§ã™ã€‚','GPTQ':'åŠŸåˆ©ä¸»ç¾©ã®ç«‹å ´ã‹ã‚‰ã¯ã€5äººã‚’æ•‘ã†é¸æŠãŒåˆç†çš„ã§ã™ã€‚ã‚«ãƒ³ãƒˆå€«ç†å­¦ã§ã¯ã€å®šè¨€å‘½æ³•ã«ã‚ˆã‚Šäººã‚’å˜ãªã‚‹æ‰‹æ®µã«ã™ã‚‹ã“ã¨ã‚’ç¦ã˜ã¦ã„ã¾ã™ã€‚','AWQ':'åŠŸåˆ©ä¸»ç¾©ã§ã¯çµæœã‚’é‡è¦–ã—ã€5äººã®å‘½ã‚’æ•‘ã†ãŸã‚ã«ãƒ¬ãƒãƒ¼ã‚’å¼•ãã“ã¨ãŒæ­£å½“åŒ–ã•ã‚Œã¾ã™ã€‚ã‚«ãƒ³ãƒˆå€«ç†å­¦ã§ã¯è¡Œç‚ºã®æ™®éåŒ–å¯èƒ½æ€§ã‚’å•ã„ã€äººã‚’æ‰‹æ®µã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ç¦ã˜ã¾ã™ã€‚','GGUF Q4_K_M':'åŠŸåˆ©ä¸»ç¾©ã¯çµæœé‡è¦–ã§5äººã‚’æ•‘ã†é¸æŠã‚’æ”¯æŒã€‚ã‚«ãƒ³ãƒˆå€«ç†å­¦ã¯äººã®å°Šå³ã‚’é‡è¦–ã—ã€çŠ ç‰²ã‚’æ­£å½“åŒ–ã—ã¾ã›ã‚“ã€‚'},rt:{'FP16':5,'INT8':4,'INT4':2,'GPTQ':4,'AWQ':5,'GGUF Q4_K_M':3}},
  {cat:'å‰µä½œ',pr:'æ¡œã®èŠ±ã³ã‚‰ãŒæ•£ã‚‹æ˜¥ã®åˆå¾Œã‚’èˆå°ã«çŸ­ç·¨ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚',rs:{'FP16':'æ¡œå¹é›ªã®ä¸­ã€è€äººã¯ãƒ™ãƒ³ãƒã«åº§ã‚Šã€äº¡ãå¦»ãŒå¥½ãã ã£ãŸèŠ±ã³ã‚‰ã‚’æŒã§å—ã‘ãŸã€‚ã€Œã¾ãŸæ¥å¹´ã‚‚ã€â€”â€”é¢¨ãŒè¨€è‘‰ã‚’é‹ã‚“ã ã€‚','INT8':'æ¡œãŒèˆã†å…¬åœ’ã§ã€è€äººã¯å¦»ã‚’æ€ã„å‡ºã—ãŸã€‚æ‰‹ã®ã²ã‚‰ã«èŠ±ã³ã‚‰ãŒè½ã¡ã‚‹ã€‚ã€Œã¾ãŸæ¥å¹´ã€ã¨é¢¨ãŒå›ã„ãŸã€‚','INT4':'æ¡œãŒæ•£ã‚‹å…¬åœ’ã§è€äººãŒåº§ã£ã¦ã„ã‚‹ã€‚èŠ±ã³ã‚‰ãŒæ‰‹ã«è½ã¡ãŸã€‚æ˜¥ã®åˆå¾Œã ã£ãŸã€‚','GPTQ':'æ¡œå¹é›ªã®ä¸‹ã€ãƒ™ãƒ³ãƒã®è€äººã¯æŒã«èŠ±ã³ã‚‰ã‚’å—ã‘ãŸã€‚å¦»ã¨ã®è¨˜æ†¶ãŒè˜‡ã‚‹ã€‚ã€Œæ¥å¹´ã‚‚è¦‹ã‚ˆã†ã€ã¨ç©ºã«å‘Ÿã„ãŸã€‚','AWQ':'é¢¨ã«èˆã†æ¡œã®ä¸‹ã€è€äººã¯é™ã‹ã«ç›®ã‚’é–‰ã˜ãŸã€‚èŠ±ã³ã‚‰ãŒé ¬ã‚’æ’«ã§ã‚‹â€”â€”å¦»ã®æŒ‡å…ˆã®ã‚ˆã†ã«ã€‚ã€Œã‚ã‚ŠãŒã¨ã†ã€å£°ã«ãªã‚‰ãªã„å£°ã€‚','GGUF Q4_K_M':'å…¬åœ’ã®ãƒ™ãƒ³ãƒã«åº§ã‚‹è€äººã€‚æ¡œã®èŠ±ã³ã‚‰ãŒè‚©ã«è½ã¡ã‚‹ã€‚éš£ã®ç©ºå¸­ã‚’è¦‹ã¤ã‚ã€å¾®ç¬‘ã‚“ã ã€‚'},rt:{'FP16':5,'INT8':4,'INT4':2,'GPTQ':4,'AWQ':5,'GGUF Q4_K_M':3}},
  {cat:'ã‚³ãƒ¼ãƒ‰',pr:'Pythonã§ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—ã‚’ãƒ¡ãƒ¢åŒ–ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚',rs:{'FP16':'from functools import lru_cache\n\n@lru_cache(maxsize=None)\ndef fib(n):\n    if n < 2: return n\n    return fib(n-1) + fib(n-2)\n\nfor i in range(10): print(fib(i), end=" ")','INT8':'from functools import lru_cache\n\n@lru_cache(maxsize=None)\ndef fib(n):\n    if n < 2: return n\n    return fib(n-1) + fib(n-2)\n\nprint([fib(i) for i in range(10)])','INT4':'def fib(n, memo={}):\n    if n in memo: return memo[n]\n    if n < 2: return n\n    memo[n] = fib(n-1) + fib(n-2)\n    return memo[n]','GPTQ':'from functools import lru_cache\n\n@lru_cache(maxsize=None)\ndef fibonacci(n: int) -> int:\n    if n < 2: return n\n    return fibonacci(n-1) + fibonacci(n-2)\n\nprint([fibonacci(i) for i in range(10)])','AWQ':'from functools import lru_cache\n\n@lru_cache(maxsize=None)\ndef fib(n: int) -> int:\n    """ãƒ¡ãƒ¢åŒ–ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ"""\n    if n < 2: return n\n    return fib(n-1) + fib(n-2)\n\nprint([fib(i) for i in range(10)])','GGUF Q4_K_M':'def fib(n, memo={}):\n    if n < 2: return n\n    if n not in memo:\n        memo[n] = fib(n-1)+fib(n-2)\n    return memo[n]'},rt:{'FP16':5,'INT8':5,'INT4':4,'GPTQ':5,'AWQ':5,'GGUF Q4_K_M':4}},
  {cat:'ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹',pr:'ã€Œé ­ãŒã„ã„ã€ã¨ã€Œè³¢ã„ã€ã®é•ã„ã¯ï¼Ÿ',rs:{'FP16':'ã€Œé ­ãŒã„ã„ã€ã¯çŸ¥çš„èƒ½åŠ›ãƒ»å‡¦ç†é€Ÿåº¦ã®é«˜ã•ã‚’ç¤ºã—ã€å­¦åŠ›ã‚„è¨ˆç®—èƒ½åŠ›ãªã©æ¸¬å®šå¯èƒ½ãªçŸ¥æ€§ã‚’å«æ„ã—ã¾ã™ã€‚ã€Œè³¢ã„ã€ã¯ã‚ˆã‚Šåºƒã„æ¦‚å¿µã§ã€çŠ¶æ³åˆ¤æ–­åŠ›ãƒ»æ´å¯ŸåŠ›ãƒ»çŸ¥æµã‚’å«ã¿ã€äººç”ŸçµŒé¨“ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹å®Ÿè·µçš„ãªåˆ¤æ–­åŠ›ã‚’æŒ‡ã™ã“ã¨ãŒå¤šã„ã§ã™ã€‚','INT8':'ã€Œé ­ãŒã„ã„ã€ã¯çŸ¥çš„èƒ½åŠ›ã®é«˜ã•ã‚’æŒ‡ã—ã¾ã™ã€‚ã€Œè³¢ã„ã€ã¯åˆ¤æ–­åŠ›ã‚„çŸ¥æµã‚’å«ã‚€ã‚ˆã‚Šåºƒã„æ¦‚å¿µã§ã™ã€‚','INT4':'ã€Œé ­ãŒã„ã„ã€ã¯çŸ¥èƒ½ãŒé«˜ã„ã€‚ã€Œè³¢ã„ã€ã¯åˆ¤æ–­åŠ›ãŒã‚ã‚‹ã€‚ä¼¼ã¦ã„ã‚‹ãŒé•ã„ã¾ã™ã€‚','GPTQ':'ã€Œé ­ãŒã„ã„ã€ã¯çŸ¥çš„å‡¦ç†èƒ½åŠ›ã®é«˜ã•ã€ã€Œè³¢ã„ã€ã¯çŸ¥æµã‚„æ´å¯ŸåŠ›ã‚’å«ã‚€åºƒã„æ¦‚å¿µã§ã™ã€‚','AWQ':'ã€Œé ­ãŒã„ã„ã€ã¯IQçš„ãªçŸ¥çš„èƒ½åŠ›ã€ã€Œè³¢ã„ã€ã¯çŸ¥æµ(wisdom)ã«è¿‘ã„ã€‚å­ä¾›ã«ã€Œé ­ãŒã„ã„ã­ã€ã¨ã¯è¨€ã†ãŒã€ã€Œè³¢ã„ã­ã€ã¯å¤§äººã«ä½¿ã†ã“ã¨ãŒå¤šã„ç‚¹ã‚‚ç‰¹å¾´çš„ã§ã™ã€‚','GGUF Q4_K_M':'ã€Œé ­ãŒã„ã„ã€ã¯çŸ¥çš„èƒ½åŠ›ã€ã€Œè³¢ã„ã€ã¯çŸ¥æµã‚„åˆ¤æ–­åŠ›ã‚’è¡¨ã—ã¾ã™ã€‚'},rt:{'FP16':5,'INT8':4,'INT4':2,'GPTQ':4,'AWQ':5,'GGUF Q4_K_M':3}},
  {cat:'é•·æ–‡',pr:'é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®åŸºæœ¬åŸç†ã‚’3æ®µè½ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚',rs:{'FP16':'é‡å­ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯é‡å­ãƒ“ãƒƒãƒˆ(qubit)ã‚’ä½¿ç”¨ã—ã€é‡ã­åˆã‚ã›ã«ã‚ˆã‚Š0ã¨1ã‚’åŒæ™‚ã«ä¿æŒã—ã¾ã™ã€‚nå€‹ã®qubitã§2^nçŠ¶æ…‹ã‚’åŒæ™‚è¡¨ç¾å¯èƒ½ã§ã™ã€‚\n\né‡å­ã‚‚ã¤ã‚Œã«ã‚ˆã‚Šé›¢ã‚ŒãŸqubité–“ã«ç›¸é–¢ãŒç”Ÿã¾ã‚Œã€ä¸¦åˆ—è¨ˆç®—ã‚’åŠ¹ç‡åŒ–ã—ã¾ã™ã€‚Shorã®ç´ å› æ•°åˆ†è§£ã‚„Groverã®æ¤œç´¢ãŒä»£è¡¨ä¾‹ã§ã™ã€‚\n\næœ€å¤§ã®èª²é¡Œã¯ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚é‡å­çŠ¶æ…‹ã¯ç’°å¢ƒãƒã‚¤ã‚ºã§æ€¥é€Ÿã«å´©å£Šã™ã‚‹ãŸã‚ã€æ¥µä½æ¸©ç’°å¢ƒã‚„é‡å­èª¤ã‚Šè¨‚æ­£ãŒä¸å¯æ¬ ã§ã™ã€‚','INT8':'qubitã¯é‡ã­åˆã‚ã›ã§0ã¨1ã‚’åŒæ™‚ã«è¡¨ç¾ã€‚nå€‹ã§2^nçŠ¶æ…‹ã‚’å‡¦ç†ã§ãã¾ã™ã€‚\n\né‡å­ã‚‚ã¤ã‚Œã§ä¸¦åˆ—è¨ˆç®—ãŒå¯èƒ½ã€‚Shorã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãªã©ãŒå¿œç”¨ä¾‹ã§ã™ã€‚\n\nãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ãŒèª²é¡Œã§ã€èª¤ã‚Šè¨‚æ­£æŠ€è¡“ãŒå®Ÿç”¨åŒ–ã®éµã§ã™ã€‚','INT4':'qubitã§0ã¨1ã‚’åŒæ™‚ã«æ‰±ã„ã€ä¸¦åˆ—è¨ˆç®—ãŒå¯èƒ½ã§ã™ã€‚\n\né‡å­ã‚‚ã¤ã‚Œã§é«˜é€Ÿè¨ˆç®—ã‚’å®Ÿç¾ã—ã¾ã™ã€‚\n\nãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ãŒèª²é¡Œã§ã™ã€‚','GPTQ':'é‡å­ãƒ“ãƒƒãƒˆã®é‡ã­åˆã‚ã›ã§nå€‹ã®qubitãŒ2^nçŠ¶æ…‹ã‚’è¡¨ç¾ã€‚\n\né‡å­ã‚‚ã¤ã‚Œã§Shorã‚„Groverã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæŒ‡æ•°çš„é«˜é€ŸåŒ–ã‚’å®Ÿç¾ã€‚\n\nãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ãŒå®Ÿç”¨ä¸Šã®èª²é¡Œã§ã€è¶…ä¼å°ã‚„ã‚¤ã‚ªãƒ³ãƒˆãƒ©ãƒƒãƒ—ã§ç ”ç©¶ä¸­ã€‚','AWQ':'qubitã¯é‡ã­åˆã‚ã›ã§0ã¨1ã‚’åŒæ™‚ä¿æŒã—ã€2^næ¬¡å…ƒãƒ’ãƒ«ãƒ™ãƒ«ãƒˆç©ºé–“ã‚’å½¢æˆã€‚\n\né‡å­ã‚‚ã¤ã‚Œã§å¤å…¸ç‰©ç†ã§ã¯èª¬æ˜ã§ããªã„ç›¸é–¢ã‚’è¨ˆç®—è³‡æºã¨ã—ã¦æ´»ç”¨ã€‚RSAæš—å·ã‚’è„…ã‹ã™Shorã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒæœ‰åã€‚\n\nãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ãŒæœ€å¤§ã®æŠ€è¡“çš„èª²é¡Œã€‚æ¥µä½æ¸©ç’°å¢ƒã¨é‡å­èª¤ã‚Šè¨‚æ­£ç¬¦å·ãŒä¸å¯æ¬ ã€‚','GGUF Q4_K_M':'qubitã§0ã¨1ã‚’åŒæ™‚è¡¨ç¾ã€‚é‡å­ã‚‚ã¤ã‚Œã§ä¸¦åˆ—è¨ˆç®—ã€‚ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ãŒèª²é¡Œã€‚'},rt:{'FP16':5,'INT8':4,'INT4':2,'GPTQ':4,'AWQ':5,'GGUF Q4_K_M':3}}
];

// === Tab3 Render ===
let rats={};
function ldR(){try{const s=localStorage.getItem('qv-r');if(s)rats=JSON.parse(s)}catch(e){}}
function svR(){try{localStorage.setItem('qv-r',JSON.stringify(rats))}catch(e){}}
function doCT(){
  ldR();const all=[...CD,...getUE()];
  let h='<table><thead><tr><th style="min-width:65px">ã‚«ãƒ†ã‚´ãƒª</th><th style="min-width:140px">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</th>';
  MT.forEach(m=>h+=`<th style="min-width:170px">${m}</th>`);h+='</tr></thead><tbody>';
  all.forEach((r,i)=>{
    h+=`<tr><td style="white-space:nowrap;font-weight:700;font-size:.82rem">${r.cat}</td><td style="font-size:.82rem">${r.pr}</td>`;
    MT.forEach(m=>{const rsp=(r.rs&&r.rs[m])||'â€”',k=`${i}-${m}`,rt=rats[k]!==undefined?rats[k]:(r.rt&&r.rt[m])||0;
      h+=`<td><div class="cc" onclick="this.classList.toggle('exp')"><pre style="white-space:pre-wrap;font-size:.8rem;font-family:inherit;margin:0;color:var(--text2)">${esc(rsp)}</pre></div>
        <span class="tb" onclick="this.previousElementSibling.classList.toggle('exp')">å±•é–‹</span>
        <div class="sr" data-k="${k}">${[1,2,3,4,5].map(s=>`<span class="st ${s<=rt?'f':''}" data-s="${s}" onclick="setR('${k}',${s})">â˜…</span>`).join('')}</div></td>`});
    h+='</tr>'});
  h+='</tbody></table>';document.getElementById('cTblW').innerHTML=h}
function setR(k,v){rats[k]=v;svR();const c=document.querySelector(`.sr[data-k="${k}"]`);
  if(c)c.querySelectorAll('.st').forEach(s=>s.classList.toggle('f',+s.dataset.s<=v))}

function doMC(){
  const ms=[
    {n:'FP16 (åŠç²¾åº¦æµ®å‹•å°æ•°ç‚¹)',d:'32bitâ†’16bitå¤‰æ›ã€‚æŒ‡æ•°5bitã€ä»®æ•°10bitã§è¡¨ç¾ã€‚GPUã®Tensor Coreã§ç›´æ¥æ¼”ç®—å¯èƒ½ãªãŸã‚ã€æ¨è«–é€Ÿåº¦ã‚‚å‘ä¸Šã™ã‚‹ã€‚æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªè»½é‡åŒ–æ‰‹æ³•ã€‚',sz:'50%å‰Šæ¸›(1/2)',pp:'+0.01%ä»¥ä¸‹',fw:['PyTorch','TensorFlow','ONNX'],p:['å“è³ªåŠ£åŒ–ã»ã¼ã‚¼ãƒ­','Tensor Coreæœ€é©åŒ–','ãƒ„ãƒ¼ãƒ«ä¸è¦'],c:['å‰Šæ¸›ç‡50%æ­¢ã¾ã‚Š']},
    {n:'INT8 (8bitæ•´æ•°é‡å­åŒ–)',d:'é‡ã¿ã‚’8bitæ•´æ•°ã«å¤‰æ›ã€‚å¯¾ç§°/éå¯¾ç§°ã‚’é¸æŠå¯èƒ½ã€‚ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã§ç²¾åº¦å‘ä¸Šã€‚å¤šãã®HWã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ãŒINT8ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆã€‚',sz:'75%å‰Šæ¸›(1/4)',pp:'+0.1ã€œ0.5%',fw:['ONNX Runtime','TensorRT','PyTorch'],p:['å¤§å¹…ãƒ¡ãƒ¢ãƒªå‰Šæ¸›','CPU/GPUä¸¡æ–¹ã§é«˜é€Ÿ','åºƒã„HWã‚µãƒãƒ¼ãƒˆ'],c:['ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿…è¦']},
    {n:'INT4 (4bitæ•´æ•°é‡å­åŒ–)',d:'ã‚ãšã‹16æ®µéšã§é‡ã¿è¡¨ç¾ã€‚ãƒ–ãƒ­ãƒƒã‚¯é‡å­åŒ–ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã€‚LLMã‚’æ¶ˆè²»è€…å‘ã‘GPU(8GB VRAM)ã§å‹•ã‹ã™ãŸã‚ã®å¿…é ˆæŠ€è¡“ã€‚',sz:'87.5%å‰Šæ¸›(1/8)',pp:'+0.5ã€œ2%',fw:['bitsandbytes','llama.cpp','AutoGPTQ'],p:['æœ€å¤§ãƒ¡ãƒ¢ãƒªå‰Šæ¸›','LLMã‚’æ‰‹å…ƒã§å®Ÿè¡Œå¯èƒ½'],c:['å“è³ªä½ä¸‹ãŒé¡•è‘—ãªå ´åˆã‚ã‚Š','å­¦ç¿’æ™‚ã¯ä½¿ç”¨å›°é›£']},
    {n:'GPTQ (Frantar et al., 2022)',d:'OBQ(Optimal Brain Quantization)ã«åŸºã¥ãPTQæ‰‹æ³•ã€‚ãƒ˜ãƒƒã‚»è¡Œåˆ—ã®è¿‘ä¼¼ã‚’ç”¨ã„ã¦ã€é‡å­åŒ–ã—ã¦ã‚‚å‡ºåŠ›ã¸ã®å½±éŸ¿ãŒæœ€å°ã«ãªã‚‹ã‚ˆã†é‡ã¿ã‚’é€æ¬¡èª¿æ•´ã€‚128ã‚µãƒ³ãƒ—ãƒ«ç¨‹åº¦ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã€‚',sz:'75ã€œ87.5%å‰Šæ¸›',pp:'+0.2ã€œ1%',fw:['AutoGPTQ','ExLlama','TGI'],p:['é«˜åœ§ç¸®ç‡ã§å“è³ªç¶­æŒ','GPUæ¨è«–æœ€é©åŒ–','å¹…åºƒã„ãƒ¢ãƒ‡ãƒ«å¯¾å¿œ'],c:['é‡å­åŒ–ã«æ•°æ™‚é–“','ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä¾å­˜','CPUæ¨è«–ã¯éåŠ¹ç‡']},
    {n:'AWQ (Lin et al., 2023)',d:'ã€Œæ´»æ€§åŒ–å€¤ãŒå¤§ãã„ãƒãƒ£ãƒãƒ«ã®é‡ã¿ã¯é‡è¦ã€ã¨ã„ã†çŸ¥è¦‹ã«åŸºã¥ãã€é‡è¦ãƒãƒ£ãƒãƒ«ã®scaleã‚’èª¿æ•´ã—ã¦é‡å­åŒ–èª¤å·®ã‚’æœ€å°åŒ–ã€‚GPTQã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã§é«˜é€Ÿãªé‡å­åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã€‚',sz:'75ã€œ87.5%å‰Šæ¸›',pp:'+0.1ã€œ0.5%',fw:['AutoAWQ','vLLM','TGI'],p:['GPTQã‚ˆã‚Šé«˜å“è³ªå‚¾å‘','é‡å­åŒ–ãŒé«˜é€Ÿ','æ¨è«–é€Ÿåº¦ãŒé€Ÿã„'],c:['æ¯”è¼ƒçš„æ–°ã—ã„æ‰‹æ³•']},
    {n:'GGUF Q4_K_M (llama.cpp)',d:'llama.cppç‹¬è‡ªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‚K-quantæ–¹å¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã¨ç²¾åº¦ã‚’å±¤ã”ã¨ã«æœ€é©åŒ–ã€‚Kã¯k-meansçš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã€Mã¯Mediumå“è³ªã€‚Apple Silicon(Metal)ã‚„x86(AVX2)ã§é«˜é€Ÿå‹•ä½œã€‚',sz:'~80%å‰Šæ¸›',pp:'+0.3ã€œ1%',fw:['llama.cpp','Ollama','LM Studio','koboldcpp'],p:['CPUæ¨è«–æœ€é©','Apple Siliconå¯¾å¿œ','å³ä½¿ãˆã‚‹'],c:['GPUæ¨è«–ã¯GPTQ/AWQã«åŠ£ã‚‹']}
  ];
  document.getElementById('mCards').innerHTML=ms.map(m=>`<div class="mcd"><h4>${m.n}</h4>
    <p class="md">${m.d}</p>
    <div class="ms"><span>ã‚µã‚¤ã‚ºå‰Šæ¸›: <strong>${m.sz}</strong></span><span>Perplexityå¢—åŠ : <strong>${m.pp}</strong></span></div>
    <div style="margin-bottom:.5rem">${m.fw.map(f=>`<span class="tg fw">${f}</span>`).join('')}</div>
    <div>${m.p.map(p=>`<span class="tg pro">+ ${p}</span>`).join('')}${m.c.map(c=>`<span class="tg con">- ${c}</span>`).join('')}</div></div>`).join('')}

// === User Input ===
function getUE(){try{const s=localStorage.getItem('qv-ue');return s?JSON.parse(s):[]}catch(e){return[]}}
function svUE(e){try{localStorage.setItem('qv-ue',JSON.stringify(e))}catch(e){}}
function doURI(){document.getElementById('uRI').innerHTML=MT.map(m=>
  `<div style="margin-top:.5rem"><label style="font-size:.82rem;color:var(--text-muted);font-weight:600">${m}:</label>
   <textarea id="ur_${m.replace(/\s/g,'_')}" placeholder="${m}ã®å¿œç­”..." style="width:100%;min-height:40px"></textarea></div>`).join('')}
function addUE(){
  const cat=document.getElementById('uCat').value.trim(),pr=document.getElementById('uPr').value.trim();
  if(!cat||!pr){alert('ã‚«ãƒ†ã‚´ãƒªã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›');return}
  const rs={};MT.forEach(m=>{const el=document.getElementById('ur_'+m.replace(/\s/g,'_'));rs[m]=el?el.value.trim():''});
  const e=getUE();e.push({cat,pr,rs,rt:{}});svUE(e);
  document.getElementById('uCat').value='';document.getElementById('uPr').value='';
  MT.forEach(m=>{const el=document.getElementById('ur_'+m.replace(/\s/g,'_'));if(el)el.value=''});
  doUEL();doCT()}
function clrUE(){if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼Ÿ'))return;svUE([]);doUEL();doCT()}
function delUE(i){const e=getUE();e.splice(i,1);svUE(e);doUEL();doCT()}
function doUEL(){
  const e=getUE(),c=document.getElementById('uEL');
  if(!e.length){c.innerHTML='<p style="color:var(--text-muted)">è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãªã—</p>';return}
  c.innerHTML=`<h4 style="margin-bottom:.5rem">è¿½åŠ æ¸ˆã¿(${e.length}ä»¶)</h4>`+
    e.map((x,i)=>`<div class="mcd"><div style="display:flex;justify-content:space-between;align-items:center">
      <h4 style="font-size:.9rem">[${x.cat}] ${x.pr.substring(0,70)}${x.pr.length>70?'...':''}</h4>
      <button onclick="delUE(${i})" class="btn-d">å‰Šé™¤</button></div></div>`).join('')}

// === Tab0: Why Quantization ===

// Section A: Pipeline experience
function doWhyPipe(){
  const v=+document.getElementById('whyVal').value,b=+document.getElementById('whyBits').value;
  document.getElementById('whyValV').textContent=v.toFixed(2);
  const absMax=2.0,qmax=(1<<(b-1))-1,sc=absMax/qmax;
  const qInt=Math.round(v/sc),clamped=Math.max(-qmax,Math.min(qmax,qInt)),deq=clamped*sc;
  const err=Math.abs(v-deq);
  document.getElementById('whyPipe').innerHTML=
    `<div class="pipe-box active"><div class="pipe-label">å…¥åŠ› (å®Ÿæ•°)</div><div class="pipe-val" style="color:var(--accent)">${v.toFixed(4)}</div></div>`+
    `<div class="pipe-arrow">â†’</div>`+
    `<div class="pipe-box"><div class="pipe-label">Ã· scale (${sc.toFixed(4)})</div><div class="pipe-val">${(v/sc).toFixed(2)}</div></div>`+
    `<div class="pipe-arrow">â†’</div>`+
    `<div class="pipe-box"><div class="pipe-label">round â†’ clamp</div><div class="pipe-val" style="color:var(--orange)">${clamped}</div></div>`+
    `<div class="pipe-arrow">â†’</div>`+
    `<div class="pipe-box"><div class="pipe-label">Ã— scale (å¾©å…ƒ)</div><div class="pipe-val" style="color:var(--green)">${deq.toFixed(4)}</div></div>`+
    `<div class="pipe-arrow">â†’</div>`+
    `<div class="pipe-box active"><div class="pipe-label">èª¤å·®</div><div class="pipe-val" style="color:${err<0.01?'var(--green)':err<0.1?'var(--orange)':'var(--red)'}">${err.toFixed(4)}</div></div>`;
  document.getElementById('whyErrVal').textContent=err.toFixed(6);
  const maxErr=sc; // max possible error is half a step â‰ˆ scale
  const pct=Math.min(err/(absMax*0.5)*100,100);
  const bar=document.getElementById('whyErrBar');
  bar.style.width=pct+'%';
  bar.style.background=pct<5?'var(--green)':pct<30?'var(--orange)':'var(--red)';
  document.getElementById('whyErrLabel').textContent=pct<5?'æ¥µå°':pct<30?'ä¸­ç¨‹åº¦':'å¤§';
  // Pipeline diagram canvas
  const pcv=document.getElementById('pipeDiagram'),pW=pcv.parentElement.clientWidth;pcv.width=pW;
  const pH=pcv.height,pctx=pcv.getContext('2d');
  pctx.clearRect(0,0,pW,pH);
  const mL=40,mR=40,lineY=pH*0.5;
  const range=absMax*1.15;
  const xPos=val=>mL+((val+range)/(2*range))*(pW-mL-mR);
  // Number line
  pctx.strokeStyle='#2a3040';pctx.lineWidth=2;
  pctx.beginPath();pctx.moveTo(mL,lineY);pctx.lineTo(pW-mR,lineY);pctx.stroke();
  // Grid ticks
  pctx.strokeStyle='rgba(77,166,255,.15)';pctx.lineWidth=1;
  for(let q=-qmax;q<=qmax;q++){const lv=q*sc;if(Math.abs(lv)<=range){
    const px=xPos(lv);pctx.beginPath();pctx.moveTo(px,lineY-14);pctx.lineTo(px,lineY+14);pctx.stroke()}}
  // Original value dot
  const ovx=xPos(v),qvx=xPos(deq);
  pctx.fillStyle='#4da6ff';pctx.beginPath();pctx.arc(ovx,lineY,8,0,Math.PI*2);pctx.fill();
  pctx.fillStyle='#4da6ff';pctx.font='bold 10px sans-serif';pctx.textAlign='center';pctx.fillText(v.toFixed(2),ovx,lineY-16);
  // Quantized value dot
  pctx.fillStyle='#44cc66';pctx.beginPath();pctx.arc(qvx,lineY,7,0,Math.PI*2);pctx.fill();
  pctx.fillStyle='#44cc66';pctx.fillText(deq.toFixed(3),qvx,lineY+28);
  // Error arrow
  if(Math.abs(ovx-qvx)>2){
    pctx.strokeStyle='#ffaa33';pctx.lineWidth=2;pctx.setLineDash([4,3]);
    pctx.beginPath();pctx.moveTo(ovx,lineY-4);pctx.lineTo(qvx,lineY-4);pctx.stroke();pctx.setLineDash([]);
    pctx.fillStyle='#ffaa33';pctx.font='9px sans-serif';pctx.fillText('èª¤å·® '+err.toFixed(4),(ovx+qvx)/2,lineY-22)}
  // Labels
  pctx.fillStyle='#556070';pctx.font='9px sans-serif';pctx.textAlign='left';pctx.fillText('-'+absMax,mL,lineY+28);
  pctx.textAlign='right';pctx.fillText('+'+absMax,pW-mR,lineY+28);
  pctx.textAlign='center';pctx.fillText('0',xPos(0),lineY+28);
  pctx.fillStyle='#7888a0';pctx.font='9px sans-serif';pctx.textAlign='left';
  pctx.fillText('é‡å­åŒ–ã‚°ãƒªãƒƒãƒ‰ ('+b+'bit = '+(2*qmax+1)+'ãƒ¬ãƒ™ãƒ«)',mL,14);
}
document.getElementById('whyVal').addEventListener('input',doWhyPipe);
document.getElementById('whyBits').addEventListener('change',doWhyPipe);

// Section: Image Quantization
const iqBitsArr=[8,4,3,2,1];
const iqLabels=['32bit (åŸç”»)','8bit/ch','4bit/ch','3bit/ch','2bit/ch','1bit/ch'];
const iqLevels=[256,256,16,8,4,2];
let iqPattern='gradient';
(function initIqGrid(){
  const grid=document.getElementById('iqGrid');
  const ids=['iq32','iq8','iq4','iq3','iq2','iq1'];
  ids.forEach((id,i)=>{
    const cell=document.createElement('div');cell.className='iq-cell';
    cell.innerHTML=`<div class="iq-label"><span>${iqLabels[i]}</span><span class="iq-levels">${iqLevels[i]}æ®µéš/ch</span></div><canvas id="${id}" width="200" height="200"></canvas>`;
    grid.appendChild(cell);
  });
})();
function iqGenPixel(pattern,u,v){
  // u,v in [0,1], returns [r,g,b] in [0,255]
  if(pattern==='gradient'){
    const h=u*360,s=1,l=1-v;
    return hslToRgb(h,s,l);
  }
  if(pattern==='radial'){
    const dx=u-.5,dy=v-.5,d=Math.sqrt(dx*dx+dy*dy)*2;
    const angle=Math.atan2(dy,dx);
    const h=((angle/Math.PI+1)/2*360)%360;
    const l=Math.max(0,1-d);
    return hslToRgb(h,1,l);
  }
  // wave
  const x=u*8*Math.PI,y=v*8*Math.PI;
  const v1=(Math.sin(x)*Math.cos(y)+1)/2;
  const v2=(Math.sin(x*1.7+1)*Math.cos(y*0.7+2)+1)/2;
  const v3=(Math.sin(x*0.5+y*0.5)+1)/2;
  return [v1*255,v2*255,v3*255];
}
function hslToRgb(h,s,l){
  const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2;
  let r=0,g=0,b=0;
  if(h<60){r=c;g=x}else if(h<120){r=x;g=c}else if(h<180){g=c;b=x}
  else if(h<240){g=x;b=c}else if(h<300){r=x;b=c}else{r=c;b=x}
  return [(r+m)*255,(g+m)*255,(b+m)*255];
}
function doImageQuant(){
  const S=200;
  // Generate base image
  const base=new Float32Array(S*S*3);
  for(let y=0;y<S;y++)for(let x=0;x<S;x++){
    const idx=(y*S+x)*3;
    const rgb=iqGenPixel(iqPattern,x/S,y/S);
    base[idx]=rgb[0];base[idx+1]=rgb[1];base[idx+2]=rgb[2];
  }
  const configs=[
    {id:'iq32',bits:32},{id:'iq8',bits:8},{id:'iq4',bits:4},
    {id:'iq3',bits:3},{id:'iq2',bits:2},{id:'iq1',bits:1}
  ];
  configs.forEach(({id,bits})=>{
    const cv=document.getElementById(id);if(!cv)return;
    cv.width=S;cv.height=S;
    const ctx=cv.getContext('2d');
    const img=ctx.createImageData(S,S);
    const levels=bits>=32?256:Math.pow(2,bits);
    const step=256/levels;
    for(let i=0;i<S*S;i++){
      const si=i*3,di=i*4;
      for(let c=0;c<3;c++){
        let v=base[si+c];
        if(bits<32){
          v=Math.floor(v/step)*step+step/2;
          v=Math.max(0,Math.min(255,v));
        }
        img.data[di+c]=v;
      }
      img.data[di+3]=255;
    }
    ctx.putImageData(img,0,0);
  });
}
document.getElementById('iqPatterns').addEventListener('click',e=>{
  const btn=e.target.closest('button[data-p]');if(!btn)return;
  document.querySelectorAll('#iqPatterns button').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  iqPattern=btn.dataset.p;
  doImageQuant();
});

// Section: Mosaic Recognition Demo
const MO_SIZE=160;
const MO_BLOCKS=[1,2,4,8,16,32];
let moSubject='cat';
function moDrawSubject(ctx,S){
  ctx.clearRect(0,0,S,S);
  // Background
  ctx.fillStyle='#ddeeff';ctx.fillRect(0,0,S,S);
  if(moSubject==='cat'){
    // Body / head
    ctx.fillStyle='#ff9933';
    ctx.beginPath();ctx.ellipse(S*.5,S*.55,S*.28,S*.3,0,0,Math.PI*2);ctx.fill();
    // Ears
    ctx.beginPath();ctx.moveTo(S*.28,S*.3);ctx.lineTo(S*.2,S*.08);ctx.lineTo(S*.42,S*.22);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(S*.72,S*.3);ctx.lineTo(S*.8,S*.08);ctx.lineTo(S*.58,S*.22);ctx.closePath();ctx.fill();
    // Inner ears
    ctx.fillStyle='#ffcc88';
    ctx.beginPath();ctx.moveTo(S*.3,S*.28);ctx.lineTo(S*.24,S*.13);ctx.lineTo(S*.4,S*.24);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(S*.7,S*.28);ctx.lineTo(S*.76,S*.13);ctx.lineTo(S*.6,S*.24);ctx.closePath();ctx.fill();
    // Eyes
    ctx.fillStyle='#225522';
    ctx.beginPath();ctx.ellipse(S*.38,S*.48,S*.055,S*.07,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(S*.62,S*.48,S*.055,S*.07,0,0,Math.PI*2);ctx.fill();
    // Pupils
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(S*.38,S*.48,S*.025,S*.05,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(S*.62,S*.48,S*.025,S*.05,0,0,Math.PI*2);ctx.fill();
    // Nose
    ctx.fillStyle='#dd5577';
    ctx.beginPath();ctx.moveTo(S*.5,S*.56);ctx.lineTo(S*.47,S*.53);ctx.lineTo(S*.53,S*.53);ctx.closePath();ctx.fill();
    // Mouth
    ctx.strokeStyle='#884422';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(S*.5,S*.57);ctx.quadraticCurveTo(S*.43,S*.64,S*.36,S*.60);ctx.stroke();
    ctx.beginPath();ctx.moveTo(S*.5,S*.57);ctx.quadraticCurveTo(S*.57,S*.64,S*.64,S*.60);ctx.stroke();
    // Whiskers
    ctx.strokeStyle='#553311';ctx.lineWidth=1;
    [[.15,.52,.34,.52],[.14,.57,.33,.56],[.16,.62,.35,.60],
     [.85,.52,.66,.52],[.86,.57,.67,.56],[.84,.62,.65,.60]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath();ctx.moveTo(S*x1,S*y1);ctx.lineTo(S*x2,S*y2);ctx.stroke();});
    // Tail
    ctx.strokeStyle='#ff9933';ctx.lineWidth=5;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(S*.72,S*.82);ctx.quadraticCurveTo(S*.92,S*.7,S*.85,S*.5);ctx.stroke();
  } else if(moSubject==='fish'){
    // Water
    ctx.fillStyle='#aaddff';ctx.fillRect(0,0,S,S);
    // Body
    ctx.fillStyle='#ff6644';
    ctx.beginPath();ctx.ellipse(S*.48,S*.5,S*.3,S*.18,0,0,Math.PI*2);ctx.fill();
    // Tail
    ctx.beginPath();ctx.moveTo(S*.75,S*.5);ctx.lineTo(S*.92,S*.32);ctx.lineTo(S*.92,S*.68);ctx.closePath();ctx.fill();
    // Fin top
    ctx.fillStyle='#ff8866';
    ctx.beginPath();ctx.moveTo(S*.4,S*.32);ctx.quadraticCurveTo(S*.5,S*.15,S*.58,S*.33);ctx.closePath();ctx.fill();
    // Eye
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(S*.35,S*.46,S*.06,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.arc(S*.34,S*.46,S*.03,0,Math.PI*2);ctx.fill();
    // Mouth
    ctx.strokeStyle='#cc3322';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(S*.2,S*.52);ctx.quadraticCurveTo(S*.24,S*.56,S*.28,S*.52);ctx.stroke();
    // Scales
    ctx.strokeStyle='rgba(200,80,40,.3)';ctx.lineWidth=1;
    for(let i=0;i<3;i++)for(let j=0;j<2;j++){
      ctx.beginPath();ctx.arc(S*(.38+i*.1),S*(.44+j*.1),S*.04,0,Math.PI,false);ctx.stroke();}
    // Bubbles
    ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=1.5;
    [[.18,.35,.02],[.12,.28,.015],[.15,.2,.01]].forEach(([x,y,r])=>{
      ctx.beginPath();ctx.arc(S*x,S*y,S*r,0,Math.PI*2);ctx.stroke();});
  } else if(moSubject==='house'){
    // Ground
    ctx.fillStyle='#88cc55';ctx.fillRect(0,S*.72,S,S*.28);
    // Sky
    ctx.fillStyle='#aaddff';ctx.fillRect(0,0,S,S*.72);
    // Wall
    ctx.fillStyle='#eebb77';ctx.fillRect(S*.2,S*.4,S*.6,S*.34);
    // Roof
    ctx.fillStyle='#cc4433';
    ctx.beginPath();ctx.moveTo(S*.15,S*.42);ctx.lineTo(S*.5,S*.12);ctx.lineTo(S*.85,S*.42);ctx.closePath();ctx.fill();
    // Door
    ctx.fillStyle='#774422';ctx.fillRect(S*.44,S*.54,S*.12,S*.2);
    // Doorknob
    ctx.fillStyle='#ffcc00';ctx.beginPath();ctx.arc(S*.53,S*.64,S*.015,0,Math.PI*2);ctx.fill();
    // Windows
    ctx.fillStyle='#aaddff';ctx.strokeStyle='#886633';ctx.lineWidth=1.5;
    [[.26,.48,.1,.1],[.64,.48,.1,.1]].forEach(([x,y,w,h])=>{
      ctx.fillRect(S*x,S*y,S*w,S*h);ctx.strokeRect(S*x,S*y,S*w,S*h);
      ctx.beginPath();ctx.moveTo(S*(x+w/2),S*y);ctx.lineTo(S*(x+w/2),S*(y+h));ctx.stroke();
      ctx.beginPath();ctx.moveTo(S*x,S*(y+h/2));ctx.lineTo(S*(x+w),S*(y+h/2));ctx.stroke();});
    // Sun
    ctx.fillStyle='#ffdd44';ctx.beginPath();ctx.arc(S*.85,S*.12,S*.06,0,Math.PI*2);ctx.fill();
  } else { // tree
    // Sky
    ctx.fillStyle='#aaddff';ctx.fillRect(0,0,S,S*.7);
    // Ground
    ctx.fillStyle='#88cc55';ctx.fillRect(0,S*.7,S,S*.3);
    // Trunk
    ctx.fillStyle='#885533';ctx.fillRect(S*.43,S*.5,S*.14,S*.28);
    // Canopy layers
    ctx.fillStyle='#33aa44';
    ctx.beginPath();ctx.ellipse(S*.5,S*.38,S*.28,S*.2,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#2d9940';
    ctx.beginPath();ctx.ellipse(S*.42,S*.44,S*.18,S*.14,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#38b34a';
    ctx.beginPath();ctx.ellipse(S*.58,S*.42,S*.18,S*.14,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#44cc55';
    ctx.beginPath();ctx.ellipse(S*.5,S*.3,S*.2,S*.15,0,0,Math.PI*2);ctx.fill();
    // Apples
    ctx.fillStyle='#ee3333';
    [[.4,.34],[.55,.4],[.62,.36],[.44,.44]].forEach(([x,y])=>{
      ctx.beginPath();ctx.arc(S*x,S*y,S*.025,0,Math.PI*2);ctx.fill();});
    // Sun
    ctx.fillStyle='#ffdd44';ctx.beginPath();ctx.arc(S*.85,S*.12,S*.06,0,Math.PI*2);ctx.fill();
  }
}
function doMosaic(){
  const grid=document.getElementById('moGrid');
  grid.innerHTML='';
  // Draw original at full res to an offscreen canvas
  const offCv=document.createElement('canvas');offCv.width=MO_SIZE;offCv.height=MO_SIZE;
  const offCtx=offCv.getContext('2d');
  moDrawSubject(offCtx,MO_SIZE);
  const origData=offCtx.getImageData(0,0,MO_SIZE,MO_SIZE);

  MO_BLOCKS.forEach(bs=>{
    const cell=document.createElement('div');cell.className='mo-cell';
    const cv=document.createElement('canvas');cv.width=MO_SIZE;cv.height=MO_SIZE;
    const ctx=cv.getContext('2d');
    if(bs===1){
      ctx.putImageData(origData,0,0);
    } else {
      // Mosaic: average each block
      const img=ctx.createImageData(MO_SIZE,MO_SIZE);
      for(let by=0;by<MO_SIZE;by+=bs)for(let bx=0;bx<MO_SIZE;bx+=bs){
        let rS=0,gS=0,bS=0,cnt=0;
        for(let dy=0;dy<bs&&by+dy<MO_SIZE;dy++)for(let dx=0;dx<bs&&bx+dx<MO_SIZE;dx++){
          const idx=((by+dy)*MO_SIZE+(bx+dx))*4;
          rS+=origData.data[idx];gS+=origData.data[idx+1];bS+=origData.data[idx+2];cnt++;
        }
        const rA=Math.round(rS/cnt),gA=Math.round(gS/cnt),bA=Math.round(bS/cnt);
        for(let dy=0;dy<bs&&by+dy<MO_SIZE;dy++)for(let dx=0;dx<bs&&bx+dx<MO_SIZE;dx++){
          const idx=((by+dy)*MO_SIZE+(bx+dx))*4;
          img.data[idx]=rA;img.data[idx+1]=gA;img.data[idx+2]=bA;img.data[idx+3]=255;
        }
      }
      ctx.putImageData(img,0,0);
    }
    const res=Math.ceil(MO_SIZE/bs);
    const lost=bs>=16;
    if(lost)cell.classList.add('mo-lost');
    const label=bs===1?'åŸç”» ('+MO_SIZE+'Ã—'+MO_SIZE+')':bs+'Ã—'+bs+'ãƒ–ãƒ­ãƒƒã‚¯ â†’ å®Ÿè³ª'+res+'Ã—'+res;
    const verdict=bs===1?'<span class="mo-verdict ok">âœ“ å®Œå…¨</span>':
      bs<=4?'<span class="mo-verdict ok">âœ“ åˆ¤åˆ¥å¯èƒ½</span>':
      bs<=8?'<span class="mo-verdict ok">â–³ ã‚®ãƒªã‚®ãƒª</span>':
      '<span class="mo-verdict ng">âœ— åˆ¤åˆ¥å›°é›£</span>';
    cell.innerHTML='';
    cell.appendChild(cv);
    const info=document.createElement('div');info.className='mo-info';
    info.innerHTML='<span class="mo-block">'+label+'</span>'+verdict;
    cell.appendChild(info);
    grid.appendChild(cell);
  });
}
document.getElementById('moSubjects').addEventListener('click',e=>{
  const btn=e.target.closest('button[data-s]');if(!btn)return;
  document.querySelectorAll('#moSubjects button').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  moSubject=btn.dataset.s;
  doMosaic();
});

// Section: Text Quantization Demo
const TQ_TEXTS={
  tech:'é‡å­åŒ–ã¯ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é‡ã¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½ç²¾åº¦ã®æ•°å€¤è¡¨ç¾ã«å¤‰æ›ã™ã‚‹æŠ€è¡“ã§ã™ã€‚FP32ã‹ã‚‰INT4ã¸ã®é‡å­åŒ–ã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºã‚’ç´„8åˆ†ã®1ã«åœ§ç¸®ã§ãã¾ã™ã€‚',
  story:'æ¡œã®èŠ±ã³ã‚‰ãŒé¢¨ã«èˆã„ã€å·é¢ã«ãã£ã¨è½ã¡ãŸã€‚å°‘å¥³ã¯æ©‹ã®ä¸Šã‹ã‚‰é™ã‹ã«ãã®å…‰æ™¯ã‚’çœºã‚ã¦ã„ãŸã€‚æ˜¥ã®æŸ”ã‚‰ã‹ãªæ—¥å·®ã—ãŒã€å½¼å¥³ã®é•·ã„é«ªã‚’é‡‘è‰²ã«æŸ“ã‚ã¦ã„ã‚‹ã€‚',
  code:'é–¢æ•°getMaxValue()ã¯é…åˆ—ã®å…¨è¦ç´ ã‚’èµ°æŸ»ã—ã€æœ€å¤§å€¤ã‚’è¿”å´ã™ã‚‹ã€‚å¼•æ•°ãŒnullã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ã€‚è¨ˆç®—é‡ã¯O(n)ã§ç©ºé–“é‡ã¯O(1)ã§ã‚ã‚‹ã€‚'
};
const TQ_KANA_MAP={'é‡':'ã‚Šã‚‡ã†','å­':'ã—','åŒ–':'ã‹','ã¯':'ã¯','ãƒ‹':'ã«','ãƒ¥':'ã‚…','ãƒ¼':'ãƒ¼','ãƒ©':'ã‚‰','ãƒ«':'ã‚‹','ãƒ':'ã­','ãƒƒ':'ã£','ãƒˆ':'ã¨','ãƒ¯':'ã‚','ã‚¯':'ã','ã®':'ã®','é‡':'ãŠã‚‚','ã¿':'ã¿','ãƒ‘':'ã±','ãƒ©':'ã‚‰','ãƒ¡':'ã‚','ã‚¿':'ãŸ','ã‚’':'ã‚’','ä½':'ã¦ã„','ç²¾':'ã›ã„','åº¦':'ã©','æ•°':'ã™ã†','å€¤':'ã¡','è¡¨':'ã²ã‚‡ã†','ç¾':'ã’ã‚“','ã«':'ã«','å¤‰':'ã¸ã‚“','æ›':'ã‹ã‚“','ã™':'ã™','ã‚‹':'ã‚‹','æŠ€':'ã','è¡“':'ã˜ã‚…ã¤','ã§':'ã§','ã™':'ã™'};
function toHiragana(text){
  let result='';
  for(const ch of text){
    const code=ch.charCodeAt(0);
    if(code>=0x30A0&&code<=0x30FF){result+=String.fromCharCode(code-0x60);continue;}
    if(code>=0x4E00&&code<=0x9FFF){result+='â—‹';continue;}
    result+=ch;
  }
  return result;
}
function extractVowels(text){
  const vowels='ã‚ã„ã†ãˆãŠã‚¢ã‚¤ã‚¦ã‚¨ã‚ªaeiouAEIOU';
  let result='';
  for(const ch of text){
    if(vowels.includes(ch))result+=ch;
    else if(ch===' '||ch==='ã€€'||ch==='ã€‚'||ch==='ã€'||ch==='\n')result+=ch;
    else result+='Â·';
  }
  return result;
}
let tqSample='tech';
function doTextQuant(){
  const grid=document.getElementById('tqGrid');
  grid.innerHTML='';
  const orig=TQ_TEXTS[tqSample];
  const levels=[
    {label:'åŸæ–‡ï¼ˆFP32ç›¸å½“ï¼‰',bits:'32bit',text:orig,ratio:'100%',lost:false,verdict:'å®Œå…¨ãªæƒ…å ±'},
    {label:'ã²ã‚‰ãŒãªåŒ–ï¼ˆFP16ç›¸å½“ï¼‰',bits:'16bit',
     text:toHiragana(orig),ratio:'100%',lost:false,verdict:'æ„å‘³ã¯ã»ã¼ä¿æŒ'},
    {label:'2æ–‡å­—ã«1æ–‡å­—ï¼ˆINT8ç›¸å½“ï¼‰',bits:'8bit',
     text:[...orig].filter((_,i)=>i%2===0).join(''),ratio:'50%',lost:false,verdict:'æ¨æ¸¬å¯èƒ½'},
    {label:'4æ–‡å­—ã«1æ–‡å­—ï¼ˆINT4ç›¸å½“ï¼‰',bits:'4bit',
     text:[...orig].filter((_,i)=>i%4===0).join(''),ratio:'25%',lost:true,verdict:'æ–­ç‰‡çš„'},
    {label:'æ¯éŸ³ãƒ»å¥èª­ç‚¹ã®ã¿ï¼ˆINT2ç›¸å½“ï¼‰',bits:'2bit',
     text:extractVowels(orig),ratio:'-',lost:true,verdict:'ã»ã¼åˆ¤èª­ä¸èƒ½'},
    {label:'æ–‡å­—æ•°ã®ã¿ï¼ˆ1bitç›¸å½“ï¼‰',bits:'1bit',
     text:'['+[...orig].length+'æ–‡å­—]'+'ã€€'+'â–ˆ'.repeat(Math.min(40,Math.round([...orig].length/2))),
     ratio:'-',lost:true,verdict:'æƒ…å ±æ¶ˆå¤±'}
  ];
  levels.forEach(lv=>{
    const card=document.createElement('div');
    card.className='tq-card'+(lv.lost?' tq-lost':'');
    card.innerHTML=
      '<div class="tq-head"><span class="tq-title">'+lv.label+'</span><span class="tq-meta">'+lv.bits+(lv.ratio!=='-'?' / æƒ…å ±é‡â‰ˆ'+lv.ratio:'')+'</span></div>'+
      '<div class="tq-text">'+escHtml(lv.text)+'</div>'+
      '<div class="tq-verdict '+(lv.lost?'ng':'ok')+'">'+(lv.lost?'âœ— ':'âœ“ ')+lv.verdict+'</div>';
    grid.appendChild(card);
  });
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
document.getElementById('tqSamples').addEventListener('click',e=>{
  const btn=e.target.closest('button[data-t]');if(!btn)return;
  document.querySelectorAll('#tqSamples button').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  tqSample=btn.dataset.t;
  doTextQuant();
});

// Section B: Degradation demo
function doDegradation(){
  const bits=+document.getElementById('degBits').value,comp=+document.getElementById('degComp').value;
  document.getElementById('degBitsV').textContent=bits;
  document.getElementById('degCompV').textContent=comp;
  const cv=document.getElementById('degCanvas'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),m={l:50,r:20,t:20,b:35};
  const N=200,pW=W-m.l-m.r,pH=H-m.t-m.b;
  // Generate signal
  const sig=[];for(let i=0;i<N;i++){const t=i/N*4*Math.PI;let y=0;
    for(let h=1;h<=comp;h++)y+=Math.sin(h*t)/(h*0.7);sig.push(y)}
  const maxAbs=Math.max(...sig.map(Math.abs))||1;
  // Quantize
  const qmax=(1<<(bits-1))-1,sc=maxAbs/qmax;
  const qSig=sig.map(v=>{const q=Math.max(-qmax,Math.min(qmax,Math.round(v/sc)));return q*sc});
  // Stats
  let mse=0;sig.forEach((v,i)=>mse+=(v-qSig[i])**2);mse/=N;
  const sigPow=sig.reduce((s,v)=>s+v*v,0)/N;
  const snr=sigPow>0?10*Math.log10(sigPow/mse):Infinity;
  const xP=i=>m.l+(i/(N-1))*pW,yP=v=>m.t+pH/2-(v/maxAbs)*(pH/2)*0.9;
  ctx.clearRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#1a2030';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(m.l,yP(0));ctx.lineTo(W-m.r,yP(0));ctx.stroke();
  // Original
  ctx.strokeStyle='#4da6ff';ctx.lineWidth=2;ctx.beginPath();
  sig.forEach((v,i)=>{i===0?ctx.moveTo(xP(i),yP(v)):ctx.lineTo(xP(i),yP(v))});ctx.stroke();
  // Quantized (step function)
  ctx.strokeStyle='#ff5555';ctx.lineWidth=2;ctx.beginPath();
  qSig.forEach((v,i)=>{if(i===0){ctx.moveTo(xP(i),yP(v))}else{ctx.lineTo(xP(i),yP(qSig[i-1]));ctx.lineTo(xP(i),yP(v))}});ctx.stroke();
  // Legend
  ctx.fillStyle='#4da6ff';ctx.font='11px sans-serif';ctx.fillText('â— å…ƒä¿¡å·',m.l+5,H-8);
  ctx.fillStyle='#ff5555';ctx.fillText('â— é‡å­åŒ–ä¿¡å·',m.l+85,H-8);
  // Stats
  document.getElementById('degStats').innerHTML=
    `<div class="stat">é‡å­åŒ–ãƒ¬ãƒ™ãƒ«æ•°: <strong>${Math.pow(2,bits)}</strong></div>`+
    `<div class="stat">MSE: <strong>${mse.toFixed(6)}</strong></div>`+
    `<div class="stat">SNR: <strong>${isFinite(snr)?snr.toFixed(1)+'dB':'âˆ'}</strong></div>`;
}
document.getElementById('degBits').addEventListener('input',doDegradation);
document.getElementById('degComp').addEventListener('input',doDegradation);

// Section C-left: Weight distribution concentration
let whyDistCh=null;
function doWhyDist(){
  const w=genW(5000,0,0.02),cv=document.getElementById('whyDistCv');
  const h=hist(w,60);
  const within04=w.filter(v=>Math.abs(v)<=0.04).length;
  const pct=(within04/w.length*100).toFixed(1);
  if(typeof Chart!=='undefined'){
    if(whyDistCh)whyDistCh.destroy();
    whyDistCh=new Chart(cv,{type:'bar',data:{labels:h.l,datasets:[
      {label:'Transformeré‡ã¿ N(0, 0.02)',data:h.b,backgroundColor:'rgba(77,166,255,.3)',borderColor:'rgba(77,166,255,.7)',borderWidth:1}
    ]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:250},
      plugins:{legend:{labels:{color:'#b8c0d0',font:{size:11}}}},
      scales:{x:{ticks:{color:'#7888a0',maxTicksLimit:8,font:{size:9}},grid:{color:'#1a2030'},
        title:{display:true,text:'é‡ã¿ã®å€¤',color:'#7888a0',font:{size:11}}},
        y:{ticks:{color:'#7888a0',font:{size:9}},grid:{color:'#1a2030'},
        title:{display:true,text:'é »åº¦',color:'#7888a0',font:{size:11}}}}}});
  }
  // Add annotation text above chart
  const parent=cv.parentElement;
  let ann=parent.querySelector('.dist-ann');
  if(!ann){ann=document.createElement('div');ann.className='dist-ann';
    ann.style.cssText='position:absolute;top:8px;right:12px;background:rgba(10,24,40,.9);border:1px solid var(--accent);border-radius:6px;padding:.4rem .7rem;font-size:.78rem;color:var(--accent);font-weight:700;z-index:5';
    parent.appendChild(ann)}
  ann.textContent=`${pct}%ã®é‡ã¿ãŒÂ±0.04ã«é›†ä¸­`;
}

// Section C-right: Robustness â€” Canvas NN diagram + result bars
function doWhyRobust(){
  // 2â†’4â†’1 NN with weights large enough for non-trivial ReLU output
  const NH=4;
  const W1=[];for(let j=0;j<NH;j++){W1[j]=[];for(let i=0;i<2;i++)W1[j].push((Math.random()-0.5)*2)}
  const W2=[];for(let j=0;j<NH;j++)W2.push((Math.random()*0.8+0.1)*(Math.random()<0.5?-1:1));
  // Ensure at least 2 hidden nodes have positive pre-activation
  const input=[0.7,0.5];
  function fwd(w1,w2,inp){
    const h=[];for(let j=0;j<NH;j++){let s=0;for(let i=0;i<2;i++)s+=w1[j][i]*inp[i];h.push(Math.max(0,s))}
    let o=0;for(let j=0;j<NH;j++)o+=w2[j]*h[j];return{h,o}}
  function qW(w1,w2,bits){
    const all=[...w1.flat(),...w2],am=Math.max(...all.map(Math.abs))||1e-10;
    return{w1:w1.map(r=>r.map(v=>symQ(v,am,bits).d)),w2:w2.map(v=>symQ(v,am,bits).d)}}

  const fp32=fwd(W1,W2,input);
  const precs=[{l:'FP32',b:32,c:'#4da6ff'},{l:'FP16',b:16,c:'#44cc66'},{l:'INT8',b:8,c:'#ffaa33'},{l:'INT4',b:4,c:'#b388ff'}];
  precs.forEach(p=>{if(p.b===32){p.r=fp32;return}const q=qW(W1,W2,p.b);p.r=fwd(q.w1,q.w2,input)});

  // Draw NN diagram
  const cv=document.getElementById('robustNNCv'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  const layers=[{n:2,x:W*0.12,lbl:'å…¥åŠ›'},{n:NH,x:W*0.5,lbl:'éš ã‚Œå±¤(ReLU)'},{n:1,x:W*0.88,lbl:'å‡ºåŠ›'}];
  const nodeR=14;
  const nodes=layers.map(l=>{const pos=[];const gap=Math.min(40,(H-40)/(l.n+1));
    const sy=H/2-(l.n-1)*gap/2;for(let i=0;i<l.n;i++)pos.push({x:l.x,y:sy+i*gap});return pos});
  // Edges
  ctx.lineWidth=1;
  for(let j=0;j<NH;j++){for(let i=0;i<2;i++){
    const w=W1[j][i];ctx.strokeStyle=w>=0?'rgba(68,204,102,.3)':'rgba(255,85,85,.3)';
    ctx.beginPath();ctx.moveTo(nodes[0][i].x+nodeR,nodes[0][i].y);ctx.lineTo(nodes[1][j].x-nodeR,nodes[1][j].y);ctx.stroke()}}
  for(let j=0;j<NH;j++){
    const w=W2[j];ctx.strokeStyle=w>=0?'rgba(68,204,102,.3)':'rgba(255,85,85,.3)';
    ctx.beginPath();ctx.moveTo(nodes[1][j].x+nodeR,nodes[1][j].y);ctx.lineTo(nodes[2][0].x-nodeR,nodes[2][0].y);ctx.stroke()}
  // Nodes
  const vals=[[input[0],input[1]],fp32.h,[fp32.o]];
  const ncols=['#4da6ff','#44cc66','#ffaa33'];
  nodes.forEach((layer,li)=>{layer.forEach((nd,ni)=>{
    ctx.fillStyle=ncols[li];ctx.beginPath();ctx.arc(nd.x,nd.y,nodeR,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 9px monospace';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(vals[li][ni].toFixed(2),nd.x,nd.y)})});
  // Labels
  ctx.fillStyle='#7888a0';ctx.font='10px sans-serif';ctx.textBaseline='top';
  layers.forEach(l=>{ctx.textAlign='center';ctx.fillText(l.lbl,l.x,H-14)});

  // Result bars
  const maxOut=Math.max(...precs.map(p=>Math.abs(p.r.o)))||1;
  const maxDiff=Math.max(...precs.map(p=>Math.abs(p.r.o-fp32.o)),0.0001);
  let html='<div style="display:grid;grid-template-columns:70px 1fr 100px 80px;gap:4px 8px;font-size:.82rem;align-items:center">';
  html+='<div style="color:#7888a0;font-weight:700">ç²¾åº¦</div><div style="color:#7888a0;font-weight:700">å‡ºåŠ›å€¤</div><div style="color:#7888a0;font-weight:700">FP32ã¨ã®å·®</div><div style="color:#7888a0;font-weight:700">åˆ¤å®š</div>';
  precs.forEach(p=>{
    const diff=Math.abs(p.r.o-fp32.o);
    const ratio=diff/maxDiff;
    const barW=Math.max(Math.abs(p.r.o)/maxOut*100,2);
    const barCol=p.b===32?p.c:ratio<0.1?'#44cc66':ratio<0.5?'#ffaa33':'#ff5555';
    const verdict=p.b===32?'åŸºæº–':diff<0.001?'åŒç­‰':diff<0.01?'å¾®å·®':'ä¹–é›¢';
    const verdictCol=p.b===32?'#4da6ff':diff<0.001?'#44cc66':diff<0.01?'#ffaa33':'#ff5555';
    html+=`<div style="font-weight:700;color:${p.c}">${p.l}</div>`;
    html+=`<div style="display:flex;align-items:center;gap:6px"><div style="height:16px;width:${barW}%;background:${barCol};border-radius:3px;min-width:4px"></div><span style="font-family:monospace;font-size:.8rem">${p.r.o.toFixed(6)}</span></div>`;
    html+=`<div style="font-family:monospace;font-size:.8rem">${diff.toFixed(6)}</div>`;
    html+=`<div style="color:${verdictCol};font-weight:700">${verdict}</div>`;
  });
  html+='</div>';
  document.getElementById('robustResults').innerHTML=html;
}

// === Tab4: Deep Analysis ===

// Section A: Outlier impact
let outWeights=null;
function initOutWeights(){outWeights=genW(63,0,0.5)}
function doOutlier(){
  const mag=+document.getElementById('outMag').value,b=+document.getElementById('outBits').value;
  document.getElementById('outMagV').textContent=mag;
  if(!outWeights)initOutWeights();
  const w=[...outWeights,mag]; // 63 normal + 1 outlier
  const am=Math.max(...w.map(Math.abs))||1e-10;
  const qmax=(1<<(b-1))-1,sc=am/qmax;
  const cv=document.getElementById('outCanvas'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d'),mL=60,mR=30,mT=30,mB=50;
  const pW=W-mL-mR;
  const range=Math.max(am*1.1,2);
  const xP=v=>mL+(v+range)/(2*range)*pW;
  ctx.clearRect(0,0,W,H);
  const Y=H*0.45;
  // Axis
  ctx.strokeStyle='#2a3040';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(mL,Y);ctx.lineTo(W-mR,Y);ctx.stroke();
  // Grid lines
  ctx.strokeStyle='rgba(179,136,255,.15)';ctx.lineWidth=1;
  for(let q=-qmax;q<=qmax;q++){const lv=q*sc;if(Math.abs(lv)<=range){const px=xP(lv);
    ctx.beginPath();ctx.moveTo(px,Y-25);ctx.lineTo(px,Y+25);ctx.stroke()}}
  // Label grid
  ctx.fillStyle='#556070';ctx.font='9px sans-serif';ctx.textAlign='center';
  ctx.fillText(`ã‚°ãƒªãƒƒãƒ‰æ•°: ${2*qmax+1}`,W/2,Y+42);
  ctx.fillText(`scale: ${sc.toFixed(4)}`,W/2,mT-5);
  // Plot dots
  let totalErr=0,maxErr=0,normalErr=0;
  w.forEach((v,i)=>{const qr=symQ(v,am,b),err=qr.e;totalErr+=err;if(err>maxErr)maxErr=err;
    if(i<63)normalErr+=err;
    const px=xP(v),errNorm=maxErr>0?err/Math.max(maxErr,0.001):0;
    const r=Math.round(55+200*errNorm),g=Math.round(200-180*errNorm),bv=Math.round(55);
    ctx.fillStyle=`rgb(${r},${g},${bv})`;
    if(i===63&&mag>0){ctx.beginPath();ctx.arc(px,Y,8,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ff5555';ctx.font='10px sans-serif';ctx.fillText('å¤–ã‚Œå€¤',px,Y-14)}
    else{ctx.beginPath();ctx.arc(px,Y,4,0,Math.PI*2);ctx.fill()}
  });
  // Stats
  const avgNormal=normalErr/63,avgAll=totalErr/64;
  document.getElementById('outStats').innerHTML=
    `<div class="stat">æ­£å¸¸å€¤ã®å¹³å‡èª¤å·®: <strong>${avgNormal.toFixed(5)}</strong></div>`+
    `<div class="stat">å…¨ä½“ã®å¹³å‡èª¤å·®: <strong>${avgAll.toFixed(5)}</strong></div>`+
    `<div class="stat">scale: <strong>${sc.toFixed(5)}</strong></div>`+
    `<div class="stat" style="color:${mag>5?'var(--red)':'var(--green)'}">${mag>5?'âš  å¤–ã‚Œå€¤ãŒã‚°ãƒªãƒƒãƒ‰ã‚’å¼•ãä¼¸ã°ã—ä¸­':'âœ“ æ­£å¸¸ç¯„å›²'}</div>`;
}
document.getElementById('outMag').addEventListener('input',doOutlier);
document.getElementById('outBits').addEventListener('change',doOutlier);

// Section B: Perplexity curve
let pplCh=null;
function doPPL(){
  const bits=[2,3,4,5,6,8,10,12,16,24,32];
  // Simulated perplexity multiplier relative to FP16 baseline
  const data7B= [2.8,1.45,1.05,1.02,1.01,1.005,1.002,1.001,1.0,1.0,1.0];
  const data13B=[2.2,1.30,1.03,1.015,1.008,1.003,1.001,1.0005,1.0,1.0,1.0];
  const data70B=[1.8,1.18,1.02,1.01,1.005,1.002,1.001,1.0003,1.0,1.0,1.0];
  const cv=document.getElementById('pplCv');
  if(typeof Chart!=='undefined'){
    if(pplCh)pplCh.destroy();
    pplCh=new Chart(cv,{type:'line',data:{labels:bits.map(b=>b+'bit'),datasets:[
      {label:'7B',data:data7B,borderColor:'#ff5555',backgroundColor:'rgba(255,85,85,.1)',tension:.3,pointRadius:4,pointHoverRadius:7,fill:false},
      {label:'13B',data:data13B,borderColor:'#ffaa33',backgroundColor:'rgba(255,170,51,.1)',tension:.3,pointRadius:4,pointHoverRadius:7,fill:false},
      {label:'70B',data:data70B,borderColor:'#44cc66',backgroundColor:'rgba(68,204,102,.1)',tension:.3,pointRadius:4,pointHoverRadius:7,fill:false}
    ]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:300},
      plugins:{legend:{labels:{color:'#b8c0d0',font:{size:12}}},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: PPL Ã—${ctx.raw.toFixed(3)}`}}},
      scales:{x:{ticks:{color:'#7888a0',font:{size:10}},grid:{color:'#1a2030'},
        title:{display:true,text:'ãƒ“ãƒƒãƒˆæ•°',color:'#7888a0',font:{size:11}}},
        y:{ticks:{color:'#7888a0',font:{size:10},callback:v=>'Ã—'+v.toFixed(2)},grid:{color:'#1a2030'},
        title:{display:true,text:'Perplexityå€ç‡ (FP16åŸºæº–)',color:'#7888a0',font:{size:11}},
        min:0.95}}}});
    // Draw sweet spot annotation
    const meta=pplCh.getDatasetMeta(0);
    if(meta.data.length>2){
      const plugin={id:'sweetspot',afterDraw(chart){
        const ctx2=chart.ctx,xAxis=chart.scales.x,yAxis=chart.scales.y;
        const x1=xAxis.getPixelForValue(2),x2=xAxis.getPixelForValue(4); // 4bit-8bit
        const y1=yAxis.top,y2=yAxis.bottom;
        ctx2.save();ctx2.fillStyle='rgba(68,204,102,.06)';ctx2.fillRect(x1,y1,x2-x1,y2-y1);
        ctx2.fillStyle='rgba(68,204,102,.5)';ctx2.font='bold 11px sans-serif';ctx2.textAlign='center';
        ctx2.fillText('ã‚¹ã‚¤ãƒ¼ãƒˆã‚¹ãƒãƒƒãƒˆ',(x1+x2)/2,y1+16);ctx2.restore()}};
      pplCh.config.plugins=[plugin];pplCh.update()
    }
  }
}

// Section C: NN Walkthrough
function doNNWalk(){
  // Generate random weights
  const W1=[[],[],[]],W2=[];
  for(let j=0;j<3;j++){W1[j]=[];for(let i=0;i<2;i++)W1[j].push((Math.random()-0.5)*2);W2.push((Math.random()-0.5)*2)}
  const input=[0.6,-0.4];
  function fwd(w1,w2,inp){
    const h=[];for(let j=0;j<3;j++){let s=0;for(let i=0;i<2;i++)s+=w1[j][i]*inp[i];h.push(Math.max(0,s))}
    let o=0;for(let j=0;j<3;j++)o+=w2[j]*h[j];return{hidden:h,out:o}}
  function qWeights(w1,w2,bits){
    const all=[...w1.flat(),...w2],am=Math.max(...all.map(Math.abs))||1e-10;
    return{w1:w1.map(row=>row.map(v=>symQ(v,am,bits).d)),w2:w2.map(v=>symQ(v,am,bits).d)}}

  const fp32=fwd(W1,W2,input);
  const precisions=[{label:'FP32',bits:32,w1:W1,w2:W2},{label:'FP16',bits:16},{label:'INT8',bits:8},{label:'INT4',bits:4}];
  precisions.forEach(p=>{if(p.bits===32){p.result=fp32;return}
    const q=qWeights(W1,W2,p.bits);p.w1=q.w1;p.w2=q.w2;p.result=fwd(q.w1,q.w2,input)});

  // Draw network diagram
  const cv=document.getElementById('nnCanvas'),W=cv.parentElement.clientWidth;cv.width=W;
  const H=cv.height,ctx=cv.getContext('2d');
  const layers=[{n:2,x:W*0.15,label:'å…¥åŠ›'},{n:3,x:W*0.5,label:'éš ã‚Œå±¤'},{n:1,x:W*0.85,label:'å‡ºåŠ›'}];
  const nodeR=18;
  ctx.clearRect(0,0,W,H);
  // Calc node positions
  const nodes=layers.map(l=>{const pos=[];const gap=Math.min(70,H/(l.n+1));
    const startY=H/2-(l.n-1)*gap/2;
    for(let i=0;i<l.n;i++)pos.push({x:l.x,y:startY+i*gap});return pos});
  // Draw edges with FP32 weights
  ctx.lineWidth=1.5;
  for(let j=0;j<3;j++){for(let i=0;i<2;i++){
    const w=W1[j][i];ctx.strokeStyle=w>=0?'rgba(68,204,102,.4)':'rgba(255,85,85,.4)';
    ctx.beginPath();ctx.moveTo(nodes[0][i].x+nodeR,nodes[0][i].y);
    ctx.lineTo(nodes[1][j].x-nodeR,nodes[1][j].y);ctx.stroke();
    const mx=(nodes[0][i].x+nodes[1][j].x)/2,my=(nodes[0][i].y+nodes[1][j].y)/2;
    ctx.fillStyle='#7888a0';ctx.font='9px monospace';ctx.textAlign='center';ctx.fillText(w.toFixed(2),mx,my-4)}}
  for(let j=0;j<3;j++){
    const w=W2[j];ctx.strokeStyle=w>=0?'rgba(68,204,102,.4)':'rgba(255,85,85,.4)';
    ctx.beginPath();ctx.moveTo(nodes[1][j].x+nodeR,nodes[1][j].y);
    ctx.lineTo(nodes[2][0].x-nodeR,nodes[2][0].y);ctx.stroke();
    const mx=(nodes[1][j].x+nodes[2][0].x)/2,my=(nodes[1][j].y+nodes[2][0].y)/2;
    ctx.fillStyle='#7888a0';ctx.font='9px monospace';ctx.textAlign='center';ctx.fillText(w.toFixed(2),mx,my-4)}
  // Draw nodes
  const nodeVals=[[input[0],input[1]],[fp32.hidden[0],fp32.hidden[1],fp32.hidden[2]],[fp32.out]];
  nodes.forEach((layer,li)=>{layer.forEach((nd,ni)=>{
    ctx.fillStyle=li===0?'#4da6ff':li===1?'#44cc66':'#ffaa33';
    ctx.beginPath();ctx.arc(nd.x,nd.y,nodeR,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.font='bold 10px monospace';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(nodeVals[li][ni].toFixed(2),nd.x,nd.y)})});
  // Layer labels
  ctx.fillStyle='#7888a0';ctx.font='11px sans-serif';ctx.textBaseline='top';
  layers.forEach((l,i)=>{ctx.textAlign='center';ctx.fillText(l.label,l.x,H-20)});

  // Output lanes
  const maxDiff=Math.max(...precisions.map(p=>Math.abs(p.result.out-fp32.out)),0.001);
  document.getElementById('nnLanes').innerHTML=precisions.map(p=>{
    const diff=Math.abs(p.result.out-fp32.out);
    const ratio=diff/maxDiff;
    const color=p.bits===32?'var(--accent)':ratio<0.1?'var(--green)':ratio<0.5?'var(--orange)':'var(--red)';
    return`<div class="nn-lane" style="border-top:3px solid ${color}">
      <div class="lane-label">${p.label}</div>
      <div class="lane-val" style="color:${color}">${p.result.out.toFixed(6)}</div>
      <div style="font-size:.75rem;color:var(--text-muted);margin-top:.3rem">å·®: ${diff.toFixed(6)}</div></div>`}).join('');
}

// === Init ===
function init(){
  doBits();doHist();doErrScatter();doSnapViz();doVecQuant();doTradeoff();doSym();doAsym();doBlock();doCT();doMC();doURI();doUEL();
  handleHash()}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
